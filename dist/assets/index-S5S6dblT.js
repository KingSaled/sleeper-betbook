(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function n(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=n(s);fetch(s.href,i)}})();function U(t){if(typeof t=="number")return(Math.abs(t*2654435761)>>>0).toString(16);if(typeof t=="boolean")return t?"1":"0";if(t===null)return"null";if(t===void 0)return"undefined";if(typeof t=="string"){let e=2166136261;for(let n=0;n<t.length;n++)e^=t.charCodeAt(n),e+=(e<<1)+(e<<4)+(e<<7)+(e<<8)+(e<<24),e=e>>>0;return e.toString(16)}if(Array.isArray(t)){let e=2166136261;for(let n=0;n<t.length;n++){e^=(n+1)*2654435761;const r=U(t[n]);for(let s=0;s<r.length;s++)e^=r.charCodeAt(s),e*=16777619,e=e>>>0}return e.toString(16)}if(typeof t=="object"){let e=2166136261;const n=Object.keys(t).sort();for(let r=0;r<n.length;r++){const s=n[r],i=U(s);e^=parseInt(i,16),e*=16777619,e=e>>>0;const o=U(t[s]);e^=parseInt(o,16),e*=16777619,e=e>>>0}return e.toString(16)}return U(String(t))}const j={Remove:"remove",Replace:"replace",Add:"add"},Kn=Symbol.for("__MUTATIVE_PROXY_DRAFT__"),Ur=Symbol("__MUTATIVE_RAW_RETURN_SYMBOL__"),He=Symbol.iterator,W={mutable:"mutable",immutable:"immutable"},Ft={};function xe(t,e){return t instanceof Map?t.has(e):Object.prototype.hasOwnProperty.call(t,e)}function en(t,e){if(e in t){let n=Reflect.getPrototypeOf(t);for(;n;){const r=Reflect.getOwnPropertyDescriptor(n,e);if(r)return r;n=Reflect.getPrototypeOf(n)}}}function qt(t){return Object.getPrototypeOf(t)===Set.prototype}function Kt(t){return Object.getPrototypeOf(t)===Map.prototype}function z(t){var e;return(e=t.copy)!==null&&e!==void 0?e:t.original}function ae(t){return!!S(t)}function S(t){return typeof t!="object"?null:t==null?void 0:t[Kn]}function Bt(t){var e;const n=S(t);return n?(e=n.copy)!==null&&e!==void 0?e:n.original:t}function J(t,e){if(!t||typeof t!="object")return!1;let n;return Object.getPrototypeOf(t)===Object.prototype||Array.isArray(t)||t instanceof Map||t instanceof Set||!!(e!=null&&e.mark)&&((n=e.mark(t,W))===W.immutable||typeof n=="function")}function Bn(t,e=[]){if(Object.hasOwnProperty.call(t,"key")){const n=t.parent.copy,r=S(oe(n,t.key));if(r!==null&&(r==null?void 0:r.original)!==t.original)return null;const s=t.parent.type===3,i=s?Array.from(t.parent.setMap.keys()).indexOf(t.key):t.key;if(!(s&&n.size>i||xe(n,i)))return null;e.push(i)}if(t.parent)return Bn(t.parent,e);e.reverse();try{Nr(t.copy,e)}catch{return null}return e}function ye(t){return Array.isArray(t)?1:t instanceof Map?2:t instanceof Set?3:0}function oe(t,e){return ye(t)===2?t.get(e):t[e]}function Ne(t,e,n){ye(t)===2?t.set(e,n):t[e]=n}function ut(t,e){const n=S(t);return(n?z(n):t)[e]}function ie(t,e){return t===e?t!==0||1/t===1/e:t!==t&&e!==e}function gt(t){if(t)for(;t.finalities.revoke.length>0;)t.finalities.revoke.pop()()}function de(t,e){return e?t:[""].concat(t).map(n=>{const r=`${n}`;return r.indexOf("/")===-1&&r.indexOf("~")===-1?r:r.replace(/~/g,"~0").replace(/\//g,"~1")}).join("/")}function Nr(t,e){for(let n=0;n<e.length-1;n+=1){const r=e[n];if(t=oe(ye(t)===3?Array.from(t):t,r),typeof t!="object")throw new Error(`Cannot resolve patch at '${e.join("/")}'.`)}return t}function Fr(t){const e=Object.create(Object.getPrototypeOf(t));return Reflect.ownKeys(t).forEach(n=>{let r=Reflect.getOwnPropertyDescriptor(t,n);if(r.enumerable&&r.configurable&&r.writable){e[n]=t[n];return}r.writable||(r.writable=!0,r.configurable=!0),(r.get||r.set)&&(r={configurable:!0,writable:!0,enumerable:r.enumerable,value:t[n]}),Reflect.defineProperty(e,n,r)}),e}const qr=Object.prototype.propertyIsEnumerable;function zn(t,e){let n;if(Array.isArray(t))return Array.prototype.concat.call(t);if(t instanceof Set){if(!qt(t)){const r=Object.getPrototypeOf(t).constructor;return new r(t.values())}return Set.prototype.difference?Set.prototype.difference.call(t,new Set):new Set(t.values())}else if(t instanceof Map){if(!Kt(t)){const r=Object.getPrototypeOf(t).constructor;return new r(t)}return new Map(t)}else if(e!=null&&e.mark&&(n=e.mark(t,W),n!==void 0)&&n!==W.mutable){if(n===W.immutable)return Fr(t);if(typeof n=="function"){if(e.enablePatches||e.enableAutoFreeze)throw new Error("You can't use mark and patches or auto freeze together.");return n()}throw new Error(`Unsupported mark result: ${n}`)}else if(typeof t=="object"&&Object.getPrototypeOf(t)===Object.prototype){const r={};return Object.keys(t).forEach(s=>{r[s]=t[s]}),Object.getOwnPropertySymbols(t).forEach(s=>{qr.call(t,s)&&(r[s]=t[s])}),r}else throw new Error("Please check mark() to ensure that it is a stable marker draftable function.")}function N(t){t.copy||(t.copy=zn(t.original,t.options))}function Me(t){if(!J(t))return Bt(t);if(Array.isArray(t))return t.map(Me);if(t instanceof Map){const n=Array.from(t.entries()).map(([r,s])=>[r,Me(s)]);if(!Kt(t)){const r=Object.getPrototypeOf(t).constructor;return new r(n)}return new Map(n)}if(t instanceof Set){const n=Array.from(t).map(Me);if(!qt(t)){const r=Object.getPrototypeOf(t).constructor;return new r(n)}return new Set(n)}const e=Object.create(Object.getPrototypeOf(t));for(const n in t)e[n]=Me(t[n]);return e}function Qe(t){return ae(t)?Me(t):t}function X(t){var e;t.assignedMap=(e=t.assignedMap)!==null&&e!==void 0?e:new Map,t.operated||(t.operated=!0,t.parent&&X(t.parent))}function tn(){throw new Error("Cannot modify frozen object")}function be(t,e,n,r,s){{n=n??new WeakMap,r=r??[],s=s??[];const o=n.has(t)?n.get(t):t;if(r.length>0){const a=r.indexOf(o);if(o&&typeof o=="object"&&a!==-1)throw r[0]===o?new Error("Forbids circular reference"):new Error(`Forbids circular reference: ~/${s.slice(0,a).map((c,l)=>{if(typeof c=="symbol")return`[${c.toString()}]`;const u=r[l];return typeof c=="object"&&(u instanceof Map||u instanceof Set)?Array.from(u.keys()).indexOf(c):c}).join("/")}`);r.push(o),s.push(e)}else r.push(o)}if(Object.isFrozen(t)||ae(t)){r.pop(),s.pop();return}switch(ye(t)){case 2:for(const[a,c]of t)be(a,a,n,r,s),be(c,a,n,r,s);t.set=t.clear=t.delete=tn;break;case 3:for(const a of t)be(a,a,n,r,s);t.add=t.clear=t.delete=tn;break;case 1:Object.freeze(t);let o=0;for(const a of t)be(a,o,n,r,s),o+=1;break;default:Object.freeze(t),Object.keys(t).forEach(a=>{const c=t[a];be(c,a,n,r,s)})}r.pop(),s.pop()}function zt(t,e){const n=ye(t);if(n===0)Reflect.ownKeys(t).forEach(r=>{e(r,t[r],t)});else if(n===1){let r=0;for(const s of t)e(r,s,t),r+=1}else t.forEach((r,s)=>e(s,r,t))}function Wn(t,e,n){if(ae(t)||!J(t,n)||e.has(t)||Object.isFrozen(t))return;const r=t instanceof Set,s=r?new Map:void 0;if(e.add(t),zt(t,(i,o)=>{var a;if(ae(o)){const c=S(o);N(c);const l=!((a=c.assignedMap)===null||a===void 0)&&a.size||c.operated?c.copy:c.original;Ne(r?s:t,i,l)}else Wn(o,e,n)}),s){const i=t,o=Array.from(i);i.clear(),o.forEach(a=>{i.add(s.has(a)?s.get(a):a)})}}function Kr(t,e){const n=t.type===3?t.setMap:t.copy;t.finalities.revoke.length>1&&t.assignedMap.get(e)&&n&&Wn(oe(n,e),t.finalities.handledSet,t.options)}function wt(t){t.type===3&&t.copy&&(t.copy.clear(),t.setMap.forEach(e=>{t.copy.add(Bt(e))}))}function Tt(t,e,n,r){if(t.operated&&t.assignedMap&&t.assignedMap.size>0&&!t.finalized){if(n&&r){const i=Bn(t);i&&e(t,i,n,r)}t.finalized=!0}}function Wt(t,e,n,r){const s=S(n);s&&(s.callbacks||(s.callbacks=[]),s.callbacks.push((i,o)=>{var a;const c=t.type===3?t.setMap:t.copy;if(ie(oe(c,e),n)){let l=s.original;s.copy&&(l=s.copy),wt(t),Tt(t,r,i,o),t.options.enableAutoFreeze&&(t.options.updatedValues=(a=t.options.updatedValues)!==null&&a!==void 0?a:new WeakMap,t.options.updatedValues.set(l,s.original)),Ne(c,e,l)}}),t.options.enableAutoFreeze&&s.finalities!==t.finalities&&(t.options.enableAutoFreeze=!1)),J(n,t.options)&&t.finalities.draft.push(()=>{const i=t.type===3?t.setMap:t.copy;ie(oe(i,e),n)&&Kr(t,e)})}function Br(t,e,n,r,s){let{original:i,assignedMap:o,options:a}=t,c=t.copy;c.length<i.length&&([i,c]=[c,i],[n,r]=[r,n]);for(let l=0;l<i.length;l+=1)if(o.get(l.toString())&&c[l]!==i[l]){const u=e.concat([l]),d=de(u,s);n.push({op:j.Replace,path:d,value:Qe(c[l])}),r.push({op:j.Replace,path:d,value:Qe(i[l])})}for(let l=i.length;l<c.length;l+=1){const u=e.concat([l]),d=de(u,s);n.push({op:j.Add,path:d,value:Qe(c[l])})}if(i.length<c.length){const{arrayLengthAssignment:l=!0}=a.enablePatches;if(l){const u=e.concat(["length"]),d=de(u,s);r.push({op:j.Replace,path:d,value:i.length})}else for(let u=c.length;i.length<u;u-=1){const d=e.concat([u-1]),f=de(d,s);r.push({op:j.Remove,path:f})}}}function zr({original:t,copy:e,assignedMap:n},r,s,i,o){n.forEach((a,c)=>{const l=oe(t,c),u=Qe(oe(e,c)),d=a?xe(t,c)?j.Replace:j.Add:j.Remove;if(ie(l,u)&&d===j.Replace)return;const f=r.concat(c),p=de(f,o);s.push(d===j.Remove?{op:d,path:p}:{op:d,path:p,value:u}),i.push(d===j.Add?{op:j.Remove,path:p}:d===j.Remove?{op:j.Add,path:p,value:l}:{op:j.Replace,path:p,value:l})})}function Wr({original:t,copy:e},n,r,s,i){let o=0;t.forEach(a=>{if(!e.has(a)){const c=n.concat([o]),l=de(c,i);r.push({op:j.Remove,path:l,value:a}),s.unshift({op:j.Add,path:l,value:a})}o+=1}),o=0,e.forEach(a=>{if(!t.has(a)){const c=n.concat([o]),l=de(c,i);r.push({op:j.Add,path:l,value:a}),s.unshift({op:j.Remove,path:l,value:a})}o+=1})}function Le(t,e,n,r){const{pathAsArray:s=!0}=t.options.enablePatches;switch(t.type){case 0:case 2:return zr(t,e,n,r,s);case 1:return Br(t,e,n,r,s);case 3:return Wr(t,e,n,r,s)}}const Ze=(t,e,n=!1)=>{if(typeof t=="object"&&t!==null&&(!J(t,e)||n))throw new Error("Strict mode: Mutable data cannot be accessed directly, please use 'unsafe(callback)' wrap.")},St={get size(){return z(S(this)).size},has(t){return z(S(this)).has(t)},set(t,e){const n=S(this),r=z(n);return(!r.has(t)||!ie(r.get(t),e))&&(N(n),X(n),n.assignedMap.set(t,!0),n.copy.set(t,e),Wt(n,t,e,Le)),this},delete(t){if(!this.has(t))return!1;const e=S(this);return N(e),X(e),e.original.has(t)?e.assignedMap.set(t,!1):e.assignedMap.delete(t),e.copy.delete(t),!0},clear(){const t=S(this);if(this.size){N(t),X(t),t.assignedMap=new Map;for(const[e]of t.original)t.assignedMap.set(e,!1);t.copy.clear()}},forEach(t,e){const n=S(this);z(n).forEach((r,s)=>{t.call(e,this.get(s),s,this)})},get(t){var e,n;const r=S(this),s=z(r).get(t),i=((n=(e=r.options).mark)===null||n===void 0?void 0:n.call(e,s,W))===W.mutable;if(r.options.strict&&Ze(s,r.options,i),i||r.finalized||!J(s,r.options)||s!==r.original.get(t))return s;const o=Ft.createDraft({original:s,parentDraft:r,key:t,finalities:r.finalities,options:r.options});return N(r),r.copy.set(t,o),o},keys(){return z(S(this)).keys()},values(){const t=this.keys();return{[He]:()=>this.values(),next:()=>{const e=t.next();return e.done?e:{done:!1,value:this.get(e.value)}}}},entries(){const t=this.keys();return{[He]:()=>this.entries(),next:()=>{const e=t.next();if(e.done)return e;const n=this.get(e.value);return{done:!1,value:[e.value,n]}}}},[He](){return this.entries()}},Vr=Reflect.ownKeys(St),nn=(t,e,{isValuesIterator:n})=>()=>{var r,s;const i=e.next();if(i.done)return i;const o=i.value;let a=t.setMap.get(o);const c=S(a),l=((s=(r=t.options).mark)===null||s===void 0?void 0:s.call(r,a,W))===W.mutable;if(t.options.strict&&Ze(o,t.options,l),!l&&!c&&J(o,t.options)&&!t.finalized&&t.original.has(o)){const u=Ft.createDraft({original:o,parentDraft:t,key:o,finalities:t.finalities,options:t.options});t.setMap.set(o,u),a=u}else c&&(a=c.proxy);return{done:!1,value:n?a:[a,a]}},Xe={get size(){return S(this).setMap.size},has(t){const e=S(this);if(e.setMap.has(t))return!0;N(e);const n=S(t);return!!(n&&e.setMap.has(n.original))},add(t){const e=S(this);return this.has(t)||(N(e),X(e),e.assignedMap.set(t,!0),e.setMap.set(t,t),Wt(e,t,t,Le)),this},delete(t){if(!this.has(t))return!1;const e=S(this);N(e),X(e);const n=S(t);return n&&e.setMap.has(n.original)?(e.assignedMap.set(n.original,!1),e.setMap.delete(n.original)):(!n&&e.setMap.has(t)?e.assignedMap.set(t,!1):e.assignedMap.delete(t),e.setMap.delete(t))},clear(){if(!this.size)return;const t=S(this);N(t),X(t);for(const e of t.original)t.assignedMap.set(e,!1);t.setMap.clear()},values(){const t=S(this);N(t);const e=t.setMap.keys();return{[Symbol.iterator]:()=>this.values(),next:nn(t,e,{isValuesIterator:!0})}},entries(){const t=S(this);N(t);const e=t.setMap.keys();return{[Symbol.iterator]:()=>this.entries(),next:nn(t,e,{isValuesIterator:!1})}},keys(){return this.values()},[He](){return this.values()},forEach(t,e){const n=this.values();let r=n.next();for(;!r.done;)t.call(e,r.value,r.value,this),r=n.next()}};Set.prototype.difference&&Object.assign(Xe,{intersection(t){return Set.prototype.intersection.call(new Set(this.values()),t)},union(t){return Set.prototype.union.call(new Set(this.values()),t)},difference(t){return Set.prototype.difference.call(new Set(this.values()),t)},symmetricDifference(t){return Set.prototype.symmetricDifference.call(new Set(this.values()),t)},isSubsetOf(t){return Set.prototype.isSubsetOf.call(new Set(this.values()),t)},isSupersetOf(t){return Set.prototype.isSupersetOf.call(new Set(this.values()),t)},isDisjointFrom(t){return Set.prototype.isDisjointFrom.call(new Set(this.values()),t)}});const Hr=Reflect.ownKeys(Xe),Vn={get(t,e,n){var r,s;const i=(r=t.copy)===null||r===void 0?void 0:r[e];if(i&&t.finalities.draftsCache.has(i))return i;if(e===Kn)return t;let o;if(t.options.mark){const l=e==="size"&&(t.original instanceof Map||t.original instanceof Set)?Reflect.get(t.original,e):Reflect.get(t.original,e,n);if(o=t.options.mark(l,W),o===W.mutable)return t.options.strict&&Ze(l,t.options,!0),l}const a=z(t);if(a instanceof Map&&Vr.includes(e))return e==="size"?Object.getOwnPropertyDescriptor(St,"size").get.call(t.proxy):St[e].bind(t.proxy);if(a instanceof Set&&Hr.includes(e))return e==="size"?Object.getOwnPropertyDescriptor(Xe,"size").get.call(t.proxy):Xe[e].bind(t.proxy);if(!xe(a,e)){const l=en(a,e);return l?"value"in l?l.value:(s=l.get)===null||s===void 0?void 0:s.call(t.proxy):void 0}const c=a[e];if(t.options.strict&&Ze(c,t.options),t.finalized||!J(c,t.options))return c;if(c===ut(t.original,e)){if(N(t),t.copy[e]=Vt({original:t.original[e],parentDraft:t,key:t.type===1?Number(e):e,finalities:t.finalities,options:t.options}),typeof o=="function"){const l=S(t.copy[e]);return N(l),X(l),l.copy}return t.copy[e]}return ae(c)&&t.finalities.draftsCache.add(c),c},set(t,e,n){var r;if(t.type===3||t.type===2)throw new Error("Map/Set draft does not support any property assignment.");let s;if(t.type===1&&e!=="length"&&!(Number.isInteger(s=Number(e))&&s>=0&&(e===0||s===0||String(s)===String(e))))throw new Error("Only supports setting array indices and the 'length' property.");const i=en(z(t),e);if(i!=null&&i.set)return i.set.call(t.proxy,n),!0;const o=ut(z(t),e),a=S(o);return a&&ie(a.original,n)?(t.copy[e]=n,t.assignedMap=(r=t.assignedMap)!==null&&r!==void 0?r:new Map,t.assignedMap.set(e,!1),!0):(ie(n,o)&&(n!==void 0||xe(t.original,e))||(N(t),X(t),xe(t.original,e)&&ie(n,t.original[e])?t.assignedMap.delete(e):t.assignedMap.set(e,!0),t.copy[e]=n,Wt(t,e,n,Le)),!0)},has(t,e){return e in z(t)},ownKeys(t){return Reflect.ownKeys(z(t))},getOwnPropertyDescriptor(t,e){const n=z(t),r=Reflect.getOwnPropertyDescriptor(n,e);return r&&{writable:!0,configurable:t.type!==1||e!=="length",enumerable:r.enumerable,value:n[e]}},getPrototypeOf(t){return Reflect.getPrototypeOf(t.original)},setPrototypeOf(){throw new Error("Cannot call 'setPrototypeOf()' on drafts")},defineProperty(){throw new Error("Cannot call 'defineProperty()' on drafts")},deleteProperty(t,e){var n;return t.type===1?Vn.set.call(this,t,e,void 0,t.proxy):(ut(t.original,e)!==void 0||e in t.original?(N(t),X(t),t.assignedMap.set(e,!1)):(t.assignedMap=(n=t.assignedMap)!==null&&n!==void 0?n:new Map,t.assignedMap.delete(e)),t.copy&&delete t.copy[e],!0)}};function Vt(t){const{original:e,parentDraft:n,key:r,finalities:s,options:i}=t,o=ye(e),a={type:o,finalized:!1,parent:n,original:e,copy:null,proxy:null,finalities:s,options:i,setMap:o===3?new Map(e.entries()):void 0};(r||"key"in t)&&(a.key=r);const{proxy:c,revoke:l}=Proxy.revocable(o===1?Object.assign([],a):a,Vn);if(s.revoke.push(l),a.proxy=c,n){const u=n;u.finalities.draft.push((d,f)=>{var p,h;const y=S(c);let v=u.type===3?u.setMap:u.copy;const b=oe(v,r),m=S(b);if(m){let w=m.original;m.operated&&(w=Bt(b)),wt(m),Tt(m,Le,d,f),u.options.enableAutoFreeze&&(u.options.updatedValues=(p=u.options.updatedValues)!==null&&p!==void 0?p:new WeakMap,u.options.updatedValues.set(w,m.original)),Ne(v,r,w)}(h=y.callbacks)===null||h===void 0||h.forEach(w=>{w(d,f)})})}else{const u=S(c);u.finalities.draft.push((d,f)=>{wt(u),Tt(u,Le,d,f)})}return c}Ft.createDraft=Vt;function Qr(t,e,n,r,s){var i;const o=S(t),a=(i=o==null?void 0:o.original)!==null&&i!==void 0?i:t,c=!!e.length;if(o!=null&&o.operated)for(;o.finalities.draft.length>0;)o.finalities.draft.pop()(n,r);const l=c?e[0]:o?o.operated?o.copy:o.original:t;return o&&gt(o),s&&be(l,l,o==null?void 0:o.options.updatedValues),[l,n&&c?[{op:j.Replace,path:[],value:e[0]}]:n,r&&c?[{op:j.Replace,path:[],value:a}]:r]}function Gr(t,e){var n;const r={draft:[],revoke:[],handledSet:new WeakSet,draftsCache:new WeakSet};let s,i;e.enablePatches&&(s=[],i=[]);const a=((n=e.mark)===null||n===void 0?void 0:n.call(e,t,W))===W.mutable||!J(t,e)?t:Vt({original:t,parentDraft:null,finalities:r,options:e});return[a,(c=[])=>{const[l,u,d]=Qr(a,c,s,i,e.enableAutoFreeze);return e.enablePatches?[l,u,d]:l}]}function Ot(t){const{rootDraft:e,value:n,useRawReturn:r=!1,isRoot:s=!0}=t;zt(n,(i,o,a)=>{const c=S(o);if(c&&e&&c.finalities===e.finalities){t.isContainDraft=!0;const l=c.original;if(a instanceof Set){const u=Array.from(a);a.clear(),u.forEach(d=>a.add(i===d?l:d))}else Ne(a,i,l)}else typeof o=="object"&&o!==null&&(t.value=o,t.isRoot=!1,Ot(t))}),s&&(t.isContainDraft||console.warn("The return value does not contain any draft, please use 'rawReturn()' to wrap the return value to improve performance."),r&&console.warn("The return value contains drafts, please don't use 'rawReturn()' to wrap the return value."))}function Hn(t){var e;const n=S(t);if(!J(t,n==null?void 0:n.options))return t;const r=ye(t);if(n&&!n.operated)return n.original;let s;function i(){s=r===2?Kt(t)?new Map(t):new(Object.getPrototypeOf(t)).constructor(t):r===3?Array.from(n.setMap.values()):zn(t,n==null?void 0:n.options)}if(n){n.finalized=!0;try{i()}finally{n.finalized=!1}}else s=t;if(zt(s,(o,a)=>{if(n&&ie(oe(n.original,o),a))return;const c=Hn(a);c!==a&&(s===t&&i(),Ne(s,o,c))}),r===3){const o=(e=n==null?void 0:n.original)!==null&&e!==void 0?e:s;return qt(o)?new Set(s):new(Object.getPrototypeOf(o)).constructor(s)}return s}function rn(t){if(!ae(t))throw new Error(`current() is only used for Draft, parameter: ${t}`);return Hn(t)}const Jr=t=>function e(n,r,s){var i,o,a;if(typeof n=="function"&&typeof r!="function")return function(g,...E){return e(g,k=>n.call(this,k,...E),r)};const c=n,l=r;let u=s;if(typeof r!="function"&&(u=r),u!==void 0&&Object.prototype.toString.call(u)!=="[object Object]")throw new Error(`Invalid options: ${u}, 'options' should be an object.`);u=Object.assign(Object.assign({},t),u);const d=ae(c)?rn(c):c,f=Array.isArray(u.mark)?(g,E)=>{for(const k of u.mark){if(typeof k!="function")throw new Error(`Invalid mark: ${k}, 'mark' should be a function.`);const x=k(g,E);if(x)return x}}:u.mark,p=(i=u.enablePatches)!==null&&i!==void 0?i:!1,h=(o=u.strict)!==null&&o!==void 0?o:!1,v={enableAutoFreeze:(a=u.enableAutoFreeze)!==null&&a!==void 0?a:!1,mark:f,strict:h,enablePatches:p};if(!J(d,v)&&typeof d=="object"&&d!==null)throw new Error("Invalid base state: create() only supports plain objects, arrays, Set, Map or using mark() to mark the state as immutable.");const[b,m]=Gr(d,v);if(typeof r!="function"){if(!J(d,v))throw new Error("Invalid base state: create() only supports plain objects, arrays, Set, Map or using mark() to mark the state as immutable.");return[b,m]}let w;try{w=l(b)}catch(g){throw gt(S(b)),g}const T=g=>{const E=S(b);if(!ae(g)){if(g!==void 0&&!ie(g,b)&&(E!=null&&E.operated))throw new Error("Either the value is returned as a new non-draft value, or only the draft is modified without returning any value.");const x=g==null?void 0:g[Ur];if(x){const ue=x[0];return v.strict&&typeof g=="object"&&g!==null&&Ot({rootDraft:E,value:g,useRawReturn:!0}),m([ue])}if(g!==void 0)return typeof g=="object"&&g!==null&&Ot({rootDraft:E,value:g}),m([g])}if(g===b||g===void 0)return m([]);const k=S(g);if(v===k.options){if(k.operated)throw new Error("Cannot return a modified child draft.");return m([rn(g)])}return m([g])};return w instanceof Promise?w.then(T,g=>{throw gt(S(b)),g}):T(w)},et=Jr();Object.prototype.constructor.toString();function Qn(t,e){const n=Object.keys(t),r=Object.keys(e);return n.length===r.length&&Object.keys(t).every(s=>e.hasOwnProperty(s))}function sn(t,e){return Object.keys(t).length===Object.keys(e).length&&Object.keys(t).every(n=>e.hasOwnProperty(n)&&t[n]===e[n])}function Ge(t,e){return typeof t!="object"||typeof e!="object"||t===null||e===null?t===e:Qn(t,e)?Object.keys(t).every(n=>Ge(t[n],e[n])):!1}function Ht(t){if(!Pe(t))return t;const e={};for(const[n,r]of Object.entries(t))r!==void 0&&(e[n]=r);return e}function Gn(t,e){if(!Pe(t)||!Pe(e))return e;const n=Object.assign({},t);for(const r of Object.keys(e)){if(e[r]===void 0)continue;if(e[r]===null){delete n[r];continue}const s=Pe(t[r])&&Pe(e[r]);n[r]=s?Gn(t[r],e[r]):e[r]}return n}function Pe(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}function Yr(t,e,n){if(!t||e.length===0)return;let r=t||{};for(let i=0;i<e.length-1;i++){const o=e[i];(!(o in r)||typeof r[o]!="object")&&(r[o]=typeof e[i+1]=="number"?[]:{}),r=r[o]}const s=e[e.length-1];Array.isArray(r)&&typeof s=="number"?r.splice(s,0,n):r[s]=n}function on(t,e,n){if(!t||e.length===0)return;let r=t||{};for(let s=0;s<e.length-1;s++){const i=e[s];(!(i in r)||typeof r[i]!="object")&&(r[i]=typeof e[s+1]=="number"?[]:{}),r=r[i]}r[e[e.length-1]]=n}function Jn(t,e){if(!t||e.length===0)return;const[n,...r]=e;if(n in t){if(r.length===0){Array.isArray(t)?t.splice(n,1):delete t[n];return}Jn(t[n],r),Zr(t[n])&&delete t[n]}}function Zr(t){return t&&Object.keys(t).length===0}const an=/ZULU|YEKT|YEKST|YAPT|YAKT|YAKST|XJT|WGT|WGST|WFT|WETDST|WET|WDT|WAT|WAST|WAKT|WADT|VUT|VOLT|VLAT|VLAST|VET|UZT|UZST|UYT|UYST|UTC|UT|ULAT|ULAST|UCT|TVT|TRUT|TOT|TMT|TKT|TJT|TFT|TAHT|SGT|SCT|SAST|SADT|RET|PYT|PYST|PWT|PST|PONT|PMST|PMDT|PKT|PKST|PHT|PGT|PETT|PETST|PET|PDT|OMST|OMSST|NZT|NZST|NZDT|NUT|NST|NPT|NOVT|NOVST|NFT|NDT|MYT|MVT|MUT|MUST|MST|MSK|MSD|MPT|MMT|MHT|MEZ|METDST|MET|MESZ|MEST|MDT|MAWT|MART|MAGT|MAGST|LKT|LINT|LIGT|LHST|LHDT|KST|KRAT|KRAST|KOST|KGT|KGST|KDT|JST|JAYT|IST|IRT|IRKT|IRKST|IOT|IDT|ICT|HST|HKT|GYT|GMT|GILT|GFT|GET|GEST|GAMT|GALT|FNT|FNST|FKT|FKST|FJT|FJST|FET|EST|EGT|EGST|EETDST|EET|EEST|EDT|EAT|EAST|EASST|DDUT|DAVT|CXT|CST|COT|CLT|CLST|CKT|CHUT|CHAST|CHADT|CETDST|CET|CEST|CDT|CCT|CAST|CADT|BTT|BST|BRT|BRST|BRA|BOT|BORT|BNT|BDT|BDST|AZT|AZST|AZOT|AZOST|AWST|AWSST|AST|ART|ARST|ANAT|ANAST|AMT|AMST|ALMT|ALMST|AKST|AKDT|AFT|AEST|AESST|AEDT|ADT|ACWST|ACT|ACST|ACSST|ACDT$/,Xr={ZULU:0,YEKT:18e3,YEKST:21600,YAPT:36e3,YAKT:32400,YAKST:32400,XJT:21600,WGT:-10800,WGST:-7200,WFT:43200,WETDST:3600,WET:0,WDT:32400,WAT:3600,WAST:25200,WAKT:43200,WADT:28800,VUT:39600,VOLT:10800,VLAT:36e3,VLAST:36e3,VET:-14400,UZT:18e3,UZST:21600,UYT:-10800,UYST:-7200,UTC:0,UT:0,ULAT:28800,ULAST:32400,UCT:0,TVT:43200,TRUT:36e3,TOT:46800,TMT:18e3,TKT:46800,TJT:18e3,TFT:18e3,TAHT:-36e3,SGT:28800,SCT:14400,SAST:7200,SADT:37800,RET:14400,PYT:-14400,PYST:-10800,PWT:32400,PST:-28800,PONT:39600,PMST:-10800,PMDT:-7200,PKT:18e3,PKST:21600,PHT:28800,PGT:36e3,PETT:43200,PETST:43200,PET:-18e3,PDT:-25200,OMST:21600,OMSST:21600,NZT:43200,NZST:43200,NZDT:46800,NUT:-39600,NST:-12600,NPT:20700,NOVT:25200,NOVST:25200,NFT:-12600,NDT:-9e3,MYT:28800,MVT:18e3,MUT:14400,MUST:18e3,MST:-25200,MSK:10800,MSD:14400,MPT:36e3,MMT:23400,MHT:43200,MEZ:3600,METDST:7200,MET:3600,MESZ:7200,MEST:7200,MDT:-21600,MAWT:18e3,MART:-34200,MAGT:39600,MAGST:39600,LKT:19800,LINT:50400,LIGT:36e3,LHST:37800,LHDT:37800,KST:32400,KRAT:25200,KRAST:25200,KOST:39600,KGT:21600,KGST:21600,KDT:36e3,JST:32400,JAYT:32400,IST:7200,IRT:12600,IRKT:28800,IRKST:28800,IOT:21600,IDT:10800,ICT:25200,HST:-36e3,HKT:28800,GYT:-14400,GMT:0,GILT:43200,GFT:-10800,GET:14400,GEST:14400,GAMT:-32400,GALT:-21600,FNT:-7200,FNST:-3600,FKT:-10800,FKST:-10800,FJT:43200,FJST:46800,FET:10800,EST:-18e3,EGT:-3600,EGST:0,EETDST:10800,EET:7200,EEST:10800,EDT:-14400,EAT:10800,EAST:-21600,EASST:-21600,DDUT:36e3,DAVT:25200,CXT:25200,CST:-21600,COT:-18e3,CLT:-14400,CLST:-10800,CKT:-36e3,CHUT:36e3,CHAST:45900,CHADT:49500,CETDST:7200,CET:3600,CEST:7200,CDT:-18e3,CCT:28800,CAST:34200,CADT:37800,BTT:21600,BST:3600,BRT:-10800,BRST:-7200,BRA:-10800,BOT:-14400,BORT:28800,BNT:28800,BDT:21600,BDST:7200,AZT:14400,AZST:14400,AZOT:-3600,AZOST:0,AWST:28800,AWSST:32400,AST:-14400,ART:-10800,ARST:-10800,ANAT:43200,ANAST:43200,AMT:-14400,AMST:14400,ALMT:21600,ALMST:25200,AKST:-32400,AKDT:-28800,AFT:16200,AEST:36e3,AESST:39600,AEDT:39600,ADT:-10800,ACWST:31500,ACT:-18e3,ACST:34200,ACSST:37800,ACDT:37800};function es(t){return new Date(t)}function ts(t){return new Date(t+"Z")}const ns=/^(\d+)[\./-](\d+)[\./-](\d+)$/;function rs(t){const e=t.match(ns);if(!e)return null;const[n,r,s,i]=e;return r<=0||s<=0||i<=0?null:r>999?new Date(Date.UTC(r,s-1,i,0,0,0,0)):new Date(Date.UTC(i,r-1,s,0,0,0,0))}function ss(t){const[e,n]=t.split(" ");return new Date(e+"T"+n+"Z")}function is(t){const[e,n]=t.split(" ");return new Date(e+"T"+n+"Z")}function os(t){return new Date(t)}function as(t){const e=/^(\w{3}) (\w{3}) (\d{2}) (\d{4})$/;if(!t.match(e))throw new Error(`Unable to parse \`${t}\` as a date.`);const r=new Date(t+" UTC");return new Date(Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate(),0,0,0,0))}function cs(t){const e=/^(.+T.+)([+-])(\d{2})$/,n=t.match(e);if(n){const[,r,s,i]=n,o=`${r}${s}${i}:00`;return new Date(o)}return null}function us(t){const e=/^(\d+)-(\d{1,2})-(\d{1,2})([ T])(.+)$/,n=t.match(e);if(n){const[,r,s,i,o,a]=n,c=s.padStart(2,"0"),l=i.padStart(2,"0"),u=`${r}-${c}-${l}T${a}`;return new Date(u)}return null}function ls(t){const[e,n]=t.split(", "),[r,s,i]=e.split("/").map(Number),o=n.match(/(\d{1,2}):(\d{2}):(\d{2}) (AM|PM)/);if(!o)throw new Error(`Unable to parse time from: ${t}`);let[,a,c,l,u]=o;return a=Number(a),c=Number(c),l=Number(l),u==="PM"&&a!==12?a+=12:u==="AM"&&a===12&&(a=0),new Date(Date.UTC(i,r-1,s,a,c,l))}function ds(t){switch(t){case"epoch":return new Date(0);case"infinity":case"-infinity":case"today":case"tomorrow":case"yesterday":return null}}function fs(t){const e=t.match(an);if(!e)return null;const[n]=e,r=Xr[n],s=new Date(t.replace(an,"Z"));return new Date(s.getTime()-r*1e3)}const ps=[rs,is,as,ls,os,ts,cs,ss,es,ds,fs,us];function hs(t,e){try{const n=t(e);return n instanceof Date&&!isNaN(n.getTime())?n:null}catch{return null}}function Et(t){for(const e of ps){const n=hs(e,t);if(n)return n}return null}function ys(t){try{const e=JSON.parse(t);return typeof e=="string"?Et(e):null}catch{return null}}function st(t){if(t!==void 0){if(t===null)return null;if(t instanceof Date)return t;if(typeof t=="string"){const e=Et(t)||ys(t)||Et(t.trim());if(!e)throw new Error(`Unable to parse \`${t}\` as a date.`);return e}else if(typeof t=="number")return new Date(t);throw new Error(`Invalid date value \`${t}\`. Expected a date, number, or string, got type ${typeof t}.`)}}function vs(t){return t.cardinality==="one"}function Qt(t){return t["value-type"]==="ref"}function Gt(t){return t["value-type"]==="blob"}function Te(t,e){return t[e]}function Se(t,e){return e.reduce((n,r)=>n&&n.get(r),t)}function Q(t,e){if(e.length===0)throw new Error("path must have at least one element");if(e.length===1){t.delete(e[0]);return}const[n,...r]=e;t.has(n)&&Q(t.get(n),r)}function q(t,e,n){if(e.length===0)throw new Error("path must have at least one element");if(e.length===1){t.set(e[0],n);return}const[r,...s]=e;let i=t.get(r);i||(i=new Map,t.set(r,i)),q(i,s,n)}function Yn(t,e,n){const r=new Map,s=new Map,i=new Map;for(const o of e){let[a,c,l,u]=o;const d=Te(t,c);if(!d){console.warn("no such attr",a,t);continue}d["checked-data-type"]==="date"&&n&&(l=st(l),o[2]=l),Qt(d)&&q(i,[l,c,a],o),q(r,[a,c,l],o),q(s,[c,a,l],o)}return{eav:r,aev:s,vae:i}}function Zn(t){const e=new Map,n=new Map,r=new Map,s=new Map;for(const i of Object.values(t)){const o=i["forward-identity"],[a,c,l]=o,u=i["reverse-identity"];if(q(r,[c,l],i),Gt(i)&&q(e,[c,l],i),i["primary?"]&&q(n,[c],i),u){const[d,f,p]=u;q(s,[f,p],i)}}return{blobAttrs:e,primaryKeys:n,forwardIdents:r,revIdents:s}}function Xn(t){return{__type:t.__type,attrs:t.attrs,triples:K(t.eav,3),cardinalityInference:t.cardinalityInference,linkIndex:t.linkIndex,useDateObjects:t.useDateObjects}}function er(t){return Je(t.attrs,t.triples,t.cardinalityInference,t.linkIndex,t.useDateObjects)}function bs(t,e){return Se(t.eav,[e])!==void 0}function Jt(t){t.attrIndexes=Zn(t.attrs)}function Je(t,e,n,r,s){const i=Yn(t,e,s);return i.useDateObjects=s,i.attrs=t,i.attrIndexes=Zn(t),i.cardinalityInference=n,i.linkIndex=r,i.__type="store",i}function Fe(t,e){var n,r;let s;if(Array.isArray(e[0])){const[o,a]=e[0],c=t.aev.get(o);if(!c)return null;s=(n=K(c,2).find(u=>u[2]===a))===null||n===void 0?void 0:n[0]}else s=e[0];if(!s)return null;const i=e[2];if(Array.isArray(i)&&i.length===2&&t.aev.get(i[0])){const[o,a]=i,c=t.aev.get(o);if(!c)return null;const u=(r=K(c,2).find(y=>y[2]===a))===null||r===void 0?void 0:r[0];if(!u)return null;const[d,f,p,...h]=e;return[s,f,u,...h]}else{const[o,...a]=e;return[s,...a]}}function tr(t,e){const n=Fe(t,e);if(!n)return;const[r,s,i]=n,o=Te(t.attrs,s);o&&(Q(t.eav,[r,s,i]),Q(t.aev,[s,r,i]),Qt(o)&&Q(t.vae,[i,s,r]))}let ms=0;function nr(t,e,n){const[r,s,i]=n;let o;const a=Se(t.eav,[r,s,i]);return a&&(o=a[3]),o||Date.now()*10+ms++}function rr(t,e){var n;const r=Fe(t,e);if(!r)return;let[s,i,o]=r;const a=Te(t.attrs,i);if(!a)return;a["checked-data-type"]==="date"&&t.useDateObjects&&(o=st(o));const c=Se(t.eav,[s,i,o]),l=(n=c==null?void 0:c[3])!==null&&n!==void 0?n:nr(t,a,r),u=[s,i,o,l];vs(a)?(q(t.eav,[s,i],new Map([[o,u]])),q(t.aev,[i,s],new Map([[o,u]]))):(q(t.eav,[s,i,o],u),q(t.aev,[i,s,o],u)),Qt(a)&&q(t.vae,[o,i,s],u)}function _s(t,e){var n;const r=Fe(t,e);if(!r)return;const[s,i,o]=r,a=Te(t.attrs,i);if(!a)return;if(!Gt(a))throw new Error("merge operation is not supported for links");const c=Se(t.eav,[s,i]);if(!c)return;const l=(n=c.values().next())===null||n===void 0?void 0:n.value;if(!l)return;const u=l[2],d=Gn(u,o),f=[s,i,d,nr(t,a,l)];q(t.eav,[s,i],new Map([[d,f]]))}function kt(t,e){var n,r;const[s,i]=e,o=Fe(t,[s]);if(!o)return;const[a]=o,c=t.eav.get(a);if(c){for(const u of c.keys()){const d=t.attrs[u];d&&d["on-delete-reverse"]==="cascade"&&K(c.get(u),1).forEach(([f,p,h])=>{var y;return kt(t,[h,(y=d["reverse-identity"])===null||y===void 0?void 0:y[1]])}),(!i||!d||((n=d["forward-identity"])===null||n===void 0?void 0:n[1])===i)&&(Q(t.aev,[u,a]),Q(t.eav,[a,u]))}c.size===0&&Q(t.eav,[a])}const l=t.vae.get(a)&&K(t.vae.get(a),2);l&&l.forEach(u=>{var d,f,p;const[h,y,v]=u,b=t.attrs[y];(!i||!b||((d=b["reverse-identity"])===null||d===void 0?void 0:d[1])===i)&&(Q(t.eav,[h,y,v]),Q(t.aev,[y,h,v]),Q(t.vae,[v,y,h])),b&&b["on-delete"]==="cascade"&&((f=b["reverse-identity"])===null||f===void 0?void 0:f[1])===i&&kt(t,[h,(p=b["forward-identity"])===null||p===void 0?void 0:p[1]])}),((r=t.vae.get(a))===null||r===void 0?void 0:r.size)===0&&Q(t.vae,[a])}function sr(t,e){const n=Yn(t.attrs,e,t.useDateObjects);Object.keys(n).forEach(r=>{t[r]=n[r]})}function gs(t,[e]){t.attrs[e.id]=e,Jt(t)}function ir(t){return K(t.eav,3)}function ws(t,[e]){if(!t.attrs[e])return;const n=ir(t).filter(([r,s])=>s!==e);delete t.attrs[e],Jt(t),sr(t,n)}function Ts(t,[e]){const n=t.attrs[e.id];n&&(t.attrs[e.id]=Object.assign(Object.assign({},n),e),Jt(t),sr(t,ir(t)))}function Ss(t,e){const[n,...r]=e;switch(n){case"add-triple":rr(t,r);break;case"deep-merge-triple":_s(t,r);break;case"retract-triple":tr(t,r);break;case"delete-entity":kt(t,r);break;case"add-attr":gs(t,r);break;case"delete-attr":ws(t,r);break;case"update-attr":Ts(t,r);break;case"restore-attr":break;case"rule-params":break;default:throw new Error(`unhandled transaction action: ${n}`)}}function K(t,e,n=[]){if(!t||e===0)return n;if(e===1){for(const r of t.values())n.push(r);return n}for(const r of t.values())K(r,e-1,n);return n}function Ke(t,e,n){var r;const s=[];if(n!=null&&n.hasOwnProperty("$not")){for(const o of e.keys())n.$not!==o&&s.push(e.get(o));return s}if(n!=null&&n.hasOwnProperty("$isNull")){const{attrId:o,isNull:a,reverse:c}=n.$isNull;if(c)for(const l of e.keys()){const u=t.vae.get(l),d=!u||!u.get(o);(a?d:!d)&&s.push(e.get(l))}else{const l=t.aev.get(o);for(const u of e.keys()){const d=!l||((r=l.get(u))===null||r===void 0?void 0:r.get(null))||!l.get(u);(a?d:!d)&&s.push(e.get(u))}}return s}if(n!=null&&n.$comparator)return K(e,1).filter(n.$op);const i=n.in||n.$in||[n];for(const o of i){const a=e.get(o);a&&s.push(a)}return s}function Os(t,e,n){let r="";return t!==void 0&&(r+="e"),e!==void 0&&(r+="a"),n!==void 0&&(r+="v"),r}function Es(t,[e,n,r]){var s,i;switch(Os(e,n,r)){case"e":{const a=t.eav.get(e);return K(a,2)}case"ea":{const a=(s=t.eav.get(e))===null||s===void 0?void 0:s.get(n);return K(a,1)}case"eav":{const a=(i=t.eav.get(e))===null||i===void 0?void 0:i.get(n);return a?Ke(t,a,r):[]}case"ev":{const a=t.eav.get(e);if(!a)return[];const c=[];for(const l of a.values())c.push(...Ke(t,l,r));return c}case"a":{const a=t.aev.get(n);return K(a,2)}case"av":{const a=t.aev.get(n);if(!a)return[];const c=[];for(const l of a.values())c.push(...Ke(t,l,r));return c}case"v":{const a=[];for(const c of t.eav.values())for(const l of c.values())a.push(...Ke(t,l,r));return a}default:return K(t.eav,3)}}function ks(t,e,n){var r;const s={};for(const[i,o]of e.entries()){const a=(r=t.eav.get(n))===null||r===void 0?void 0:r.get(o.id),c=K(a,1);for(const l of c)s[i]=l[2]}return s}function ce(t,e,n){var r;return(r=t.attrIndexes.forwardIdents.get(e))===null||r===void 0?void 0:r.get(n)}function or(t,e,n){var r;return(r=t.attrIndexes.revIdents.get(e))===null||r===void 0?void 0:r.get(n)}function As(t,e){return t.attrIndexes.blobAttrs.get(e)}function ar(t,e){var n;const r=t.attrIndexes.primaryKeys.get(e);return r||((n=t.attrIndexes.forwardIdents.get(e))===null||n===void 0?void 0:n.get("id"))}function Cs(t,e){const n=Fe(t,e);if(!n)return;const[r,s,i]=n;if(Te(t.attrs,s))return Se(t.eav,[r,s])}function Is(t,e){const n=e.filter(([r,s,i,o,a])=>{if(r!=="add-triple"&&r!=="deep-merge-triple")return!0;const c=a==null?void 0:a.mode;if(c!=="create"&&c!=="update")return!0;let l=!1;const u=Te(t.attrs,i);if(u){const d=ar(t,u["forward-identity"][1]);l=!!Cs(t,[s,d==null?void 0:d.id,s])}return!(c==="create"&&l||c==="update"&&!l)});return et(t,r=>{n.forEach(s=>{Ss(r,s)})})}function js(t){return typeof t=="string"&&t.startsWith("?")}function Ms(t,e,n){if(n.hasOwnProperty(t)){const r=n[t];return cr(r,e,n)}return Object.assign(Object.assign({},n),{[t]:e})}function cn(t,e,n){return t===e?n:null}function Ps(t){switch(typeof t){case"string":return t.startsWith("?")?Ms:cn;default:return cn}}const $s=["in","$in","$not","$isNull","$comparator"];function xs(t){for(const e of $s)if(t.hasOwnProperty(e))return!0;return!1}function cr(t,e,n){return n?typeof t=="object"?xs(t)?n:null:Ps(t)(t,e,n):null}function Ds(t,e,n){return t.reduce((r,s,i)=>{const o=e[i];return cr(s,o,r)},n)}function Rs(t,e,n){return Ns(t,e,n).map(r=>Ds(e,r,n)).filter(r=>r)}function Ls(t,e,n){return e.or?e.or.patterns.flatMap(r=>At(t,r,n)):e.and?e.and.patterns.reduce((r,s)=>At(t,s,r),n):n.flatMap(r=>Rs(t,e,r))}function At(t,e,n=[{}]){return e.reduce((r,s)=>Ls(t,s,r),n)}function Yt(t,e){return Array.isArray(e)?e.map(n=>Yt(t,n)):js(e)?t[e]:e}function Us(t,{find:e,where:n}){return At(t,n).map(s=>Yt(s,e))}function Ns(t,e,n){return Es(t,Yt(n,e))}const Fs=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function ge(t){return typeof t=="string"&&Fs.test(t)}const D=[];for(let t=0;t<256;++t)D.push((t+256).toString(16).slice(1));function qs(t,e=0){return(D[t[e+0]]+D[t[e+1]]+D[t[e+2]]+D[t[e+3]]+"-"+D[t[e+4]]+D[t[e+5]]+"-"+D[t[e+6]]+D[t[e+7]]+"-"+D[t[e+8]]+D[t[e+9]]+"-"+D[t[e+10]]+D[t[e+11]]+D[t[e+12]]+D[t[e+13]]+D[t[e+14]]+D[t[e+15]]).toLowerCase()}let lt;const Ks=new Uint8Array(16);function Bs(){if(!lt){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");lt=crypto.getRandomValues.bind(crypto)}return lt(Ks)}const zs=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),un={randomUUID:zs};function Ws(t,e,n){var s;if(un.randomUUID&&!t)return un.randomUUID();t=t||{};const r=t.random??((s=t.rng)==null?void 0:s.call(t))??Bs();if(r.length<16)throw new Error("Random bytes length must be >= 16");return r[6]=r[6]&15|64,r[8]=r[8]&63|128,qs(r)}function ln(t){const e=t.replace(/-/g,""),n=[];for(let r=0;r<e.length;r+=2)n.push(parseInt(e.substring(r,r+2),16));return n}function Vs(t,e){for(let n=0;n<t.length;n++){if(t[n]<e[n])return-1;if(t[n]>e[n])return 1}return 0}function Hs(t,e){return Vs(ln(t),ln(e))}function $(){return Ws()}function Qs(t,e){return t.localeCompare(e)}function Gs(){let t=Qs;if(typeof Intl=="object"&&Intl.hasOwnProperty("Collator"))try{t=Intl.Collator("en-US").compare}catch{}return t}const Js=Gs();let Ys=0;function De(t){return it(`_${t}`,Ys++)}function it(t,e){return`?${t}-${e}`}class we extends Error{constructor(e){super(e),this.name="AttrNotFoundError"}}function Zs(t,e){const n=ar(t,e);if(!n)throw new we(`Could not find id attr for ${e}`);return n}function dn(t,e,n,r){return[Xs(t,e,n,r)]}function Xs(t,e,n,r){return[t(n,r),Zs(e,n).id,t(n,r),t("time",r)]}function ei(t,e,n){return t.map(r=>r===e?n:r)}function ur(t,e,n,r,s){const i=ce(e,n,s),o=or(e,n,s),a=i||o;if(!a)throw new we(`Could not find attr for ${[n,s]}`);if(a["value-type"]!=="ref")throw new Error(`Attr ${a.id} is not a ref`);const[c,l]=a["forward-identity"],[u,d]=a["reverse-identity"],f=r+1,p=i?[t(l,r),a.id,t(d,f),De("time")]:[t(l,f),a.id,t(d,r),De("time")];return[i?d:l,f,p,a,!!i]}function fn(t,e){if(typeof e!="string")return function(o){return!1};const r=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/%/g,".*").replace(/_/g,"."),s=new RegExp(`^${r}$`,t?void 0:"i");return function(o){return typeof o!="string"?!1:s.test(o)}}function ti(t,e){if(typeof e!="object"||e.hasOwnProperty("$in")||e.hasOwnProperty("in"))return e;const n=t["checked-data-type"]==="date";if(e.hasOwnProperty("$gt"))return{$comparator:!0,$op:n?function(s){return new Date(s[2])>new Date(e.$gt)}:function(s){return s[2]>e.$gt}};if(e.hasOwnProperty("$gte"))return{$comparator:!0,$op:n?function(s){return new Date(s[2])>=new Date(e.$gte)}:function(s){return s[2]>=e.$gte}};if(e.hasOwnProperty("$lt"))return{$comparator:!0,$op:n?function(s){return new Date(s[2])<new Date(e.$lt)}:function(s){return s[2]<e.$lt}};if(e.hasOwnProperty("$lte"))return{$comparator:!0,$op:n?function(s){return new Date(s[2])<=new Date(e.$lte)}:function(s){return s[2]<=e.$lte}};if(e.hasOwnProperty("$like")){const r=fn(!0,e.$like);return{$comparator:!0,$op:function(i){return r(i[2])}}}if(e.hasOwnProperty("$ilike")){const r=fn(!1,e.$ilike);return{$comparator:!0,$op:function(i){return r(i[2])}}}return e}function ni(t,e,n,r,s,i){const o=ce(e,n,s),a=or(e,n,s),c=o||a;if(!c)throw new we(`No attr for etype = ${n} label = ${s}`);if(i!=null&&i.hasOwnProperty("$isNull")){const l=ce(e,n,"id");if(!l)throw new we(`No attr for etype = ${n} label = id`);return[t(n,r),l.id,{$isNull:{attrId:c.id,isNull:i.$isNull,reverse:!o}},De("time")]}return o?[t(n,r),c.id,ti(c,i),De("time")]:[i,c.id,t(n,r),De("time")]}function ri(t,e,n,r,s){const[i,o,a]=s.reduce((c,l)=>{const[u,d,f]=c,[p,h,y]=ur(t,e,u,d,l);return[p,h,[...f,y]]},[n,r,[]]);return[i,o,a]}function Ct(t,e,n,r,s,i){const o=s.slice(0,s.length-1),a=s[s.length-1],[c,l,u]=ri(t,e,n,r,o),d=ni(t,e,c,l,a,i);return u.concat([d])}function si(t,e){return e?[e].concat(t):t}function ii([t,e]){return t==="or"&&Array.isArray(e)}function oi([t,e]){return t==="and"&&Array.isArray(e)}function ai(t,e,n){return(r,s)=>{const i=t(r,s);return e==i?i:`${i}-${n}`}}function pn(t,e,n,r,s,i){const o=t(r,s),a=i.map((c,l)=>{const u=ai(t,o,l);return lr(u,n,r,s,c)});return{[e]:{patterns:a,joinSym:o}}}function ci(t){const e=[];for(let n=1;n<=t.length;n++)e.push(t.slice(0,n));return e}function hn(t,e,n,r,s){return ci(s).map(i=>Ct(t,e,n,r,i,{$isNull:!0}))}function lr(t,e,n,r,s){return Object.entries(s).flatMap(([i,o])=>{if(ii([i,o]))return pn(t,"or",e,n,r,o);if(oi([i,o]))return pn(t,"and",e,n,r,o);if(i==="$entityIdStartsWith")return[];const a=i.split(".");if(o!=null&&o.hasOwnProperty("$ne")&&(o=Object.assign(Object.assign({},o),{$not:o.$ne}),delete o.$ne),o!=null&&o.hasOwnProperty("$not")){const c=Ct(t,e,n,r,a,o),l=hn(t,e,n,r,a);return[{or:{patterns:[c,...l],joinSym:t(n,r)}}]}return o!=null&&o.hasOwnProperty("$isNull")&&o.$isNull===!0&&a.length>1?[{or:{patterns:hn(t,e,n,r,a),joinSym:t(n,r)}}]:Ct(t,e,n,r,a,o)})}function ui(t,e,n,r){const s=it;return r?lr(s,t,e,n,r).concat(dn(s,t,e,n)):dn(s,t,e,n)}function li(t,e,n){return[t(e,n),t("time",n)]}function di(t,e,n,r,s,i){const[o,a,c,l,u]=ur(t,e,n,r,s),d=ei(c,t(n,r),i);return[o,a,d,l,u]}function fi(t,e,{etype:n,level:r,form:s},i){const o=Object.keys(s).filter(a=>a!=="$");return o.length?Object.entries(i).map(function([c,l]){return o.map(function(f){var p,h,y;const v=!!(e.cardinalityInference&&(!((y=(h=(p=e.linkIndex)===null||p===void 0?void 0:p[n])===null||h===void 0?void 0:h[f])===null||y===void 0)&&y.isSingular));try{const[b,m,w]=di(t,e,n,r,f,c),T=fr(e,{etype:b,level:m,form:s[f],join:w}),g=v?T[0]:T;return{[f]:g}}catch(b){if(b instanceof we)return{[f]:v?void 0:[]};throw b}}).reduce(function(f,p){return Object.assign(Object.assign({},f),p)},l)}):Object.values(i)}function pi(t,e,n){return n==="string"?Js(t,e):t>e?1:-1}function $e(t,e,n,r,s){return e===r||e==null&&r==null?Hs(t,n):r==null?1:e==null?-1:pi(e,r,s)}function tt([t,e],[n,r],s){return $e(t,e,n,r,s)}function It(t){return t==null?t:new Date(t).getTime()}function hi(t,e,n,r){var s;const[i,o,a,c]=t,l=n==="desc"?1:-1;if(((s=e["forward-identity"])===null||s===void 0?void 0:s[2])==="id")return tt(r,[i,c],null)===l;const[u,d]=r,f=e["checked-data-type"],p=f==="date"?It(d):d,h=f==="date"?It(a):a;return tt([u,p],[i,h],f)===l}function yi(t,e){const n=e[1];return t.attrs[n]}function vi(t,e,n){const r=Object.keys(n)[0];return ce(t,e,r)}function bi(t,e,n,r){if(n)return yi(t,n);if(r)return vi(t,e,r)}function mi(t,e,n){var r,s;if(!Array.isArray(n.fields))return As(t,e);const i=new Map;for(const o of n.fields){const a=ce(t,e,o),c=(r=a==null?void 0:a["forward-identity"])===null||r===void 0?void 0:r[2];c&&Gt(a)&&i.set(c,a)}if(!i.has("id")){const o=ce(t,e,"id"),a=(s=o==null?void 0:o["forward-identity"])===null||s===void 0?void 0:s[2];a&&i.set(a,o)}return i}function _i(t,{etype:e,pageInfo:n,dq:r,form:s}){var i,o;const a=(i=s==null?void 0:s.$)===null||i===void 0?void 0:i.order,c=dr(s),l=gi(s);let u=Us(t,r);const d=n==null?void 0:n["start-cursor"],f=bi(t,e,d,a);if(f&&((o=f==null?void 0:f["forward-identity"])===null||o===void 0?void 0:o[2])!=="id"){const y=f["checked-data-type"]==="date",v=f.id;u=u.map(([b])=>{var m,w,T,g,E;let k=(E=(g=(T=(w=(m=t.eav.get(b))===null||m===void 0?void 0:m.get(v))===null||w===void 0?void 0:w.values())===null||T===void 0?void 0:T.next())===null||g===void 0?void 0:g.value)===null||E===void 0?void 0:E[2];return y&&(k=It(k)),[b,k]})}u.sort(l==="asc"?function(v,b){return tt(v,b,f==null?void 0:f["checked-data-type"])}:function(v,b){return tt(b,v,f==null?void 0:f["checked-data-type"])});let p={};const h=mi(t,e,r);for(const y of u){const[v]=y;if(p[v]||!c&&d&&f&&hi(d,f,l,y))continue;const b=ks(t,h,v);b&&(p[v]=b)}return p}function gi(t){var e;const n=(e=t.$)===null||e===void 0?void 0:e.order;return n&&n[Object.keys(n)[0]]||"asc"}function dr(t){var e,n,r;const s=(e=t.$)===null||e===void 0?void 0:e.offset,i=(n=t.$)===null||n===void 0?void 0:n.before,o=(r=t.$)===null||r===void 0?void 0:r.after;return!s&&!i&&!o}function wi(t,{etype:e,level:n,form:r,join:s,pageInfo:i}){var o,a,c,l,u;if(!dr(r)&&(!i||!i["start-cursor"]))return[];const d=si(ui(t,e,n,(o=r.$)===null||o===void 0?void 0:o.where),s),f=li(it,e,n),p=(a=r.$)===null||a===void 0?void 0:a.fields,h=_i(t,{etype:e,pageInfo:i,form:r,dq:{where:d,find:f,fields:p}}),y=((c=r.$)===null||c===void 0?void 0:c.limit)||((l=r.$)===null||l===void 0?void 0:l.first)||((u=r.$)===null||u===void 0?void 0:u.last);if(y!=null){n>0&&console.warn("WARNING: Limits in child queries are only run client-side. Data returned from the server will not have a limit.");const v=Object.entries(h);return v.length<=y?h:Object.fromEntries(v.slice(0,y))}return h}function Ti(t,e){try{return wi(t,e)}catch(n){if(n instanceof we)return{};throw n}}function fr(t,e){const n=Ti(t,e);return fi(it,t,e,n)}function Si(t){const e={};for(const[n,r]of Object.entries(t))e[n]={startCursor:r["start-cursor"],endCursor:r["end-cursor"],hasNextPage:r["has-next-page?"],hasPreviousPage:r["has-previous-page?"]};return e}function pr({store:t,pageInfo:e,aggregate:n},r){const i={data:Object.keys(r).reduce(function(a,c){return n!=null&&n[c]||c==="$$ruleParams"||(a[c]=fr(t,{etype:c,form:r[c],level:0,pageInfo:e==null?void 0:e[c]})),a},{})};return e&&(i.pageInfo=Si(e)),n&&(i.aggregate=n),i}function Oi(){const e={__etype:1,__ops:1,create:1,update:1,link:1,unlink:1,delete:1,merge:1,ruleParams:1};return new Set(Object.keys(e))}const Ei=Oi();function jt(t,e,n){const r={__etype:t,__ops:n};return new Proxy(r,{get:(s,i)=>{if(i==="__ops")return n;if(i==="__etype")return t;if(Ei.has(i))return(o,a)=>jt(t,e,[...n,a?[i,t,e,o,a]:[i,t,e,o]])}})}function nt(t){return t.startsWith("lookup__")}function hr(t){const[e,n,...r]=t.split("__");return[n,JSON.parse(r.join("__"))]}function ki(t){return new Proxy({__etype:t},{get(e,n){if(n==="__etype")return t;const r=n;return nt(r)?jt(t,hr(r),[]):jt(t,r,[])}})}function yr(){return new Proxy({},{get(t,e){return ki(e)}})}yr();function Ai(t){return t.__ops}function Ci(t,e){const{attrIdMap:n,refSwapAttrIds:r}=t,s=[];for(const o of e){const a=n[o];if(a)s.push(a);else if(Array.isArray(o)&&o.length==2&&n[o[0]]){const[c,l]=o;s.push([n[c],l])}else s.push(o)}const[i]=e;if((i==="add-triple"||i==="retract-triple")&&r.has(e[2])){const o=s[1];s[1]=s[3],s[3]=o}return s}function R(t,e,n){return Object.values(t).find(r=>{const[s,i,o]=r["forward-identity"];return i===e&&o===n})}function pe(t,e,n){return Object.values(t).find(r=>{const s=r["reverse-identity"];if(!s)return!1;const[i,o,a]=s;return o===e&&a===n})}function Ii(t){if(Array.isArray(t))return t;const e=Object.entries(t);if(e.length!==1)throw new Error("lookup must be an object with a single unique attr and value.");return e[0]}function Mt(t,e,n){return n.indexOf(".")!==-1&&!R(t,e,n)}function Pt(t){const[e,n,...r]=t.split(".");if(r.length>0||n!=="id")throw new Error(`${t} is not a valid lookup attribute.`);return e}function ji(t,e,n){if(!Mt(t,e,n))return R(t,e,n);const r=Pt(n),s=R(t,e,r)||pe(t,e,r);if(s&&s["value-type"]!=="ref")throw new Error(`${n} does not reference a valid link attribute.`);return s}function $t(t){return typeof t=="string"&&!nt(t)?null:typeof t=="string"&&nt(t)?hr(t):Ii(t)}function B(t,e,n){const r=$t(n);if(r===null)return n;const[s,i]=r,o=ji(t,e,s);if(!o||!o["unique?"])throw new Error(`${s} is not a unique attribute.`);return[o.id,i]}function vr(t,e,n,r){const s=B(t,e,n);return Array.isArray(s)?[["add-triple",s,R(t,e,"id").id,s]].concat(r):r}function Mi({attrs:t},[e,n,r]){const s=Object.entries(r).flatMap(([i,o])=>{const a=Array.isArray(o)?o:[o],c=R(t,e,i),l=pe(t,e,i);return a.map(u=>c?["add-triple",B(t,e,n),c.id,B(t,c["reverse-identity"][1],u)]:["add-triple",B(t,l["forward-identity"][1],u),l.id,B(t,e,n)])});return vr(t,e,n,s)}function Pi({attrs:t},[e,n,r]){const s=Object.entries(r).flatMap(([i,o])=>{const a=Array.isArray(o)?o:[o],c=R(t,e,i),l=pe(t,e,i);return a.map(u=>c?["retract-triple",B(t,e,n),c.id,B(t,c["reverse-identity"][1],u)]:["retract-triple",B(t,l["forward-identity"][1],u),l.id,B(t,e,n)])});return vr(t,e,n,s)}function $i(t,e,n){if(Array.isArray(n)){const[r,s]=n;for(const i of t||[]){const o=i==null?void 0:i.aev.get(r);if(o){for(const[a,c,l]of K(o,2))if(l===s)return!0}}}else for(const r of t||[]){const s=r==null?void 0:r.eav.get(n);if(s){for(const i of s.keys())if(r.attrs[i]["forward-identity"][1]==e)return!0}}return!1}function br({stores:t,attrs:e},[n,r,s,i]){return(i==null?void 0:i.upsert)===!1?{mode:"update"}:(i==null?void 0:i.upsert)===!0?null:$i(t,n,r)?{mode:"update"}:null}function xi(t,e){const{stores:n,attrs:r}=t,[s,i,o,a]=e,c=Ht(o),l=B(r,s,i);return[["id",l]].concat(Object.entries(c)).map(([d,f])=>{const p=R(r,s,d);return p["checked-data-type"]==="date"&&t.useDateObjects&&(f=st(f)),["add-triple",l,p.id,f,{mode:"create"}]})}function Di(t,e){const{stores:n,attrs:r}=t,[s,i,o,a]=e,c=Ht(o),l=B(r,s,i),u=br(t,[s,l,o,a]);return[["id",l]].concat(Object.entries(c)).map(([f,p])=>{const h=R(r,s,f);return h["checked-data-type"]==="date"&&t.useDateObjects&&(p=st(p)),["add-triple",l,h.id,p,...u?[u]:[]]})}function Ri({attrs:t},[e,n]){return[["delete-entity",B(t,e,n),e]]}function Li(t,e){const{stores:n,attrs:r}=t,[s,i,o,a]=e,c=Ht(o),l=B(r,s,i),u=br(t,[s,l,o,a]),d=Object.entries(c).map(([p,h])=>{const y=R(r,s,p);return["deep-merge-triple",l,y.id,h,...u?[u]:[]]});return[["add-triple",l,R(r,s,"id").id,l,...u?[u]:[]]].concat(d)}function Ui({attrs:t},[e,n,r]){return[["rule-params",B(t,e,n),e,r]]}function Ni(t){const[e,n,r,s,i]=t;if(!s)return t;const o=Object.assign({},s);return delete o.id,[e,n,r,o,...i?[i]:[]]}function Fi(t,e){const[n,...r]=Ni(e);switch(n){case"merge":return Li(t,r);case"create":return xi(t,r);case"update":return Di(t,r);case"link":return Mi(t,r);case"unlink":return Pi(t,r);case"delete":return Ri(t,r);case"ruleParams":return Ui(t,r);default:throw new Error(`unsupported action ${n}`)}}function qi(t){switch(t){case"string":case"date":case"boolean":case"number":return t;default:return}}function Ki(t,e,n){var r,s;const i=(s=(r=t.entities[e])===null||r===void 0?void 0:r.attrs)===null||s===void 0?void 0:s[n];if(n==="id")return null;if(!i)throw new Error(`${e}.${n} does not exist in your schema`);const{unique:o,indexed:a}=i==null?void 0:i.config,c=qi(i==null?void 0:i.valueType);return{"index?":a,"unique?":o,"checked-data-type":c}}function Be(t,e,n,r){const s=t?Ki(t,e,n):null,i=$(),a=[$(),e,n];return Object.assign(Object.assign({id:i,"forward-identity":a,"value-type":"blob",cardinality:"one","unique?":!1,"index?":!1,isUnsynced:!0},s||{}),r||{})}function Bi(t,e,n){return Object.values(t.links).find(s=>s.forward.on===e&&s.forward.label===n||s.reverse.on===e&&s.reverse.label===n)}function zi(t,e,n){const r=Bi(t,e,n);if(!r)throw new Error(`Couldn't find the link ${e}.${n} in your schema`);const{forward:s,reverse:i}=r;return{"forward-identity":[$(),s.on,s.label],"reverse-identity":[$(),i.on,i.label],cardinality:s.has==="one"?"one":"many","unique?":i.has==="one","on-delete":s.onDelete,"on-delete-reverse":i.onDelete}}function yn(t,e,n,r){const s=t?zi(t,e,n):null,i=$(),o=[$(),e,n],a=[$(),n,e];return Object.assign(Object.assign({id:i,"forward-identity":o,"reverse-identity":a,"value-type":"ref",cardinality:"many","unique?":!1,"index?":!1,isUnsynced:!0},s||{}),r||{})}const Wi=new Set(["create","update","merge","link","unlink"]),Vi=new Set(["link","unlink"]),Hi=new Set(["create","update","merge"]),Qi=new Set(["link","unlink","create","update","merge","delete","ruleParams"]),xt={"unique?":!0,"index?":!0},Gi=Object.assign(Object.assign({},xt),{cardinality:"one"});function Ji(t){const e=[],[n,r,s,i]=t;if(!Qi.has(n))return e;const o=$t(s);if(o&&e.push({etype:r,lookupPair:o}),n==="link")for(const[a,c]of Object.entries(i)){const l=Array.isArray(c)?c:[c];for(const u of l){const d=$t(u);d&&e.push({etype:r,lookupPair:d,linkLabel:a})}}return e}function Yi({attrs:t,schema:e},n){var r,s;const[i,o,a]=[new Set,Object.assign({},t),[]];function c(d){o[d.id]=d,a.push(["add-attr",d]),i.add(d.id)}function l(d){d!=null&&d.isUnsynced&&!i.has(d.id)&&(a.push(["add-attr",d]),i.add(d.id))}function u(d,f){const p=R(o,d,f),h=pe(o,d,f);l(p),l(h),!p&&!h&&c(yn(e,d,f,Gi))}for(const d of n)for(const{etype:f,lookupPair:p,linkLabel:h}of Ji(d)){const y=p[0];if(h){u(f,h);const v=R(o,f,h),b=pe(o,f,h);l(v),l(b);const m=((r=v==null?void 0:v["reverse-identity"])===null||r===void 0?void 0:r[1])||((s=b==null?void 0:b["forward-identity"])===null||s===void 0?void 0:s[1])||h;if(Mt(o,m,y))u(m,Pt(y));else{const w=R(o,m,y);w||c(Be(e,m,y,xt)),l(w)}}else if(Mt(o,f,y))u(f,Pt(y));else{const v=R(o,f,y);v||c(Be(e,f,y,xt)),l(v)}}for(const d of n){const[f,p,h,y]=d;if(Wi.has(f)){const v=R(o,p,"id");l(v),v||c(Be(e,p,"id",{"unique?":!0}));for(const b of Object.keys(y)){const m=R(o,p,b);if(l(m),Hi.has(f)&&(m||c(Be(e,p,b,b==="id"?{"unique?":!0}:null))),Vi.has(f)){const w=pe(o,p,b);!m&&!w&&c(yn(e,p,b)),l(w)}}}}return[o,a]}function Zi(t,e){const r=(Array.isArray(e)?e:[e]).flatMap(c=>Ai(c)),[s,i]=Yi(t,r),o=Object.assign(Object.assign({},t),{attrs:s}),a=r.flatMap(c=>Fi(o,c));return[...i,...a]}var Z=function(t,e,n,r){function s(i){return i instanceof n?i:new n(function(o){o(i)})}return new(n||(n=Promise))(function(i,o){function a(u){try{l(r.next(u))}catch(d){o(d)}}function c(u){try{l(r.throw(u))}catch(d){o(d)}}function l(u){u.done?i(u.value):s(u.value).then(a,c)}l((r=r.apply(t,e||[])).next())})};function vn(t,e){typeof requestIdleCallback>"u"?t():requestIdleCallback(t,{timeout:e})}const Re="__meta";class Xi{constructor(e,n){}}class Dt{constructor(e){var n,r;this._subs=[],this._nextSave=null,this._nextGc=null,this._pendingSaveKeys=new Set,this._loadedKeys=new Set,this._version=0,this._meta={isLoading:!0,onLoadCbs:[],value:null,error:null,attempts:0},this._persister=e.persister,this._merge=e.merge,this.serialize=e.serialize,this.parse=e.parse,this._objectSize=e.objectSize,this._log=e.logger,this._saveThrottleMs=(n=e.saveThrottleMs)!==null&&n!==void 0?n:100,this._idleCallbackMaxWaitMs=(r=e.idleCallbackMaxWaitMs)!==null&&r!==void 0?r:1e3,this._gcOpts=e.gc,this.currentValue={},this._loadedKeys=new Set,this._loadingKeys={},this._initMeta(),e.preloadEntryCount&&this._preloadEntries(e.preloadEntryCount)}_initMeta(){return Z(this,void 0,void 0,function*(){var e,n,r;this._meta.loadingPromise&&(yield this._meta.loadingPromise);try{const s=this._persister.getItem(Re);this._meta.loadingPromise=s;const i=yield s;this._meta.isLoading=!1,this._meta.error=null,this._meta.loadingPromise=null,this._meta.attempts=0;const o=(n=(e=this._meta.value)===null||e===void 0?void 0:e.objects)!==null&&n!==void 0?n:{},a=i??{},c=(r=a.objects)!==null&&r!==void 0?r:{};this._meta.value=Object.assign(Object.assign({},a),{objects:Object.assign(Object.assign({},o),c)})}catch(s){this._meta.error=s,this._meta.attempts++,this._meta.loadingPromise=null}})}_getMeta(){return Z(this,void 0,void 0,function*(){return this._meta.value?this._meta.value:this._meta.loadingPromise?(yield this._meta.loadingPromise,this._meta.value):(this._initMeta(),yield this._meta.loadingPromise,this._meta.value)})}_refreshMeta(){return Z(this,void 0,void 0,function*(){return yield this._initMeta(),this._meta.value})}_preloadEntries(e){return Z(this,void 0,void 0,function*(){const n=yield this.waitForMetaToLoad();if(!n)return;const r=Object.entries(n.objects);r.sort(([s,i],[o,a])=>a.updatedAt-i.updatedAt);for(const[s]of r.slice(0,e))this._loadKey(s)})}_getFromStorage(e){return Z(this,void 0,void 0,function*(){try{const n=yield this._persister.getItem(e);return n&&this.parse(e,n)}catch(n){return console.error(`Unable to read from storage for key=${e}`,n),null}})}waitForKeyToLoad(e){return Z(this,void 0,void 0,function*(){return this._loadedKeys.has(e)?this.currentValue[e]:(yield this._loadingKeys[e]||this._loadKey(e),this.currentValue[e])})}waitForMetaToLoad(){return Z(this,void 0,void 0,function*(){return this._getMeta()})}unloadKey(e){this._loadedKeys.delete(e),delete this._loadingKeys[e],delete this.currentValue[e]}_loadKey(e){return Z(this,void 0,void 0,function*(){if(this._loadedKeys.has(e)||e in this._loadingKeys)return;const n=this._getFromStorage(e);this._loadingKeys[e]=n;const r=yield n;if(delete this._loadingKeys[e],this._loadedKeys.add(e),r){const s=this._merge(e,r,this.currentValue[e]);s&&(this.currentValue[e]=s)}this.onKeyLoaded&&this.onKeyLoaded(e)})}_writeToStorage(e){var n,r;const s=[],i=e==null?void 0:e.skipGc;if(this._meta.isLoading){const p=new Promise((h,y)=>{var v;setTimeout(()=>this._enqueuePersist(e?Object.assign(Object.assign({},e),{attempts:(e.attempts||0)+1}):{attempts:1}).then(h).catch(y),10+((v=e==null?void 0:e.attempts)!==null&&v!==void 0?v:0)*1e3)});return s.push(p),Promise.all(s).then(h=>h.reduce((y,v)=>y+v,0))}const o=this._meta.value;if(!o)return Promise.resolve(0);const a=[],c=[];for(const p of this._pendingSaveKeys)p in this.currentValue?c.push(p):(a.push(p),delete o.objects[p]);for(const p of a){const h=this._persister.removeItem(p);s.push(h.then(()=>1)),this._loadedKeys.delete(p),this._pendingSaveKeys.delete(p)}const l=[],u=[[Re,o]],d=(n=o.objects)!==null&&n!==void 0?n:{};o.objects=d;for(const p of c)if(this._loadedKeys.has(p)){const h=this.serialize(p,this.currentValue[p]);u.push([p,h]);const y=this._objectSize(h),v=(r=d[p])!==null&&r!==void 0?r:{createdAt:Date.now(),updatedAt:Date.now(),size:y};v.updatedAt=Date.now(),v.size=y,d[p]=v,this._pendingSaveKeys.delete(p)}else l.push(p);const f=this._persister.multiSet(u);s.push(f.then(()=>1));for(const p of l){const h=this._loadKey(p).then(()=>this._enqueuePersist(e));s.push(h)}return i||this.gc(),Promise.all(s).then(p=>p.reduce((h,y)=>h+y,0))}flush(){return Z(this,void 0,void 0,function*(){return this._nextSave?(clearTimeout(this._nextSave),this._nextSave=null,this._writeToStorage()):void 0})}_gc(){return Z(this,void 0,void 0,function*(){if(!this._gcOpts)return;const e=new Set(yield this._persister.getAllKeys());e.delete(Re);const n=new Set(Object.keys(this.currentValue));for(const f of Object.keys(this._loadingKeys))n.add(f);for(const f of this._loadedKeys)n.add(f);const r=yield this._refreshMeta();if(!r){this._log.info("Could not gc because we were not able to load meta");return}const s=[],i={gcOpts:this._gcOpts,keys:e,sacredKeys:n,removed:[],metaRemoved:[],removedMissingCount:0,removedOldCount:0,removedThresholdCount:0,removedSizeCount:0};for(const f of e)n.has(f)||f in r.objects||(this._log.info("Lost track of key in meta",f),s.push(this._persister.removeItem(f)),i.removed.push(f),i.removedMissingCount++);const o=Date.now();for(const[f,p]of Object.entries(r.objects))!n.has(f)&&p.updatedAt<o-this._gcOpts.maxAgeMs&&(s.push(this._persister.removeItem(f)),delete r.objects[f],i.removed.push(f),i.removedOldCount++);const a=Object.entries(r.objects);a.sort(([f,p],[h,y])=>p.updatedAt-y.updatedAt);const c=a.filter(([f])=>!n.has(f));if(a.length>this._gcOpts.maxEntries)for(const[f]of c.slice(0,a.length-this._gcOpts.maxEntries))s.push(this._persister.removeItem(f)),delete r.objects[f],i.removed.push(f),i.removedThresholdCount++;const l=Object.entries(r.objects);l.sort(([f,p],[h,y])=>p.updatedAt-y.updatedAt);const u=l.filter(([f])=>!n.has(f));let d=l.reduce((f,[p,h])=>f+h.size,0);for(;d>0&&d>this._gcOpts.maxSize&&u.length;){const[[f,p]]=u.splice(0,1);d-=p.size,s.push(this._persister.removeItem(f)),delete r.objects[f],i.removed.push(f),i.removedSizeCount++}for(const f of Object.keys(r.objects))!e.has(f)&&!n.has(f)&&delete r.objects[f];return(i.removed.length||i.metaRemoved.length)&&s.push(this._enqueuePersist({skipGc:!0})),this._log.info("Completed GC",i),yield Promise.all(s),i})}gc(){this._nextGc||(this._nextGc=setTimeout(()=>{vn(()=>{this._nextGc=null,this._gc()},30*1e3)},1e3*60+Math.random()*500))}_enqueuePersist(e){return new Promise((n,r)=>{if(this._nextSave){n(0);return}this._nextSave=setTimeout(()=>{vn(()=>{this._nextSave=null,this._writeToStorage(e).then(n).catch(r)},this._idleCallbackMaxWaitMs)},this._saveThrottleMs)})}version(){return this._version}updateInPlace(e){this._version++;const[n,r]=et(this.currentValue,e,{enablePatches:!0});for(const s of r){const i=s.path[0];i&&typeof i=="string"&&(this._pendingSaveKeys.add(i),this._loadedKeys.has(i)||this._loadKey(i))}this.currentValue=n,this._enqueuePersist();for(const s of this._subs)s(this.currentValue);return n}subscribe(e){return this._subs.push(e),e(this.currentValue),()=>{this._subs=this._subs.filter(n=>n!==e)}}}var re=function(t,e,n,r){function s(i){return i instanceof n?i:new n(function(o){o(i)})}return new(n||(n=Promise))(function(i,o){function a(u){try{l(r.next(u))}catch(d){o(d)}}function c(u){try{l(r.throw(u))}catch(d){o(d)}}function l(u){u.done?i(u.value):s(u.value).then(a,c)}l((r=r.apply(t,e||[])).next())})};const eo=6,to=["kv","querySubs","syncSubs"];function no(t){return function(n){console.error("Error in IndexedDB event",{source:t,event:n})}}function ro(t){return re(this,void 0,void 0,function*(){return new Promise(e=>{const n=indexedDB.open(t);n.onerror=r=>{e(null)},n.onsuccess=r=>{const i=r.target.result;e(i)},n.onupgradeneeded=r=>{var s;(s=r.target.transaction)===null||s===void 0||s.abort(),e(null)}})})}function so(t,e,n){return re(this,void 0,void 0,function*(){const r=typeof e=="string"?JSON.parse(e):e;if(!r)return;const s=new Set;return new Promise((i,o)=>{var a,c,l,u;const d={};for(const[h,y]of Object.entries(r)){const v=typeof y=="string"?JSON.parse(y):y;if(v.lastAccessed){const m={createdAt:v.lastAccessed,updatedAt:v.lastAccessed,size:(u=(l=(c=(a=v.result)===null||a===void 0?void 0:a.store)===null||c===void 0?void 0:c.triples)===null||l===void 0?void 0:l.length)!==null&&u!==void 0?u:0};d[h]=m}const b=n.put(v,h);s.add(b)}const f={objects:d},p=n.put(f,Re);s.add(p);for(const h of s)h.onsuccess=()=>{s.delete(h),s.size===0&&i()},h.onerror=y=>{o(y)}})})}function bn(t,e,n){return re(this,void 0,void 0,function*(){const r=n.put(e,t);return new Promise((s,i)=>{r.onsuccess=()=>s(),r.onerror=o=>i(o)})})}function io(t,e){return re(this,void 0,void 0,function*(){const n=yield ro(`instant_${t}_5`);if(!n)return;const r=yield new Promise((u,d)=>{const h=n.transaction(["kv"],"readonly").objectStore("kv").openCursor();h.onerror=v=>{d(v)};const y=[];h.onsuccess=()=>{const v=h.result;if(v){const b=v.key,m=v.value;y.push([b,m]),v.continue()}else u(y)},h.onerror=v=>{d(v)}}),s=e.transaction(["kv","querySubs"],"readwrite"),i=s.objectStore("kv"),o=s.objectStore("querySubs"),a=[],c={objects:{}};for(const[u,d]of r)switch(u){case"querySubs":{const f=so(u,d,o);a.push(f);break}default:{const f=bn(u,d,i);a.push(f);const p={createdAt:Date.now(),updatedAt:Date.now(),size:0};c.objects[u]=p;break}}const l=bn(Re,c,i);a.push(l),yield Promise.all(a),yield new Promise((u,d)=>{s.oncomplete=f=>u(f),s.onerror=f=>d(f),s.onabort=f=>d(f)})})}const mn=new Map;class mr extends Xi{constructor(e,n){super(e,n),this.dbName=`instant_${e}_${eo}`,this._storeName=n,this._appId=e,this._dbPromise=this._init()}_init(){return new Promise((e,n)=>{let r=!1;const s=indexedDB.open(this.dbName,1);s.onerror=i=>{n(i)},s.onsuccess=i=>{const a=i.target.result;if(r){const c=io(this._appId,a).catch(l=>{no("Error upgrading store from version 5 to 6.")(l)});mn.set(this.dbName,c),c.then(()=>e(a)).catch(()=>e(a))}else{const c=mn.get(this.dbName);c?c.then(()=>e(a)).catch(()=>e(a)):e(a)}},s.onupgradeneeded=i=>{r=!0,this._upgradeStore(i)}})}_upgradeStore(e){const r=e.target.result;for(const s of to)r.objectStoreNames.contains(s)||r.createObjectStore(s)}getItem(e){return re(this,void 0,void 0,function*(){const n=yield this._dbPromise;return new Promise((r,s)=>{const a=n.transaction([this._storeName],"readonly").objectStore(this._storeName).get(e);a.onerror=c=>{s(c)},a.onsuccess=c=>{a.result?r(a.result):r(null)}})})}setItem(e,n){return re(this,void 0,void 0,function*(){const r=yield this._dbPromise;return new Promise((s,i)=>{const c=r.transaction([this._storeName],"readwrite").objectStore(this._storeName).put(n,e);c.onerror=l=>{i(l)},c.onsuccess=l=>{s()}})})}multiSet(e){return re(this,void 0,void 0,function*(){const n=yield this._dbPromise;return new Promise((r,s)=>{const i=n.transaction([this._storeName],"readwrite"),o=i.objectStore(this._storeName),a=new Set;for(const[c,l]of e){const u=o.put(l,c);a.add(u)}for(const c of a)c.onerror=l=>{i.abort(),s(l)},c.onsuccess=l=>{a.delete(c),a.size===0&&r()}})})}removeItem(e){return re(this,void 0,void 0,function*(){const n=yield this._dbPromise;return new Promise((r,s)=>{const a=n.transaction([this._storeName],"readwrite").objectStore(this._storeName).delete(e);a.onerror=c=>{s(c)},a.onsuccess=c=>{r()}})})}getAllKeys(){return re(this,void 0,void 0,function*(){const e=yield this._dbPromise;return new Promise((n,r)=>{const o=e.transaction([this._storeName],"readonly").objectStore(this._storeName).getAllKeys();o.onerror=a=>{r(a)},o.onsuccess=a=>{n(o.result.filter(c=>typeof c=="string"))}})})}}var oo=function(t,e,n,r){function s(i){return i instanceof n?i:new n(function(o){o(i)})}return new(n||(n=Promise))(function(i,o){function a(u){try{l(r.next(u))}catch(d){o(d)}}function c(u){try{l(r.throw(u))}catch(d){o(d)}}function l(u){u.done?i(u.value):s(u.value).then(a,c)}l((r=r.apply(t,e||[])).next())})};class _r{static getIsOnline(){return oo(this,void 0,void 0,function*(){return navigator.onLine})}static listen(e){const n=()=>{e(!0)},r=()=>{e(!1)};return addEventListener("online",n),addEventListener("offline",r),()=>{removeEventListener("online",n),removeEventListener("offline",r)}}}class Ue extends Error{constructor(e,n){super(e),this.hint=n;const r=new.target.prototype;Object.setPrototypeOf&&Object.setPrototypeOf(this,r),Error.captureStackTrace&&Error.captureStackTrace(this,Ue),this.name="InstantError"}get[Symbol.toStringTag](){return"InstantError"}}var ao=function(t,e,n,r){function s(i){return i instanceof n?i:new n(function(o){o(i)})}return new(n||(n=Promise))(function(i,o){function a(u){try{l(r.next(u))}catch(d){o(d)}}function c(u){try{l(r.throw(u))}catch(d){o(d)}}function l(u){u.done?i(u.value):s(u.value).then(a,c)}l((r=r.apply(t,e||[])).next())})};class ot extends Ue{constructor(e){var n;const r=((n=e.body)===null||n===void 0?void 0:n.message)||`API Error (${e.status})`;super(r,e.body.hint);const s=new.target.prototype;Object.setPrototypeOf&&Object.setPrototypeOf(this,s),Error.captureStackTrace&&Error.captureStackTrace(this,ot),this.name="InstantAPIError",this.status=e.status,this.body=e.body}get[Symbol.toStringTag](){return"InstantAPIError"}}function Y(t,e){return ao(this,void 0,void 0,function*(){const n=yield fetch(t,e),r=yield n.json();return n.status===200?Promise.resolve(r):Promise.reject(new ot({status:n.status,body:r}))})}var Oe=function(t,e,n,r){function s(i){return i instanceof n?i:new n(function(o){o(i)})}return new(n||(n=Promise))(function(i,o){function a(u){try{l(r.next(u))}catch(d){o(d)}}function c(u){try{l(r.throw(u))}catch(d){o(d)}}function l(u){u.done?i(u.value):s(u.value).then(a,c)}l((r=r.apply(t,e||[])).next())})};function co({apiURI:t,appId:e,email:n}){return Y(`${t}/runtime/auth/send_magic_code`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":e,email:n})})}function uo(t){return Oe(this,arguments,void 0,function*({apiURI:e,appId:n,email:r,code:s,refreshToken:i}){return yield Y(`${e}/runtime/auth/verify_magic_code`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(Object.assign({"app-id":n,email:r,code:s},i?{"refresh-token":i}:{}))})})}function lo(t){return Oe(this,arguments,void 0,function*({apiURI:e,appId:n,refreshToken:r}){return yield Y(`${e}/runtime/auth/verify_refresh_token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":n,"refresh-token":r})})})}function fo(t){return Oe(this,arguments,void 0,function*({apiURI:e,appId:n}){return yield Y(`${e}/runtime/auth/sign_in_guest`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":n})})})}function _n(t){return Oe(this,arguments,void 0,function*({apiURI:e,appId:n,code:r,codeVerifier:s,refreshToken:i}){return yield Y(`${e}/runtime/oauth/token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:n,code:r,code_verifier:s,refresh_token:i})})})}function po(t){return Oe(this,arguments,void 0,function*({apiURI:e,appId:n,nonce:r,idToken:s,clientName:i,refreshToken:o}){return yield Y(`${e}/runtime/oauth/id_token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:n,nonce:r,id_token:s,client_name:i,refresh_token:o})})})}function ho(t){return Oe(this,arguments,void 0,function*({apiURI:e,appId:n,refreshToken:r}){return yield Y(`${e}/runtime/signout`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:n,refresh_token:r})})})}var qe=function(t,e,n,r){function s(i){return i instanceof n?i:new n(function(o){o(i)})}return new(n||(n=Promise))(function(i,o){function a(u){try{l(r.next(u))}catch(d){o(d)}}function c(u){try{l(r.throw(u))}catch(d){o(d)}}function l(u){u.done?i(u.value):s(u.value).then(a,c)}l((r=r.apply(t,e||[])).next())})};function yo(t){return qe(this,arguments,void 0,function*({apiURI:e,appId:n,path:r,file:s,refreshToken:i,contentType:o,contentDisposition:a}){const c={app_id:n,path:r,authorization:`Bearer ${i}`,"content-type":o||s.type};return a&&(c["content-disposition"]=a),yield Y(`${e}/storage/upload`,{method:"PUT",headers:c,body:s})})}function vo(t){return qe(this,arguments,void 0,function*({apiURI:e,appId:n,path:r,refreshToken:s}){const{data:i}=yield Y(`${e}/storage/files?app_id=${n}&filename=${encodeURIComponent(r)}`,{method:"DELETE",headers:{"content-type":"application/json",authorization:`Bearer ${s}`}});return i})}function bo(t){return qe(this,arguments,void 0,function*({apiURI:e,appId:n,fileName:r,refreshToken:s,metadata:i={}}){const{data:o}=yield Y(`${e}/storage/signed-upload-url`,{method:"POST",headers:{"content-type":"application/json",authorization:`Bearer ${s}`},body:JSON.stringify({app_id:n,filename:r})});return o})}function mo(t,e){return qe(this,void 0,void 0,function*(){return(yield fetch(t,{method:"PUT",body:e,headers:{"Content-Type":e.type}})).ok})}function _o(t){return qe(this,arguments,void 0,function*({apiURI:e,appId:n,path:r,refreshToken:s}){const{data:i}=yield Y(`${e}/storage/signed-download-url?app_id=${n}&filename=${encodeURIComponent(r)}`,{method:"GET",headers:{"content-type":"application/json",authorization:`Bearer ${s}`}});return i})}let Zt=!1,gr=!1,wr=!1;typeof window<"u"&&typeof window.localStorage<"u"&&(Zt=!!window.localStorage.getItem("devBackend"),gr=!!window.localStorage.getItem("__instantLogging"),wr=!!window.localStorage.getItem("__devtoolLocalDash"));function gn(t,e){if(!e)return t;const n={};return e.forEach(r=>{n[r]=t[r]}),n}function go(t,e,n){var r,s;const i={peers:{}};if(e&&"user"in e?e.user:!0){const a=gn((r=t.user)!==null&&r!==void 0?r:{},e==null?void 0:e.keys);i.user=Object.assign(Object.assign({},a),{peerId:n})}for(const a of Object.keys((s=t.peers)!==null&&s!==void 0?s:{})){const c=(e==null?void 0:e.peers)===void 0,l=Array.isArray(e==null?void 0:e.peers)&&(e==null?void 0:e.peers.includes(a));if(c||l){const u=gn(t.peers[a],e==null?void 0:e.keys);i.peers[a]=Object.assign(Object.assign({},u),{peerId:a})}}return i}function wo(t,e){if(t.isLoading!==e.isLoading||t.error!==e.error||(t.user||e.user)&&(!t.user||!e.user||!sn(t.user,e.user))||!Qn(t.peers,e.peers))return!0;for(const r of Object.keys(t.peers))if(!sn(t.peers[r],e.peers[r]))return!0;return!1}class wn{constructor(){this.promise=new Promise((e,n)=>{this._resolve=e,this._reject=n})}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}function Tr(t,e=[]){t.forEach(n=>{const{data:r}=n,{"datalog-result":s}=r,{"join-rows":i}=s;for(const o of i)for(const a of o)e.push(a);Tr(n["child-nodes"],e)})}function Tn(t){const e=[];return Tr(t,e),e}function Sn(t){return Object.values(t.links).reduce((e,n)=>{var r,s,i,o;return(r=e[i=n.forward.on])!==null&&r!==void 0||(e[i]={}),e[n.forward.on][n.forward.label]={isForward:!0,isSingular:n.forward.has==="one",link:n},(s=e[o=n.reverse.on])!==null&&s!==void 0||(e[o]={}),e[n.reverse.on][n.reverse.label]={isForward:!1,isSingular:n.reverse.has==="one",link:n},e},{})}const Sr="v0.22.84";function To(t,e){return{info:t?(...n)=>console.info(...n,e()):()=>{},debug:t?(...n)=>console.debug(...n,e()):()=>{},error:t?(...n)=>console.error(...n,e()):()=>{}}}class F{constructor(e,n,r,s={indexed:!1,unique:!1}){this.valueType=e,this.required=n,this.isIndexed=r,this.config=s,this.metadata={}}clientRequired(){return new F(this.valueType,!1,this.isIndexed,this.config)}optional(){return new F(this.valueType,!1,this.isIndexed,this.config)}unique(){return new F(this.valueType,this.required,this.isIndexed,Object.assign(Object.assign({},this.config),{unique:!0}))}indexed(){return new F(this.valueType,this.required,!0,Object.assign(Object.assign({},this.config),{indexed:!0}))}}class at{constructor(e,n){this.attrs=e,this.links=n}asType(){return new at(this.attrs,this.links)}}class ct{constructor(e,n,r){this.entities=e,this.links=n,this.rooms=r}withRoomSchema(){return new ct(this.entities,this.links,{})}}class A extends Error{constructor(e,n){const r=n?`At path '${n}': ${e}`:e;super(r),this.name="QueryValidationError"}}const On=["where","order","limit","last","first","offset","after","before","fields","aggregate"],So=t=>t.valueType||"unknown",Or=(t,e,n=!1)=>{if(n||t==null)return!0;switch(e){case"string":return typeof t=="string";case"number":return typeof t=="number"&&!isNaN(t);case"boolean":return typeof t=="boolean";case"date":return t instanceof Date||typeof t=="string"||typeof t=="number";default:return!0}},Oo=(t,e,n,r,s,i,o)=>{const a=i.valueType==="json",c=(l,u,d)=>{if(!Or(d,u,a))throw new A(`Invalid value for operator '${l}' on attribute '${r}' in entity '${s}'. Expected ${u}, but received: ${typeof d}`,o)};switch(t){case"in":case"$in":if(!Array.isArray(e))throw new A(`Operator '${t}' for attribute '${r}' in entity '${s}' must be an array, but received: ${typeof e}`,o);for(const l of e)c(t,n,l);break;case"$not":case"$ne":case"$gt":case"$lt":case"$gte":case"$lte":c(t,n,e);break;case"$like":case"$ilike":if(c(t,"string",e),t==="$ilike"&&!i.isIndexed)throw new A(`Operator '${t}' can only be used with indexed attributes, but '${r}' in entity '${s}' is not indexed`,o);break;case"$isNull":c(t,"boolean",e);break;default:throw new A(`Unknown operator '${t}' for attribute '${r}' in entity '${s}'`,o)}},me=(t,e,n,r,s)=>{const i=So(n),o=n.valueType==="json";if(typeof t=="object"&&t!==null&&!Array.isArray(t)){if(o)return;const c=t;for(const[l,u]of Object.entries(c))Oo(l,u,i,e,r,n,`${s}.${l}`)}else if(!Or(t,i,o))throw new A(`Invalid value for attribute '${e}' in entity '${r}'. Expected ${i}, but received: ${typeof t}`,s)},Eo=(t,e,n,r,s)=>{const i=t.split(".");if(i.length<2)throw new A(`Invalid dot notation path '${t}'. Must contain at least one dot.`,s);let o=n;for(let u=0;u<i.length-1;u++){const d=i[u],f=r.entities[o];if(!f)throw new A(`Entity '${o}' does not exist in schema while traversing dot notation path '${t}'.`,s);const p=f.links[d];if(!p){const h=Object.keys(f.links);throw new A(`Link '${d}' does not exist on entity '${o}' in dot notation path '${t}'. Available links: ${h.length>0?h.join(", "):"none"}`,s)}o=p.entityName}const a=i[i.length-1],c=r.entities[o];if(!c)throw new A(`Target entity '${o}' does not exist in schema for dot notation path '${t}'.`,s);if(a==="id"){if(typeof e=="string"&&!ge(e))throw new A(`Invalid value for id field in entity '${o}'. Expected a UUID, but received: ${e}`,s);me(e,t,new F("string",!1,!0),n,s);return}const l=c.attrs[a];if(Object.keys(c.links).includes(a)){if(typeof e=="string"&&!ge(e))throw new A(`Invalid value for link '${a}' in entity '${o}'. Expected a UUID, but received: ${e}`,s);me(e,t,new F("string",!1,!0),n,s);return}if(!l){const u=Object.keys(c.attrs);throw new A(`Attribute '${a}' does not exist on entity '${o}' in dot notation path '${t}'. Available attributes: ${u.length>0?u.join(", ")+", id":"id"}`,s)}me(e,t,l,n,s)},Er=(t,e,n,r)=>{for(const[s,i]of Object.entries(t)){if(s==="or"||s==="and"){if(Array.isArray(i))for(const l of i)typeof l=="object"&&l!==null&&Er(l,e,n,`${r}.${s}[${l}]`);continue}if(s==="id"){me(i,"id",new F("string",!1,!0),e,`${r}.id`);continue}if(s.includes(".")){Eo(s,i,e,n,`${r}.${s}`);continue}const o=n.entities[e];if(!o)continue;const a=o.attrs[s],c=o.links[s];if(!a&&!c){const l=Object.keys(o.attrs),u=Object.keys(o.links);throw new A(`Attribute or link '${s}' does not exist on entity '${e}'. Available attributes: ${l.length>0?l.join(", "):"none"}. Available links: ${u.length>0?u.join(", "):"none"}`,`${r}.${s}`)}if(a)me(i,s,a,e,`${r}.${s}`);else if(c){if(typeof i=="string"&&!ge(i))throw new A(`Invalid value for link '${s}' in entity '${e}'. Expected a UUID, but received: ${i}`,`${r}.${s}`);const l=new F("string",!1,!0);me(i,s,l,e,`${r}.${s}`)}}},ko=(t,e,n,r,s=0)=>{for(const o of Object.keys(t))if(!On.includes(o))throw new A(`Invalid query parameter '${o}' in $ object. Valid parameters are: ${On.join(", ")}. Found: ${o}`,r);const i=["offset","before","after","first","last"];for(const o of i)if(t[o]!==void 0&&s>0)throw new A(`'${o}' can only be used on top-level namespaces. It cannot be used in nested queries.`,r);if(t.where&&n){if(typeof t.where!="object"||t.where===null)throw new A(`'where' clause must be an object in entity '${e}', but received: ${typeof t.where}`,r?`${r}.where`:void 0);Er(t.where,e,n,r?`${r}.where`:"where")}},kr=(t,e,n,r,s=0)=>{var i;if(!t||typeof t!="object")throw new A(`Query part for entity '${e}' must be an object, but received: ${typeof t}`,r);for(const o of Object.keys(t))if(o!=="$"){if(n&&!(o in n.entities[e].links)){const c=Object.keys(n.entities[e].links);throw new A(`Link '${o}' does not exist on entity '${e}'. Available links: ${c.length>0?c.join(", "):"none"}`,`${r}.${o}`)}const a=t[o];if(typeof a=="object"&&a!==null){const c=(i=n==null?void 0:n.entities[e].links[o])===null||i===void 0?void 0:i.entityName;c&&kr(a,c,n,`${r}.${o}`,s+1)}}else{const a=t[o];if(typeof a!="object"||a===null)throw new A(`Query parameter '$' must be an object in entity '${e}', but received: ${typeof a}`,`${r}.$`);ko(a,e,n,`${r}.$`,s)}},En=(t,e)=>{if(typeof t!="object"||t===null)throw new A(`Query must be an object, but received: ${typeof t}${t===null?" (null)":""}`);if(Array.isArray(t))throw new A(`Query must be an object, but received: ${typeof t}`);const n=t;for(const r of Object.keys(n)){if(Array.isArray(t[r]))throw new A(`Query keys must be strings, but found key of type: ${typeof r}`,r);if(typeof r!="string")throw new A(`Query keys must be strings, but found key of type: ${typeof r}`,r);if(r!=="$$ruleParams"){if(e&&!e.entities[r]){const s=Object.keys(e.entities);throw new A(`Entity '${r}' does not exist in schema. Available entities: ${s.length>0?s.join(", "):"none"}`,r)}kr(n[r],r,e,r,0)}}},kn=t=>typeof t!="string"?!1:nt(t)?!0:ge(t);class V extends Error{constructor(e){super(e),this.name="TransactionValidationError"}}const Ar=t=>t.length>0?t.join(", "):"none",Ao=(t,e)=>new V(`Entity '${t}' does not exist in schema. Available entities: ${Ar(e)}`),An={string:t=>typeof t=="string",number:t=>typeof t=="number"&&!isNaN(t),boolean:t=>typeof t=="boolean",date:t=>t instanceof Date||typeof t=="string"||typeof t=="number",json:()=>!0},Co=(t,e)=>{var n,r;return t==null?!0:(r=(n=An[e.valueType])===null||n===void 0?void 0:n.call(An,t))!==null&&r!==void 0?r:!1},Cr=(t,e)=>{const n=e.entities[t];if(!n)throw Ao(t,Object.keys(e.entities));return n},dt=(t,e,n)=>{const r=Cr(t,n);if(typeof e!="object"||e===null)throw new V(`Arguments for data operation on entity '${t}' must be an object, but received: ${typeof e}`);for(const[s,i]of Object.entries(e)){if(s==="id")continue;const o=r.attrs[s];if(o&&!Co(i,o))throw new V(`Invalid value for attribute '${s}' in entity '${t}'. Expected ${o.valueType}, but received: ${typeof i}`)}},Cn=(t,e,n)=>{const r=Cr(t,n);if(typeof e!="object"||e===null)throw new V(`Arguments for link operation on entity '${t}' must be an object, but received: ${typeof e}`);for(const[s,i]of Object.entries(e)){if(!r.links[s]){const a=Object.keys(r.links);throw new V(`Link '${s}' does not exist on entity '${t}'. Available links: ${Ar(a)}`)}if(i!=null){if(Array.isArray(i)){for(const a of i)if(!kn(a))throw new V(`Invalid entity ID in link '${s}' for entity '${t}'. Expected a UUID or a lookup, but received: ${a}`)}else if(!kn(i))throw new V(`Invalid UUID in link '${s}' for entity '${t}'. Expected a UUID, but received: ${i}`)}}},Io={create:dt,update:dt,merge:dt,link:Cn,unlink:Cn,delete:()=>{}},jo=(t,e)=>{if(!e)return;const[n,r,s,i]=t;if(!Array.isArray(s)&&!ge(s))throw new V(`Invalid id for entity '${r}'. Expected a UUID, but received: ${s}`);if(typeof r!="string")throw new V(`Entity name must be a string, but received: ${typeof r}`);const o=Io[n];o&&i!==void 0&&o(r,i,e)},Mo=(t,e)=>{const n=Array.isArray(t)?t:[t];for(const r of n){if(!r||typeof r!="object")throw new V(`Transaction chunk must be an object, but received: ${typeof r}`);if(!Array.isArray(r.__ops))throw new V(`Transaction chunk must have __ops array, but received: ${typeof r.__ops}`);for(const s of r.__ops){if(!Array.isArray(s))throw new V(`Transaction operation must be an array, but received: ${typeof s}`);jo(s,e)}}};var In=function(t,e,n,r){function s(i){return i instanceof n?i:new n(function(o){o(i)})}return new(n||(n=Promise))(function(i,o){function a(u){try{l(r.next(u))}catch(d){o(d)}}function c(u){try{l(r.throw(u))}catch(d){o(d)}}function l(u){u.done?i(u.value):s(u.value).then(a,c)}l((r=r.apply(t,e||[])).next())})};let Ir=0;class jn{constructor(e){this.type="ws",this.id=`${this.type}_${Ir++}`,this.conn=new WebSocket(e),this.conn.onopen=n=>{this.onopen&&this.onopen({target:this})},this.conn.onmessage=n=>{this.onmessage&&this.onmessage({target:this,message:JSON.parse(n.data.toString())})},this.conn.onclose=n=>{this.onclose&&this.onclose({target:this})},this.conn.onerror=n=>{this.onerror&&this.onerror({target:this})}}close(){this.conn.close()}isOpen(){var e;return this.conn.readyState===((e=WebSocket.OPEN)!==null&&e!==void 0?e:1)}isConnecting(){var e;return this.conn.readyState===((e=WebSocket.CONNECTING)!==null&&e!==void 0?e:0)}send(e){return this.conn.send(JSON.stringify(e))}}class Po{constructor(e,n){this.type="sse",this.initParams=null,this.sendQueue=[],this.closeFired=!1,this.sseInitTimeout=void 0,this.id=`${this.type}_${Ir++}`,this.url=n,this.ES=e,this.conn=new e(n),this.sseInitTimeout=setTimeout(()=>{this.initParams||this.handleError()},1e4),this.conn.onmessage=r=>{const s=JSON.parse(r.data);if(Array.isArray(s))for(const i of s)this.handleMessage(i);else this.handleMessage(s)},this.conn.onerror=r=>{this.handleError()}}handleMessage(e){if(e.op==="sse-init"){this.initParams={machineId:e["machine-id"],sessionId:e["session-id"],sseToken:e["sse-token"]},this.onopen&&this.onopen({target:this}),clearTimeout(this.sseInitTimeout);return}this.onmessage&&this.onmessage({target:this,message:e})}handleError(){try{this.onerror&&this.onerror({target:this})}finally{this.handleClose()}}handleClose(){this.conn.close(),this.onclose&&!this.closeFired&&(this.closeFired=!0,this.onclose({target:this}))}postMessages(e){return In(this,void 0,void 0,function*(){var n,r,s;try{(yield fetch(this.url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({machine_id:(n=this.initParams)===null||n===void 0?void 0:n.machineId,session_id:(r=this.initParams)===null||r===void 0?void 0:r.sessionId,sse_token:(s=this.initParams)===null||s===void 0?void 0:s.sseToken,messages:e})})).ok||this.handleError()}catch{this.handleError()}})}flushQueue(){return In(this,void 0,void 0,function*(){if(this.sendPromise||!this.sendQueue.length)return;const e=this.sendQueue;this.sendQueue=[];const n=this.postMessages(e);this.sendPromise=n,n.then(()=>{this.sendPromise=null,this.flushQueue()})})}send(e){if(!this.isOpen()||!this.initParams)throw this.isConnecting()?new Error("Failed to execute 'send' on 'EventSource': Still in CONNECTING state."):this.conn.readyState===this.ES.CLOSED?new Error("EventSource is already in CLOSING or CLOSED state."):new Error("EventSource is in invalid state.");this.sendQueue.push(e),this.flushQueue()}isOpen(){return this.conn.readyState===this.ES.OPEN&&this.initParams!==null}isConnecting(){return this.conn.readyState===this.ES.CONNECTING||this.conn.readyState===this.ES.OPEN&&this.initParams===null}close(){this.handleClose()}}var Mn=function(t,e,n,r){function s(i){return i instanceof n?i:new n(function(o){o(i)})}return new(n||(n=Promise))(function(i,o){function a(u){try{l(r.next(u))}catch(d){o(d)}}function c(u){try{l(r.throw(u))}catch(d){o(d)}}function l(u){u.done?i(u.value):s(u.value).then(a,c)}l((r=r.apply(t,e||[])).next())})};function $o(t,e){const n=t.values;if(n)for(const r of n.entities||[])r.store.useDateObjects=e,r.store.attrs=n.attrs,r.store=er(r.store);return t}function xo(t,e){var n,r;if(!((n=e.values)===null||n===void 0)&&n.entities){const s=[];for(const i of(r=e.values)===null||r===void 0?void 0:r.entities){const o=Xn(i.store);delete o.attrs,s.push(Object.assign(Object.assign({},i),{store:o}))}return Object.assign(Object.assign({},e),{values:Object.assign(Object.assign({},e.values),{entities:s})})}else return e}function Do(t,e,n){var r,s;const i=(r=e==null?void 0:e.state)===null||r===void 0?void 0:r.txId,o=(s=n==null?void 0:n.state)===null||s===void 0?void 0:s.txId;return i&&(!o||i>o)?e:o&&(!i||o>i)?n:e||n}function ft(t,e){return pr({store:e,pageInfo:null,aggregate:null},t.query).data[t.table][0]}function Pn(t,e,n){var r;const s=(r=ce(e,t.table,"id"))===null||r===void 0?void 0:r.id;if(!s)return-1;const i=Se(e.eav,[n,s,n]);return i?i[3]:-1}function $n(t,e){for(const{action:n,triple:r}of e)switch(n){case"added":rr(t,r);break;case"removed":tr(t,r);break}}function Ro(t,e){var n,r,s,i;const o={};for(const{action:a,triple:c}of e){const[l,u,d]=c,f=(r=(n=t.attrs[u])===null||n===void 0?void 0:n["forward-identity"])===null||r===void 0?void 0:r[2];if(!f)continue;const p=(s=o[l])!==null&&s!==void 0?s:{};o[l]=p;const h=(i=p[f])!==null&&i!==void 0?i:{};switch(p[f]=h,a){case"added":h.newValue=d;break;case"removed":h.oldValue===void 0&&(h.oldValue=d);break}}for(const a of Object.keys(o)){const{oldValue:c,newValue:l}=o[a];c===l&&delete o[a]}return o}function ze(t,e){return{[t.table]:e.map(n=>n.entity)}}function Lo(t,e){var n;if(t.orderFieldType)return t.orderFieldType;const r=t.orderField==="serverCreatedAt"?"number":(n=ce(e([]),t.table,t.orderField))===null||n===void 0?void 0:n["checked-data-type"];return t.orderFieldType=r,r}function Uo(t,e,n){const r=e;if(t.orderField==="serverCreatedAt"){n.sort(t.orderDirection==="asc"?function(o,a){return $e(o.entity.id,o.serverCreatedAt,a.entity.id,a.serverCreatedAt,r)}:function(o,a){return $e(a.entity.id,a.serverCreatedAt,o.entity.id,o.serverCreatedAt,r)});return}const s=t.orderField;n.sort(t.orderDirection==="asc"?function(o,a){return $e(o.entity.id,o.entity[s],a.entity.id,a.entity[s],r)}:function(o,a){return $e(a.entity.id,a.entity[s],o.entity.id,o.entity[s],r)})}var le;(function(t){t.InitialSyncBatch="InitialSyncBatch",t.InitialSyncComplete="InitialSyncComplete",t.LoadFromStorage="LoadFromStorage",t.SyncTransaction="SyncTransaction",t.Error="Error"})(le||(le={}));class No{constructor(e,n,r,s,i){this.callbacks={},this.idToHash={},this.trySend=e,this.config=r,this.log=s,this.createStore=i,this.subs=new Dt({persister:n,merge:Do,serialize:xo,parse:(o,a)=>$o(a,this.config.useDateObjects),objectSize:o=>{var a;return((a=o.values)===null||a===void 0?void 0:a.entities.length)||0},logger:s,gc:{maxAgeMs:1e3*60*60*24*7*52,maxEntries:1e3,maxSize:1e6}})}beforeUnload(){this.subs.flush()}subscribe(e,n){const r=U(e);return this.callbacks[r]=this.callbacks[r]||[],this.callbacks[r].push(n),this.initSubscription(e,r,n),s=>{this.unsubscribe(r,n,s==null?void 0:s.keepSubscription)}}unsubscribe(e,n,r){const s=(this.callbacks[e]||[]).filter(i=>i!==n);if(this.callbacks[e]=s,!s.length){delete this.callbacks[e];const i=this.subs.currentValue[e];i!=null&&i.state&&this.clearSubscriptionData(i.state.subscriptionId,!!r),r||this.subs.updateInPlace(o=>{delete o[e]})}}sendStart(e){this.trySend($(),{op:"start-sync",q:e})}sendResync(e,n,r){this.idToHash[n.subscriptionId]=e.hash,this.trySend(n.subscriptionId,{op:"resync-table","subscription-id":n.subscriptionId,"tx-id":r,token:n.token})}sendRemove(e,n){this.trySend($(),{op:"remove-sync","subscription-id":e.subscriptionId,"keep-subscription":n})}initSubscription(e,n,r){return Mn(this,void 0,void 0,function*(){var s,i,o,a;yield this.subs.waitForKeyToLoad(n);const c=this.subs.currentValue[n];if(c&&c.state&&c.state.txId){this.sendResync(c,c.state,c.state.txId),!((s=c.values)===null||s===void 0)&&s.entities&&r&&r({type:le.LoadFromStorage,data:ze(c,(i=c.values)===null||i===void 0?void 0:i.entities)});return}const l=Object.keys(e)[0],u=((a=(o=e[l])===null||o===void 0?void 0:o.$)===null||a===void 0?void 0:a.order)||{serverCreatedAt:"asc"},[d,f]=Object.entries(u)[0];this.subs.updateInPlace(p=>{p[n]={query:e,hash:n,table:l,orderDirection:f,orderField:d,createdAt:Date.now(),updatedAt:Date.now()}}),this.sendStart(e)})}flushPending(){return Mn(this,void 0,void 0,function*(){for(const e of Object.keys(this.callbacks)){yield this.subs.waitForKeyToLoad(e);const n=this.subs.currentValue[e];n?yield this.initSubscription(n.query,n.hash):this.log.error("Missing sub for hash in flushPending",e)}})}onStartSyncOk(e){const n=e["subscription-id"],r=e.q,s=U(r);this.idToHash[n]=s,this.subs.updateInPlace(i=>{const o=i[s];if(!o)return this.log.error("Missing sub for hash",s,"subscription-id",n,"query",r),i;o.state={subscriptionId:n,token:e.token}})}notifyCbs(e,n){for(const r of this.callbacks[e]||[])r(n)}onSyncLoadBatch(e){var n;const r=e["subscription-id"],s=e["join-rows"],i=this.idToHash[r];if(!i){this.log.error("Missing hash for subscription",e);return}const o=[],a=this.subs.currentValue[i];if(!a){this.log.error("Missing sub for hash",i,e);return}const c=(n=a.values)!==null&&n!==void 0?n:{entities:[],attrs:this.createStore([]).attrs};a.values=c;const l=c.entities;for(const u of s){const d=this.createStore(u);c.attrs=d.attrs;const f=ft(a,d);l.push({store:d,entity:f,serverCreatedAt:Pn(a,d,f.id)}),o.push(f)}this.subs.updateInPlace(u=>{u[i]=a,u[i].updatedAt=Date.now()}),a.values&&this.notifyCbs(i,{type:le.InitialSyncBatch,data:ze(a,a.values.entities),batch:o})}onSyncInitFinish(e){var n;const r=e["subscription-id"],s=this.idToHash[r];if(!s){this.log.error("Missing hash for subscription",e);return}this.subs.updateInPlace(o=>{const a=o[s];if(!a){this.log.error("Missing sub for hash",s,e);return}const c=a.state;if(!c)return this.log.error("Sub never set init, missing result",a,e),o;c.txId=e["tx-id"],a.updatedAt=Date.now()});const i=this.subs.currentValue[s];i&&this.notifyCbs(s,{type:le.InitialSyncComplete,data:ze(i,((n=i.values)===null||n===void 0?void 0:n.entities)||[])})}onSyncUpdateTriples(e){var n,r,s;const i=e["subscription-id"],o=this.idToHash[i];if(!o){this.log.error("Missing hash for subscription",e);return}const a=this.subs.currentValue[o];if(!a){this.log.error("Missing sub for hash",o,e);return}const c=a.state;if(!c){this.log.error("Missing state for sub",a,e);return}for(const l of e.txes){if(c.txId&&c.txId>=l["tx-id"])continue;c.txId=l["tx-id"];const u=[],d={};for(const m of l.changes){const w=(n=d[m.triple[0]])!==null&&n!==void 0?n:[];d[m.triple[0]]=w,w.push(m)}const f=(r=a.values)!==null&&r!==void 0?r:{entities:[],attrs:this.createStore([]).attrs},p=f.entities;a.values=f;const h=[];e:for(const[m,w]of Object.entries(d))for(let T=0;T<p.length;T++){const g=p[T];if(bs(g.store,m)){$n(g.store,w);const E=ft(a,g.store),k=Ro(g.store,w)[m];E?(h.push({oldEntity:g.entity,newEntity:E,changedFields:k||{}}),g.entity=E):u.push(T),delete d[m];continue e}}const y=[];for(const[m,w]of Object.entries(d)){const T=this.createStore([]);f.attrs=T.attrs,$n(T,w);const g=ft(a,T);if(!g){this.log.error("No entity found after applying change",{sub:a,changes:w,store:T});continue}p.push({store:T,entity:g,serverCreatedAt:Pn(a,T,g.id)}),y.push(g)}const v=[];for(const m of u.sort().reverse())v.push(p[m].entity),p.splice(m,1);const b=Lo(a,this.createStore);Uo(a,b,p),this.notifyCbs(o,{type:le.SyncTransaction,data:ze(a,(s=a.values)===null||s===void 0?void 0:s.entities),added:y,removed:v,updated:h})}this.subs.updateInPlace(l=>{l[o]=a,l[o].updatedAt=Date.now()})}clearSubscriptionData(e,n){const r=this.idToHash[e];if(r){delete this.idToHash[e];const s=this.subs.currentValue[r];if(s.state&&this.sendRemove(s.state,n),n?this.subs.unloadKey(r):this.subs.updateInPlace(i=>{delete i[r]}),s)return s}}onStartSyncError(e){const n=U(e["original-event"].q),r={message:e.message||"Uh-oh, something went wrong. Ping Joe & Stopa.",status:e.status,type:e.type,hint:e.hint},s=Object.keys(e["original-event"].q)[0];this.notifyCbs(n,{type:le.Error,data:{[s]:[]},error:r})}onResyncError(e){const n=e["original-event"]["subscription-id"],r=this.clearSubscriptionData(n,!1);r&&this.initSubscription(r.query,r.hash)}}var P=function(t,e,n,r){function s(i){return i instanceof n?i:new n(function(o){o(i)})}return new(n||(n=Promise))(function(i,o){function a(u){try{l(r.next(u))}catch(d){o(d)}}function c(u){try{l(r.throw(u))}catch(d){o(d)}}function l(u){u.done?i(u.value):s(u.value).then(a,c)}l((r=r.apply(t,e||[])).next())})},Fo=function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,r=Object.getOwnPropertySymbols(t);s<r.length;s++)e.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(t,r[s])&&(n[r[s]]=t[r[s]]);return n};const te={CONNECTING:"connecting",OPENED:"opened",AUTHENTICATED:"authenticated",CLOSED:"closed",ERRORED:"errored"},qo=3e4,Ko=3e4,Bo=200,zo={apiURI:"https://api.instantdb.com",websocketURI:"wss://api.instantdb.com/runtime/session"},pt="_instant_oauth_redirect",je="currentUser";function Wo({transportType:t,appId:e,apiURI:n,wsURI:r,EventSourceImpl:s}){if(!s)return new jn(`${r}?app_id=${e}`);switch(t){case"ws":return new jn(`${r}?app_id=${e}`);case"sse":return new Po(s,`${n}/runtime/sse?app_id=${e}`);default:throw new Error("Unknown transport type "+t)}}function Vo(){return typeof window<"u"||typeof chrome<"u"}const xn={"set-presence":!0,"set-presence-ok":!0,"refresh-presence":!0,"patch-presence":!0};function Ho(t,e){var n;const r=typeof t=="string"?JSON.parse(t):t;if(!((n=r==null?void 0:r.result)===null||n===void 0)&&n.store){const s=r.result.store;r.result.store=er(Object.assign(Object.assign({},s),{useDateObjects:e}))}return r}function Qo(t,e){var n;const r=Object.assign({},e);return!((n=e.result)===null||n===void 0)&&n.store&&(r.result=Object.assign(Object.assign({},e.result),{store:Xn(e.result.store)})),r}function Go(t,e){switch(t){case"pendingMutations":return new Map(typeof e=="string"?JSON.parse(e):e);default:return e}}function Jo(t,e){switch(t){case"pendingMutations":return[...e.entries()];default:return e}}function Yo(t,e,n){const r=e==null?void 0:e.result,s=n==null?void 0:n.result;return r&&!s&&n&&(n.result=r),n||e}function Dn(t){return[...t].sort((e,n)=>{const[r,s]=e,[i,o]=n,a=s.order||0,c=o.order||0;return a==c?r<i?-1:r>i?1:0:a-c})}class Zo{constructor(e,n=mr,r=_r,s,i){var o,a,c;if(this._isOnline=!0,this._isShutdown=!1,this.status=te.CONNECTING,this.queryCbs={},this.queryOnceDfds={},this.authCbs=[],this.attrsCbs=[],this.mutationErrorCbs=[],this.connectionStatusCbs=[],this.mutationDeferredStore=new Map,this._reconnectTimeoutId=null,this._reconnectTimeoutMs=0,this._transportType="ws",this._wsOk=null,this._localIdPromises={},this._errorMessage=null,this._oauthCallbackResponse=null,this._linkIndex=null,this._rooms={},this._roomsPendingLeave={},this._presence={},this._broadcastQueue=[],this._broadcastSubs={},this._currentUserCached={isLoading:!0,error:void 0,user:void 0},this._beforeUnloadCbs=[],this._dataForQueryCache={},this._inFlightMutationEventIds=new Set,this._onMergeKv=(l,u,d)=>{var f,p;switch(l){case"pendingMutations":{const h=(f=u==null?void 0:u.entries())!==null&&f!==void 0?f:[],y=(p=d==null?void 0:d.entries())!==null&&p!==void 0?p:[],v=new Map([...h,...y]);return(u?this._rewriteMutationsSorted(this.attrs,u):[]).forEach(([m,w])=>{var T;!(!((T=d==null?void 0:d.pendingMutations)===null||T===void 0)&&T.has(m))&&!w["tx-id"]&&this._sendMutation(m,w)}),v}default:return d||u}},this.getPreviousResult=l=>{var u;const d=U(l);return(u=this.dataForQuery(d))===null||u===void 0?void 0:u.data},this.notifyOne=l=>{var u,d;const f=(u=this.queryCbs[l])!==null&&u!==void 0?u:[],p=(d=this._dataForQueryCache[l])===null||d===void 0?void 0:d.data,h=this.dataForQuery(l);h!=null&&h.data&&(this._dataForQueryCache[l]=h,!Ge(h.data,p)&&f.forEach(y=>y.cb(h.data)))},this.notifyOneQueryOnce=l=>{var u,d;const f=(u=this.queryOnceDfds[l])!==null&&u!==void 0?u:[],p=(d=this.dataForQuery(l))===null||d===void 0?void 0:d.data;f.forEach(h=>{this._completeQueryOnce(h.q,l,h.dfd),h.dfd.resolve(p)})},this.notifyQueryError=(l,u)=>{(this.queryCbs[l]||[]).forEach(f=>f.cb({error:u}))},this.pushTx=l=>{this.config.disableValidation||Mo(l,this.config.schema);try{const u=Zi({attrs:this.optimisticAttrs(),schema:this.config.schema,stores:Object.values(this.querySubs.currentValue).map(d=>{var f;return(f=d==null?void 0:d.result)===null||f===void 0?void 0:f.store}),useDateObjects:this.config.useDateObjects},l);return this.pushOps(u)}catch(u){return this.pushOps([],u)}},this.pushOps=(l,u)=>{const d=$(),f=[...this._pendingMutations().values()],p=Math.max(0,...f.map(v=>v.order||0))+1,h={op:"transact","tx-steps":l,created:Date.now(),error:u,order:p};this._updatePendingMutations(v=>{v.set(d,h)});const y=new wn;return this.mutationDeferredStore.set(d,y),this._sendMutation(d,h),this.notifyAll(),y.promise},this._transportOnOpen=l=>{const u=l.target;if(this._transport!==u){this._log.info("[socket][open]",u.id,"skip; this is no longer the current transport");return}this._log.info("[socket][open]",this._transport.id),this._setStatus(te.OPENED),this.getCurrentUser().then(d=>{var f;this._trySend($(),{op:"init","app-id":this.config.appId,"refresh-token":(f=d.user)===null||f===void 0?void 0:f.refresh_token,versions:this.versions,"__admin-token":this.config.__adminToken})}).catch(d=>{this._log.error("[socket][error]",u.id,d)})},this._transportOnMessage=l=>{const u=l.target,d=l.message;if(this._transport!==u){this._log.info("[socket][message]",u.id,d,"skip; this is no longer the current transport");return}if(!this._wsOk&&u.type==="ws"&&(this._wsOk=!0),this._transportType="ws",Array.isArray(l.message))for(const f of l.message)this._handleReceive(u.id,f);else this._handleReceive(u.id,l.message)},this._transportOnError=l=>{const u=l.target;if(this._transport!==u){this._log.info("[socket][error]",u.id,"skip; this is no longer the current transport");return}this._log.error("[socket][error]",u.id,l)},this._scheduleReconnect=()=>{!this._wsOk&&this._transportType!=="sse"&&(this._transportType="sse",this._reconnectTimeoutMs=0),setTimeout(()=>{if(this._reconnectTimeoutMs=Math.min(this._reconnectTimeoutMs+1e3,1e4),!this._isOnline){this._log.info("[socket][close]",this._transport.id,"we are offline, no need to start socket");return}this._startSocket()},this._reconnectTimeoutMs)},this._transportOnClose=l=>{const u=l.target;if(this._transport!==u){this._log.info("[socket][close]",u.id,"skip; this is no longer the current transport");return}this._setStatus(te.CLOSED);for(const d of Object.values(this._rooms))d.isConnected=!1;if(this._isShutdown){this._log.info("[socket][close]",u.id,"Reactor has been shut down and will not reconnect");return}this._log.info("[socket][close]",u.id,"schedule reconnect, ms =",this._reconnectTimeoutMs),this._scheduleReconnect()},this._EventSource=i,this.config=Object.assign(Object.assign({},zo),e),this.queryCacheLimit=(o=this.config.queryCacheLimit)!==null&&o!==void 0?o:10,this._pendingTxCleanupTimeout=(a=this.config.pendingTxCleanupTimeout)!==null&&a!==void 0?a:Ko,this._pendingMutationCleanupThreshold=(c=this.config.pendingMutationCleanupThreshold)!==null&&c!==void 0?c:Bo,this._log=To(e.verbose||Zt||gr,()=>this._reactorStats()),this.versions=Object.assign(Object.assign({},s||{}),{"@instantdb/core":Sr}),this.config.schema&&(this._linkIndex=Sn(this.config.schema)),!!Vo()){if(!e.appId)throw new Error("Instant must be initialized with an appId.");if(!ge(e.appId))throw new Error(`Instant must be initialized with a valid appId. \`${e.appId}\` is not a valid uuid.`);typeof BroadcastChannel=="function"&&(this._broadcastChannel=new BroadcastChannel("@instantdb"),this._broadcastChannel.addEventListener("message",l=>P(this,void 0,void 0,function*(){var u;try{if(((u=l.data)===null||u===void 0?void 0:u.type)==="auth"){const d=yield this.getCurrentUser();this.updateUser(d.user)}}catch(d){this._log.error("[error] handle broadcast channel",d)}}))),this._initStorage(n),this._syncTable=new No(this._trySendAuthed.bind(this),new n(this.config.appId,"syncSubs"),{useDateObjects:this.config.useDateObjects},this._log,l=>Je(this.attrs,l,this.config.enableCardinalityInference,this._linkIndex,this.config.useDateObjects)),this._oauthCallbackResponse=this._oauthLoginInit(),this.getCurrentUser(),r.getIsOnline().then(l=>{this._isOnline=l,this._startSocket(),r.listen(u=>{u!==this._isOnline&&(this._log.info("[network] online =",u),this._isOnline=u,this._isOnline?this._startSocket():(this._log.info("Changing status from",this.status,"to",te.CLOSED),this._setStatus(te.CLOSED)))})}),typeof addEventListener<"u"&&(this._beforeUnload=this._beforeUnload.bind(this),addEventListener("beforeunload",this._beforeUnload))}}updateSchema(e){this.config=Object.assign(Object.assign({},this.config),{schema:e,cardinalityInference:!!e}),this._linkIndex=e?Sn(this.config.schema):null}_reactorStats(){return{inFlightMutationCount:this._inFlightMutationEventIds.size,pendingMutationCount:this._pendingMutations().size,transportType:this._transportType}}_onQuerySubLoaded(e){this.kv.waitForKeyToLoad("pendingMutations").then(()=>this.notifyOne(e))}_initStorage(e){this.querySubs=new Dt({persister:new e(this.config.appId,"querySubs"),merge:Yo,serialize:Qo,parse:(n,r)=>Ho(r,this.config.useDateObjects),objectSize:n=>{var r,s,i,o;return(o=(i=(s=(r=n.result)===null||r===void 0?void 0:r.store)===null||s===void 0?void 0:s.triples)===null||i===void 0?void 0:i.length)!==null&&o!==void 0?o:0},logger:this._log,preloadEntryCount:10,gc:{maxAgeMs:1e3*60*60*24*7*52,maxEntries:1e3,maxSize:1e6}}),this.querySubs.onKeyLoaded=n=>this._onQuerySubLoaded(n),this.kv=new Dt({persister:new e(this.config.appId,"kv"),merge:this._onMergeKv,serialize:Jo,parse:Go,objectSize:()=>0,logger:this._log,saveThrottleMs:100,idleCallbackMaxWaitMs:100,gc:null}),this.kv.onKeyLoaded=n=>{n==="pendingMutations"&&this.notifyAll()},this.kv.waitForKeyToLoad("pendingMutations"),this.kv.waitForKeyToLoad(je),this._beforeUnloadCbs.push(()=>{this.kv.flush(),this.querySubs.flush()})}_beforeUnload(){for(const e of this._beforeUnloadCbs)e();this._syncTable.beforeUnload()}_finishTransaction(e,n,r){const s=this.mutationDeferredStore.get(n);this.mutationDeferredStore.delete(n);const i=e!=="error"&&e!=="timeout";if(!s&&!i&&console.error("Mutation failed",Object.assign({status:e,eventId:n},r)),!!s)if(i)s.resolve({status:e,eventId:n});else if(r!=null&&r.type){const{status:o}=r,a=Fo(r,["status"]);s.reject(new ot({body:a,status:o??0}))}else s.reject(new Ue((r==null?void 0:r.message)||"Unknown error",r==null?void 0:r.hint))}_setStatus(e,n){this.status=e,this._errorMessage=n,this.notifyConnectionStatusSubs(e)}_flushEnqueuedRoomData(e){var n,r;const s=(r=(n=this._presence[e])===null||n===void 0?void 0:n.result)===null||r===void 0?void 0:r.user,i=this._broadcastQueue[e];if(this._broadcastQueue[e]=[],s&&this._trySetPresence(e,s),i)for(const o of i){const{topic:a,roomType:c,data:l}=o;this._tryBroadcast(e,c,a,l)}}_handleReceive(e,n){var r,s,i,o,a,c;const l=!!this.config.schema&&("cardinalityInference"in this.config?!!this.config.cardinalityInference:!0);switch(xn[n.op]||this._log.info("[receive]",e,n.op,n),n.op){case"init-ok":{this._setStatus(te.AUTHENTICATED),this._reconnectTimeoutMs=0,this._setAttrs(n.attrs),this._flushPendingMessages(),this._sessionId=n["session-id"];for(const f of Object.keys(this._rooms)){const p=(s=(r=this._presence[f])===null||r===void 0?void 0:r.result)===null||s===void 0?void 0:s.user;this._tryJoinRoom(f,p)}break}case"add-query-exists":{this.notifyOneQueryOnce(U(n.q));break}case"add-query-ok":{const{q:f,result:p}=n,h=U(f);if(!this._hasQueryListeners()&&!this.querySubs.currentValue[h])break;const y=(o=(i=p==null?void 0:p[0])===null||i===void 0?void 0:i.data)===null||o===void 0?void 0:o["page-info"],v=(c=(a=p==null?void 0:p[0])===null||a===void 0?void 0:a.data)===null||c===void 0?void 0:c.aggregate,b=Tn(p),m=Je(this.attrs,b,l,this._linkIndex,this.config.useDateObjects);this.querySubs.updateInPlace(w=>{if(!w[h]){this._log.info("Missing value in querySubs",{hash:h,q:f});return}w[h].result={store:m,pageInfo:y,aggregate:v,processedTxId:n["processed-tx-id"]}}),this._cleanupPendingMutationsQueries(),this.notifyOne(h),this.notifyOneQueryOnce(h),this._cleanupPendingMutationsTimeout();break}case"start-sync-ok":{this._syncTable.onStartSyncOk(n);break}case"sync-load-batch":{this._syncTable.onSyncLoadBatch(n);break}case"sync-init-finish":{this._syncTable.onSyncInitFinish(n);break}case"sync-update-triples":{this._syncTable.onSyncUpdateTriples(n);break}case"refresh-ok":{const{computations:f,attrs:p}=n,h=n["processed-tx-id"];p&&this._setAttrs(p),this._cleanupPendingMutationsTimeout();const y=this._rewriteMutations(this.attrs,this._pendingMutations(),h);y!==this._pendingMutations()&&this.kv.updateInPlace(m=>{m.pendingMutations=y});const v=Dn(y.entries()),b=f.map(m=>{var w,T,g,E;const k=m["instaql-query"],x=m["instaql-result"],ue=U(k),ke=Tn(x),ee=Je(this.attrs,ke,l,this._linkIndex,this.config.useDateObjects),Ae=this._applyOptimisticUpdates(ee,v,h),Ce=(T=(w=x==null?void 0:x[0])===null||w===void 0?void 0:w.data)===null||T===void 0?void 0:T["page-info"],Ie=(E=(g=x==null?void 0:x[0])===null||g===void 0?void 0:g.data)===null||E===void 0?void 0:E.aggregate;return{q:k,hash:ue,store:Ae,pageInfo:Ce,aggregate:Ie}});b.forEach(({hash:m,q:w,store:T,pageInfo:g,aggregate:E})=>{this.querySubs.updateInPlace(k=>{if(!k[m]){this._log.error("Missing value in querySubs",{hash:m,q:w});return}k[m].result={store:T,pageInfo:g,aggregate:E,processedTxId:h}})}),this._cleanupPendingMutationsQueries(),b.forEach(({hash:m})=>{this.notifyOne(m)});break}case"transact-ok":{const{"client-event-id":f,"tx-id":p}=n;this._inFlightMutationEventIds.delete(f);const y=this._rewriteMutations(this.attrs,this._pendingMutations()).get(f);if(!y)break;this._updatePendingMutations(b=>{b.set(f,Object.assign(Object.assign({},b.get(f)),{"tx-id":p,confirmed:Date.now()}))});const v=y["tx-steps"].filter(([b,...m])=>b==="add-attr").map(([b,m])=>m).concat(Object.values(this.attrs));this._setAttrs(v),this._finishTransaction("synced",f),this._cleanupPendingMutationsTimeout();break}case"patch-presence":{const f=n["room-id"];this._trySetRoomConnected(f,!0),this._patchPresencePeers(f,n.edits),this._notifyPresenceSubs(f);break}case"refresh-presence":{const f=n["room-id"];this._trySetRoomConnected(f,!0),this._setPresencePeers(f,n.data),this._notifyPresenceSubs(f);break}case"server-broadcast":{const f=n["room-id"],p=n.topic;this._trySetRoomConnected(f,!0),this._notifyBroadcastSubs(f,p,n);break}case"join-room-ok":{const f=n["room-id"];if(!this._rooms[f]){this._roomsPendingLeave[f]&&(this._tryLeaveRoom(f),delete this._roomsPendingLeave[f]);break}this._trySetRoomConnected(f,!0),this._flushEnqueuedRoomData(f);break}case"leave-room-ok":{const f=n["room-id"];this._trySetRoomConnected(f,!1);break}case"join-room-error":const u=n["room-id"],d=this._rooms[u];d&&(d.error=n.error),this._notifyPresenceSubs(u);break;case"error":this._handleReceiveError(n);break;default:this._log.info("Uknown op",n.op,n);break}}_pendingMutations(){var e;return(e=this.kv.currentValue.pendingMutations)!==null&&e!==void 0?e:new Map}_updatePendingMutations(e){this.kv.updateInPlace(n=>{var r;const s=(r=n.pendingMutations)!==null&&r!==void 0?r:new Map;n.pendingMutations=s,e(s)})}_handleMutationError(e,n,r){const s=this._pendingMutations().get(n);if(s&&(e!=="timeout"||!s["tx-id"])){this._updatePendingMutations(o=>(o.delete(n),o)),this._inFlightMutationEventIds.delete(n);const i={message:r.message,hint:r.hint};this.notifyAll(),this.notifyAttrsSubs(),this.notifyMutationErrorSubs(i),this._finishTransaction(e,n,r)}}_handleReceiveError(e){var n,r,s,i,o,a,c;console.log("error",e);const l=e["client-event-id"];this._inFlightMutationEventIds.delete(l);const u=this._pendingMutations().get(l),d={message:e.message||"Uh-oh, something went wrong. Ping Joe & Stopa."};if(e.hint&&(d.hint=e.hint),u){this._handleMutationError("error",l,e);return}if(!((n=e["original-event"])===null||n===void 0)&&n.hasOwnProperty("q")&&((r=e["original-event"])===null||r===void 0?void 0:r.op)==="add-query"){const h=(s=e["original-event"])===null||s===void 0?void 0:s.q,y=U(h);this.notifyQueryError(U(h),d),this.notifyQueryOnceError(h,y,l,d);return}if(((i=e["original-event"])===null||i===void 0?void 0:i.op)==="init"){if(e.type==="record-not-found"&&((o=e.hint)===null||o===void 0?void 0:o["record-type"])==="app-user"){this.changeCurrentUser(null);return}this._setStatus(te.ERRORED,d),this.notifyAll();return}if(((a=e["original-event"])===null||a===void 0?void 0:a.op)==="resync-table"){this._syncTable.onResyncError(e);return}if(((c=e["original-event"])===null||c===void 0?void 0:c.op)==="start-sync"){this._syncTable.onStartSyncError(e);return}const p=Object.assign({},e);delete p.message,delete p.hint,console.error(e.message,p),e.hint&&console.error(`This error comes with some debugging information. Here it is: 
`,e.hint)}notifyQueryOnceError(e,n,r,s){var i;const o=(i=this.queryOnceDfds[n])===null||i===void 0?void 0:i.find(a=>a.eventId===r);o&&(o.dfd.reject(s),this._completeQueryOnce(e,n,o.dfd))}_setAttrs(e){this.attrs=e.reduce((n,r)=>(n[r.id]=r,n),{}),this.notifyAttrsSubs()}_startQuerySub(e,n){const r=$();return this.querySubs.updateInPlace(s=>{s[n]=s[n]||{q:e,result:null,eventId:r},s[n].lastAccessed=Date.now()}),this._trySendAuthed(r,{op:"add-query",q:e}),r}subscribeTable(e,n){return this._syncTable.subscribe(e,n)}subscribeQuery(e,n,r){var s;this.config.disableValidation||En(e,this.config.schema),r&&"ruleParams"in r&&(e=Object.assign({$$ruleParams:r.ruleParams},e));const i=U(e),o=this.getPreviousResult(e);return o&&n(o),this.queryCbs[i]=(s=this.queryCbs[i])!==null&&s!==void 0?s:[],this.queryCbs[i].push({q:e,cb:n}),this._startQuerySub(e,i),()=>{this._unsubQuery(e,i,n)}}queryOnce(e,n){var r;this.config.disableValidation||En(e,this.config.schema),n&&"ruleParams"in n&&(e=Object.assign({$$ruleParams:n.ruleParams},e));const s=new wn;if(!this._isOnline)return s.reject(new Error("We can't run `queryOnce`, because the device is offline.")),s.promise;if(!this.querySubs)return s.reject(new Error("We can't run `queryOnce` on the backend. Use adminAPI.query instead: https://www.instantdb.com/docs/backend#query")),s.promise;const i=U(e),o=this._startQuerySub(e,i);return this.queryOnceDfds[i]=(r=this.queryOnceDfds[i])!==null&&r!==void 0?r:[],this.queryOnceDfds[i].push({q:e,dfd:s,eventId:o}),setTimeout(()=>s.reject(new Error("Query timed out")),qo),s.promise}_completeQueryOnce(e,n,r){this.queryOnceDfds[n]&&(this.queryOnceDfds[n]=this.queryOnceDfds[n].filter(s=>s.dfd!==r),this._cleanupQuery(e,n))}_unsubQuery(e,n,r){this.queryCbs[n]&&(this.queryCbs[n]=this.queryCbs[n].filter(s=>s.cb!==r),this._cleanupQuery(e,n))}_hasQueryListeners(e){var n,r;return!!(!((n=this.queryCbs[e])===null||n===void 0)&&n.length||!((r=this.queryOnceDfds[e])===null||r===void 0)&&r.length)}_cleanupQuery(e,n){this._hasQueryListeners(n)||(delete this.queryCbs[n],delete this.queryOnceDfds[n],delete this._dataForQueryCache[n],this.querySubs.unloadKey(n),this._trySendAuthed($(),{op:"remove-query",q:e}))}_rewriteMutations(e,n,r){if(!e)return n;if(!n)return new Map;const s=u=>{const[d,f,p]=u["forward-identity"];return R(e,f,p)},i=u=>{const[d,f,p]=u["forward-identity"];return pe(e,f,p)},o={attrIdMap:{},refSwapAttrIds:new Set};let a=!1;const c=(u,d)=>{const f=[];for(const p of u){const[h]=p;if(h==="add-attr"){const[v,b]=p,m=s(b);if(m&&b.id!==m.id){o.attrIdMap[b.id]=m.id,a=!0;continue}if(b["value-type"]==="ref"){const w=i(b);if(w){o.attrIdMap[b.id]=w.id,o.refSwapAttrIds.add(b.id),a=!0;continue}}}if(r&&d&&r>=d&&h==="add-attr"||h==="update-attr"||h==="delete-attr"){a=!0;continue}const y=a?Ci(o,p):p;f.push(y)}return a?f:u},l=new Map;for(const[u,d]of n.entries())l.set(u,Object.assign(Object.assign({},d),{"tx-steps":c(d["tx-steps"],d["tx-id"])}));return a?l:n}_rewriteMutationsSorted(e,n){return Dn(this._rewriteMutations(e,n).entries())}optimisticAttrs(){var e;const n=[...this._pendingMutations().values()].flatMap(a=>a["tx-steps"]),r=new Set(n.filter(([a,c])=>a==="delete-attr").map(([a,c])=>c)),s=[];for(const[a,c]of n)if(a==="add-attr")s.push(c);else if(a==="update-attr"&&c.id&&(!((e=this.attrs)===null||e===void 0)&&e[c.id])){const l=Object.assign(Object.assign({},this.attrs[c.id]),c);s.push(l)}const i=[...Object.values(this.attrs||{}),...s].filter(a=>!r.has(a.id));return Object.fromEntries(i.map(a=>[a.id,a]))}dataForQuery(e){const n=this._errorMessage;if(n)return{error:n};if(!this.querySubs||!this.kv.currentValue.pendingMutations)return;const r=this.querySubs.version(),s=this.querySubs.currentValue,i=this.kv.version(),o=this._pendingMutations(),{q:a,result:c}=s[e]||{};if(!c)return;const l=this._dataForQueryCache[e];if(l&&r===l.querySubVersion&&i===l.pendingMutationsVersion)return l;const{store:u,pageInfo:d,aggregate:f,processedTxId:p}=c,h=this._rewriteMutationsSorted(u.attrs,o),y=this._applyOptimisticUpdates(u,h,p);return{data:pr({store:y,pageInfo:d,aggregate:f},a),querySubVersion:r,pendingMutationsVersion:i}}_applyOptimisticUpdates(e,n,r){for(const[s,i]of n)(!i["tx-id"]||r&&i["tx-id"]>r)&&(e=Is(e,i["tx-steps"]));return e}notifyAll(){Object.keys(this.queryCbs).forEach(e=>{this.querySubs.waitForKeyToLoad(e).then(()=>this.notifyOne(e)).catch(()=>this.notifyOne(e))})}loadedNotifyAll(){this.kv.waitForKeyToLoad("pendingMutations").then(()=>this.notifyAll()).catch(()=>this.notifyAll())}shutdown(){var e;this._log.info("[shutdown]",this.config.appId),this._isShutdown=!0,(e=this._transport)===null||e===void 0||e.close()}_sendMutation(e,n){if(n.error){this._handleMutationError("error",e,{message:n.error.message});return}if(this.status!==te.AUTHENTICATED){this._finishTransaction("enqueued",e);return}const r=Math.max(6e3,Math.min(this._inFlightMutationEventIds.size+1,this._pendingMutations().size+1)*6e3);this._isOnline?(this._trySend(e,n),setTimeout(()=>{this._isOnline&&this._handleMutationError("timeout",e,{message:"transaction timed out"})},r)):this._finishTransaction("enqueued",e)}_flushPendingMessages(){Object.keys(this.queryCbs).map(s=>this.querySubs.currentValue[s]).filter(s=>s).forEach(({eventId:s,q:i})=>{this._trySendAuthed(s,{op:"add-query",q:i})}),Object.values(this.queryOnceDfds).flat().forEach(({eventId:s,q:i})=>{this._trySendAuthed(s,{op:"add-query",q:i})}),this._rewriteMutationsSorted(this.attrs,this._pendingMutations()).forEach(([s,i])=>{i["tx-id"]||this._sendMutation(s,i)}),this._syncTable.flushPending()}_cleanupPendingMutationsQueries(){let e=Number.MAX_SAFE_INTEGER;for(const{result:n}of Object.values(this.querySubs.currentValue))n!=null&&n.processedTxId&&(e=Math.min(e,n==null?void 0:n.processedTxId));this._updatePendingMutations(n=>{for(const[r,s]of Array.from(n.entries()))s["tx-id"]&&s["tx-id"]<=e&&n.delete(r)})}_cleanupPendingMutationsTimeout(){if(this._pendingMutations().size<this._pendingMutationCleanupThreshold)return;const e=Date.now();this._updatePendingMutations(n=>{for(const[r,s]of Array.from(n.entries()))s.confirmed&&s.confirmed+this._pendingTxCleanupTimeout<e&&n.delete(r)})}_trySendAuthed(...e){this.status===te.AUTHENTICATED&&this._trySend(...e)}_trySend(e,n,r){if(this._transport.isOpen()){switch(xn[n.op]||this._log.info("[send]",this._transport.id,n.op,n),n.op){case"transact":{this._inFlightMutationEventIds.add(e);break}case"init":this._inFlightMutationEventIds.clear()}this._transport.send(Object.assign({"client-event-id":e},n))}}_startSocket(){if(this._wsOk=null,this._isShutdown){this._log.info("[socket][start]",this.config.appId,"Reactor has been shut down and will not start a new socket");return}if(this._transport&&this._transport.isConnecting()){this._log.info("[socket][start]",this._transport.id,"maintained as current transport, we were still in a connecting state");return}const e=this._transport;this._transport=Wo({transportType:this._transportType,appId:this.config.appId,apiURI:this.config.apiURI,wsURI:this.config.websocketURI,EventSourceImpl:this._EventSource}),this._transport.onopen=this._transportOnOpen,this._transport.onmessage=this._transportOnMessage,this._transport.onclose=this._transportOnClose,this._transport.onerror=this._transportOnError,this._log.info("[socket][start]",this._transport.id),e!=null&&e.isOpen()&&(this._log.info("[socket][start]",this._transport.id,"close previous transport id = ",e.id),e.close())}getLocalId(e){return P(this,void 0,void 0,function*(){const n=`localToken_${e}`;if(this.kv.currentValue[n])return this.kv.currentValue[n];const r=yield this.kv.waitForKeyToLoad(n);if(r)return r;const s=$();return this.kv.updateInPlace(i=>{i[n]||(i[n]=s)}),yield this.kv.waitForKeyToLoad(n)})}_replaceUrlAfterOAuth(){if(typeof URL>"u")return;const e=new URL(window.location.href);if(e.searchParams.get(pt)){const n=e.toString();e.searchParams.delete(pt),e.searchParams.delete("code"),e.searchParams.delete("error");const r=e.pathname+(e.searchParams.size?"?"+e.searchParams:"")+e.hash;if(history.replaceState(history.state,"",r),typeof navigation=="object"&&typeof navigation.addEventListener=="function"&&typeof navigation.removeEventListener=="function"){let s=!1;const i=o=>{var a;s||(s=!0,navigation.removeEventListener("navigate",i),!o.userInitiated&&o.navigationType==="replace"&&((a=o.destination)===null||a===void 0?void 0:a.url)===n&&history.replaceState(history.state,"",r))};navigation.addEventListener("navigate",i)}}}_oauthLoginInit(){return P(this,void 0,void 0,function*(){var e,n,r,s;if(typeof window>"u"||typeof window.location>"u"||typeof URLSearchParams>"u")return null;const i=new URLSearchParams(window.location.search);if(!i.get(pt))return null;const o=i.get("error");if(o)return this._replaceUrlAfterOAuth(),{error:{message:o}};const a=i.get("code");if(!a)return null;this._replaceUrlAfterOAuth();try{const c=yield this._getCurrentUser(),l=(c==null?void 0:c.type)==="guest",{user:u}=yield _n({apiURI:this.config.apiURI,appId:this.config.appId,code:a,refreshToken:l?c.refresh_token:void 0});return this.setCurrentUser(u),null}catch(c){return((e=c==null?void 0:c.body)===null||e===void 0?void 0:e.type)==="record-not-found"&&((r=(n=c==null?void 0:c.body)===null||n===void 0?void 0:n.hint)===null||r===void 0?void 0:r["record-type"])==="app-oauth-code"&&(yield this._hasCurrentUser())?null:{error:{message:((s=c==null?void 0:c.body)===null||s===void 0?void 0:s.message)||"Error logging in."}}}})}_waitForOAuthCallbackResponse(){return P(this,void 0,void 0,function*(){return yield this._oauthCallbackResponse})}__subscribeMutationErrors(e){return this.mutationErrorCbs.push(e),()=>{this.mutationErrorCbs=this.mutationErrorCbs.filter(n=>n!==e)}}subscribeAuth(e){this.authCbs.push(e);const n=this._currentUserCached;n.isLoading||e(this._currentUserCached);let r=!1;return this.getCurrentUser().then(s=>{r||Ge(s,n)||e(s)}),()=>{r=!0,this.authCbs=this.authCbs.filter(s=>s!==e)}}getAuth(){return P(this,void 0,void 0,function*(){const{user:e,error:n}=yield this.getCurrentUser();if(n)throw new Ue("Could not get current user: "+n.message);return e})}subscribeConnectionStatus(e){return this.connectionStatusCbs.push(e),()=>{this.connectionStatusCbs=this.connectionStatusCbs.filter(n=>n!==e)}}subscribeAttrs(e){return this.attrsCbs.push(e),this.attrs&&e(this.attrs),()=>{this.attrsCbs=this.attrsCbs.filter(n=>n!==e)}}notifyAuthSubs(e){this.authCbs.forEach(n=>n(e))}notifyMutationErrorSubs(e){this.mutationErrorCbs.forEach(n=>n(e))}notifyAttrsSubs(){if(!this.attrs)return;const e=this.optimisticAttrs();this.attrsCbs.forEach(n=>n(e))}notifyConnectionStatusSubs(e){this.connectionStatusCbs.forEach(n=>n(e))}setCurrentUser(e){return P(this,void 0,void 0,function*(){this.kv.updateInPlace(n=>{n[je]=e}),yield this.kv.waitForKeyToLoad(je)})}getCurrentUserCached(){return this._currentUserCached}_getCurrentUser(){return P(this,void 0,void 0,function*(){const e=yield this.kv.waitForKeyToLoad(je);return typeof e=="string"?JSON.parse(e):e})}getCurrentUser(){return P(this,void 0,void 0,function*(){const e=yield this._waitForOAuthCallbackResponse();if(e!=null&&e.error){const n={error:e.error,user:void 0};return this._currentUserCached=Object.assign({isLoading:!1},n),n}try{const r={user:yield this._getCurrentUser(),error:void 0};return this._currentUserCached=Object.assign({isLoading:!1},r),r}catch(n){return{user:void 0,isLoading:!1,error:{message:(n==null?void 0:n.message)||"Error loading user"}}}})}_hasCurrentUser(){return P(this,void 0,void 0,function*(){const e=yield this.kv.waitForKeyToLoad(je);return typeof e=="string"?JSON.parse(e)!=null:e!=null})}changeCurrentUser(e){return P(this,void 0,void 0,function*(){var n;const{user:r}=yield this.getCurrentUser();if(!Ge(r,e)){yield this.setCurrentUser(e),this.updateUser(e);try{(n=this._broadcastChannel)===null||n===void 0||n.postMessage({type:"auth"})}catch(s){console.error("Error posting message to broadcast channel",s)}}})}updateUser(e){const n={error:void 0,user:e};this._currentUserCached=Object.assign({isLoading:!1},n),this._dataForQueryCache={},this.querySubs.updateInPlace(r=>{Object.keys(r).forEach(s=>{delete r[s].result})}),this._reconnectTimeoutMs=0,this._transport.close(),this._oauthCallbackResponse=null,this.notifyAuthSubs(n)}sendMagicCode({email:e}){return co({apiURI:this.config.apiURI,appId:this.config.appId,email:e})}signInWithMagicCode(e){return P(this,arguments,void 0,function*({email:n,code:r}){var s;const i=yield this.getCurrentUser(),o=((s=i==null?void 0:i.user)===null||s===void 0?void 0:s.type)==="guest",a=yield uo({apiURI:this.config.apiURI,appId:this.config.appId,email:n,code:r,refreshToken:o?i.user.refresh_token:void 0});return yield this.changeCurrentUser(a.user),a})}signInWithCustomToken(e){return P(this,void 0,void 0,function*(){const n=yield lo({apiURI:this.config.apiURI,appId:this.config.appId,refreshToken:e});return yield this.changeCurrentUser(n.user),n})}signInAsGuest(){return P(this,void 0,void 0,function*(){const e=yield fo({apiURI:this.config.apiURI,appId:this.config.appId});return yield this.changeCurrentUser(e.user),e})}potentiallyInvalidateToken(e,n){var r;const s=(r=e==null?void 0:e.user)===null||r===void 0?void 0:r.refresh_token;if(!s)return;if(n.invalidateToken===!1){this._log.info("[auth-invalidate] skipped invalidateToken");return}ho({apiURI:this.config.apiURI,appId:this.config.appId,refreshToken:s}).then(()=>{this._log.info("[auth-invalidate] completed invalidateToken")}).catch(o=>{})}signOut(e){return P(this,void 0,void 0,function*(){const n=yield this.getCurrentUser();this.potentiallyInvalidateToken(n,e),yield this.changeCurrentUser(null)})}createAuthorizationURL({clientName:e,redirectURL:n}){const{apiURI:r,appId:s}=this.config;return`${r}/runtime/oauth/start?app_id=${s}&client_name=${e}&redirect_uri=${n}`}exchangeCodeForToken(e){return P(this,arguments,void 0,function*({code:n,codeVerifier:r}){var s;const i=yield this.getCurrentUser(),o=((s=i==null?void 0:i.user)===null||s===void 0?void 0:s.type)==="guest",a=yield _n({apiURI:this.config.apiURI,appId:this.config.appId,code:n,codeVerifier:r,refreshToken:o?i.user.refresh_token:void 0});return yield this.changeCurrentUser(a.user),a})}issuerURI(){const{apiURI:e,appId:n}=this.config;return`${e}/runtime/${n}`}signInWithIdToken(e){return P(this,arguments,void 0,function*({idToken:n,clientName:r,nonce:s}){var i;const o=yield this.getCurrentUser(),a=(i=o==null?void 0:o.user)===null||i===void 0?void 0:i.refresh_token,c=yield po({apiURI:this.config.apiURI,appId:this.config.appId,idToken:n,clientName:r,nonce:s,refreshToken:a});return yield this.changeCurrentUser(c.user),c})}joinRoom(e,n){let r=!1;this._rooms[e]||(r=!0,this._rooms[e]={isConnected:!1,error:void 0}),this._presence[e]=this._presence[e]||{};const s=this._presence[e].result;return n&&!s&&(this._presence[e].result=this._presence[e].result||{},this._presence[e].result.user=n,this._notifyPresenceSubs(e)),r&&this._tryJoinRoom(e,n),()=>{this._cleanupRoom(e)}}_cleanupRoom(e){var n,r,s,i;if(!(!((r=(n=this._presence[e])===null||n===void 0?void 0:n.handlers)===null||r===void 0)&&r.length)&&!Object.keys((s=this._broadcastSubs[e])!==null&&s!==void 0?s:{}).length){const o=(i=this._rooms[e])===null||i===void 0?void 0:i.isConnected;delete this._rooms[e],delete this._presence[e],delete this._broadcastSubs[e],o?this._tryLeaveRoom(e):this._roomsPendingLeave[e]=!0}}getPresence(e,n,r={}){const s=this._rooms[n],i=this._presence[n];return!s||!i||!i.result?null:Object.assign(Object.assign({},go(i.result,r,this._sessionId)),{isLoading:!s.isConnected,error:s.error})}publishPresence(e,n,r){const s=this._rooms[n],i=this._presence[n];if(!s||!i)return;i.result=i.result||{};const o=Object.assign(Object.assign({},i.result.user),r);i.result.user=o,s.isConnected&&(this._trySetPresence(n,o),this._notifyPresenceSubs(n))}_trySetPresence(e,n){this._trySendAuthed($(),{op:"set-presence","room-id":e,data:n})}_tryJoinRoom(e,n){this._trySendAuthed($(),{op:"join-room","room-id":e,data:n}),delete this._roomsPendingLeave[e]}_tryLeaveRoom(e){this._trySendAuthed($(),{op:"leave-room","room-id":e})}_trySetRoomConnected(e,n){const r=this._rooms[e];r&&(r.isConnected=n)}subscribePresence(e,n,r,s){const i=this.joinRoom(n,r.initialPresence||r.initialData),o=Object.assign(Object.assign({},r),{roomId:n,cb:s,prev:null});return this._presence[n]=this._presence[n]||{},this._presence[n].handlers=this._presence[n].handlers||[],this._presence[n].handlers.push(o),this._notifyPresenceSub(n,o),()=>{var a,c,l;this._presence[n].handlers=(l=(c=(a=this._presence[n])===null||a===void 0?void 0:a.handlers)===null||c===void 0?void 0:c.filter(u=>u!==o))!==null&&l!==void 0?l:[],i()}}_notifyPresenceSubs(e){var n,r;(r=(n=this._presence[e])===null||n===void 0?void 0:n.handlers)===null||r===void 0||r.forEach(s=>{this._notifyPresenceSub(e,s)})}_notifyPresenceSub(e,n){const r=this.getPresence("",e,n);r&&(n.prev&&!wo(r,n.prev)||(n.prev=r,n.cb(r)))}_patchPresencePeers(e,n){var r,s,i;const o=((s=(r=this._presence[e])===null||r===void 0?void 0:r.result)===null||s===void 0?void 0:s.peers)||{};let a=Object.fromEntries(Object.entries(o).map(([l,u])=>[l,{data:u}]));(i=this._presence[e])===null||i===void 0||i.result;const c=et(a,l=>{for(let[u,d,f]of n)switch(d){case"+":Yr(l,u,f);break;case"r":on(l,u,f);break;case"-":Jn(l,u);break}delete l[this._sessionId]});this._setPresencePeers(e,c)}_setPresencePeers(e,n){const r=Object.assign({},n);delete r[this._sessionId];const s=Object.fromEntries(Object.entries(r).map(([i,o])=>[i,o.data]));this._presence=et(this._presence,i=>{on(i,[e,"result","peers"],s)})}publishTopic({roomType:e,roomId:n,topic:r,data:s}){var i;const o=this._rooms[n];if(o){if(!o.isConnected){this._broadcastQueue[n]=(i=this._broadcastQueue[n])!==null&&i!==void 0?i:[],this._broadcastQueue[n].push({topic:r,roomType:e,data:s});return}this._tryBroadcast(n,e,r,s)}}_tryBroadcast(e,n,r,s){this._trySendAuthed($(),{op:"client-broadcast","room-id":e,roomType:n,topic:r,data:s})}subscribeTopic(e,n,r){const s=this.joinRoom(e);return this._broadcastSubs[e]=this._broadcastSubs[e]||{},this._broadcastSubs[e][n]=this._broadcastSubs[e][n]||[],this._broadcastSubs[e][n].push(r),this._presence[e]=this._presence[e]||{},()=>{this._broadcastSubs[e][n]=this._broadcastSubs[e][n].filter(i=>i!==r),this._broadcastSubs[e][n].length||delete this._broadcastSubs[e][n],s()}}_notifyBroadcastSubs(e,n,r){var s,i,o;(o=(i=(s=this._broadcastSubs)===null||s===void 0?void 0:s[e])===null||i===void 0?void 0:i[n])===null||o===void 0||o.forEach(a=>{var c,l,u,d,f,p;const h=(c=r.data)===null||c===void 0?void 0:c.data,y=r.data["peer-id"]===this._sessionId?(u=(l=this._presence[e])===null||l===void 0?void 0:l.result)===null||u===void 0?void 0:u.user:(p=(f=(d=this._presence[e])===null||d===void 0?void 0:d.result)===null||f===void 0?void 0:f.peers)===null||p===void 0?void 0:p[r.data["peer-id"]];return a(h,y)})}uploadFile(e,n,r){return P(this,void 0,void 0,function*(){var s;const i=yield this.getCurrentUser(),o=(s=i==null?void 0:i.user)===null||s===void 0?void 0:s.refresh_token;return yo(Object.assign(Object.assign({},r),{apiURI:this.config.apiURI,appId:this.config.appId,path:e,file:n,refreshToken:o}))})}deleteFile(e){return P(this,void 0,void 0,function*(){var n;const r=yield this.getCurrentUser(),s=(n=r==null?void 0:r.user)===null||n===void 0?void 0:n.refresh_token;return yield vo({apiURI:this.config.apiURI,appId:this.config.appId,path:e,refreshToken:s})})}upload(e,n){return P(this,void 0,void 0,function*(){var r;const s=yield this.getCurrentUser(),i=(r=s==null?void 0:s.user)===null||r===void 0?void 0:r.refresh_token,o=e||n.name,a=yield bo({apiURI:this.config.apiURI,appId:this.config.appId,fileName:o,refreshToken:i});return yield mo(a,n)})}getDownloadUrl(e){return P(this,void 0,void 0,function*(){var n;const r=yield this.getCurrentUser(),s=(n=r==null?void 0:r.user)===null||n===void 0?void 0:n.refresh_token;return yield _o({apiURI:this.config.apiURI,appId:this.config.appId,path:e,refreshToken:s})})}}function Xo(t,e){return new ct(jr(t,e),e,void 0)}function ea(t){return new at(t,{})}function ta(){return new F("string",!0,!1)}function na(){return new F("number",!0,!1)}function ra(){return new F("boolean",!0,!1)}function sa(){return new F("date",!0,!1)}function ia(){return new F("json",!0,!1)}function oa(){return new F("json",!0,!1)}function jr(t,e){var n,r,s,i;const o={fwd:{},rev:{}};for(const c of Object.values(e))(n=o.fwd)[r=c.forward.on]||(n[r]={}),(s=o.rev)[i=c.reverse.on]||(s[i]={}),o.fwd[c.forward.on][c.forward.label]={entityName:c.reverse.on,cardinality:c.forward.has},o.rev[c.reverse.on][c.reverse.label]={entityName:c.forward.on,cardinality:c.reverse.has};return Object.fromEntries(Object.entries(t).map(([c,l])=>[c,new at(l.attrs,Object.assign(Object.assign({},o.fwd[c]),o.rev[c]))]))}function aa({entities:t,links:e,rooms:n}){const r=e??{},s=n??{};return new ct(jr(t,r),r,s)}const I={graph:Xo,schema:aa,entity:ea,string:ta,number:na,boolean:ra,date:sa,json:ia,any:oa};let We;function ca(t,e){We==null||We.dispose();const n=ha(e),r=da(e,a),s=la(ua(t));function i(u){var d;u.source===s.element.contentWindow&&((d=u.data)===null||d===void 0?void 0:d.type)==="close"&&n.isVisible()&&a()}function o(u){const d=u.shiftKey&&u.ctrlKey&&u.key==="0",f=u.key==="Escape"||u.key==="Esc";(d||f&&n.isVisible())&&a()}function a(){n.isVisible()?n.element.style.display="none":(n.element.style.display="block",n.element.contains(s.element)||n.element.appendChild(s.element))}function c(){n.element.remove(),r.element.remove(),removeEventListener("keydown",o),removeEventListener("message",i)}function l(){document.body.appendChild(n.element),document.body.appendChild(r.element),addEventListener("keydown",o),addEventListener("message",i),We={dispose:c}}return l()}function ua(t){return`${Zt||wr?"http://localhost:3000":"https://instantdb.com"}/_devtool?appId=${t}`}function la(t){const e=document.createElement("iframe");return e.src=t,e.className="instant-devtool-iframe",Object.assign(e.style,{width:"100%",height:"100%",backgroundColor:"white",border:"none"}),{element:e}}function da(t,e){const n=`
    <svg width="32" height="32" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect width="512" height="512" fill="black"/>
      <rect x="97.0973" y="91.3297" width="140" height="330" fill="white"/>
    </svg>
  `,r=document.createElement("button");return r.innerHTML=n,r.className="instant-devtool-toggler",Object.assign(r.style,Object.assign(Object.assign({position:"fixed"},fa(t.position)),{height:"32px",width:"32px",display:"flex",alignItems:"center",justifyContent:"center",zIndex:"9010",padding:"0",margin:"0",border:"none",cursor:"pointer"})),r.addEventListener("click",e),{element:r}}function fa(t){switch(t){case"bottom-left":return{bottom:"24px",left:"24px"};case"bottom-right":return{bottom:"24px",right:"24px"};case"top-right":return{top:"24px",right:"24px"};case"top-left":return{top:"24px",left:"24px"}}}function pa(t){switch(t){case"bottom-left":return{bottom:"24px",right:"24px",left:"60px",top:"72px"};case"bottom-right":return{bottom:"24px",left:"24px",right:"60px",top:"72px"};case"top-right":return{top:"24px",left:"24px",right:"60px",bottom:"72px"};case"top-left":return{top:"24px",right:"24px",left:"60px",bottom:"72px"}}}function ha(t){const e=document.createElement("div");Object.assign(e.style,Object.assign(Object.assign({position:"fixed"},pa(t.position)),{display:"block",borderRadius:"4px",border:"1px #ccc solid",boxShadow:"0px 0px 8px #00000044",backgroundColor:"#eee",zIndex:"999990"})),e.style.display="none",e.className="instant-devtool-container";function n(){return e.style.display!=="none"}return{element:e,isVisible:n}}const ya={apiURI:"https://api.instantdb.com",websocketURI:"wss://api.instantdb.com/runtime/session"};function va(){var t;return globalThis.__instantDbSchemaHashStore=(t=globalThis.__instantDbSchemaHashStore)!==null&&t!==void 0?t:new WeakMap,globalThis.__instantDbSchemaHashStore}function ba(){var t;return globalThis.__instantDbStore=(t=globalThis.__instantDbStore)!==null&&t!==void 0?t:{},globalThis.__instantDbStore}function Rt(t){const e=t.__adminToken;return t.appId+"_"+(t.websocketURI||"default_ws_uri")+"_"+(t.apiURI||"default_api_uri")+"_"+(e||"client_only")+"_"+t.useDateObjects}const Lt=ba(),Rn=va();class ma{constructor(e){this.db=e,this.sendMagicCode=n=>this.db.sendMagicCode(n),this.signInWithMagicCode=n=>this.db.signInWithMagicCode(n),this.signInWithToken=n=>this.db.signInWithCustomToken(n),this.signInAsGuest=()=>this.db.signInAsGuest(),this.createAuthorizationURL=n=>this.db.createAuthorizationURL(n),this.signInWithIdToken=n=>this.db.signInWithIdToken(n),this.exchangeOAuthCode=n=>this.db.exchangeCodeForToken(n),this.issuerURI=()=>this.db.issuerURI(),this.signOut=(n={invalidateToken:!0})=>this.db.signOut(n)}}class _a{constructor(e){this.db=e,this.uploadFile=(n,r,s={})=>this.db.uploadFile(n,r,s),this.delete=n=>this.db.deleteFile(n),this.upload=(n,r)=>this.db.upload(n,r),this.put=this.upload,this.getDownloadUrl=n=>this.db.getDownloadUrl(n)}}class ga{constructor(e){this.tx=yr(),this._reactor=e,this.auth=new ma(this._reactor),this.storage=new _a(this._reactor)}transact(e){return this._reactor.pushTx(e)}getLocalId(e){return this._reactor.getLocalId(e)}subscribeQuery(e,n,r){return this._reactor.subscribeQuery(e,n,r)}subscribeAuth(e){return this._reactor.subscribeAuth(e)}getAuth(){return this._reactor.getAuth()}subscribeConnectionStatus(e){return this._reactor.subscribeConnectionStatus(e)}joinRoom(e="_defaultRoomType",n="_defaultRoomId",r){return{leaveRoom:this._reactor.joinRoom(n,r==null?void 0:r.initialPresence),subscribeTopic:(i,o)=>this._reactor.subscribeTopic(n,i,o),subscribePresence:(i,o)=>this._reactor.subscribePresence(e,n,i,o),publishTopic:(i,o)=>this._reactor.publishTopic({roomType:e,roomId:n,topic:i,data:o}),publishPresence:i=>this._reactor.publishPresence(e,n,i),getPresence:i=>this._reactor.getPresence(e,n,i)}}shutdown(){delete Lt[Rt(this._reactor.config)],this._reactor.shutdown()}queryOnce(e,n){return this._reactor.queryOnce(e,n)}_syncTableExperimental(e,n){return this._reactor.subscribeTable(e,n)}}function Ln(t){if(!t)return"0";const e=Rn.get(t);if(e)return e;const n=U(t);return Rn.set(t,n),n}function wa(t,e){return Ln(t._reactor.config.schema)!==Ln(e)}function Ta(t,e,n,r,s){var i;const o=Object.assign(Object.assign({},t),{useDateObjects:(i=t.useDateObjects)!==null&&i!==void 0?i:!1}),a=Lt[Rt(o)];if(a)return wa(a,o.schema)&&a._reactor.updateSchema(o.schema),a;const c=new Zo(Object.assign(Object.assign(Object.assign({},ya),o),{cardinalityInference:!!o.schema}),e||mr,n||_r,Object.assign(Object.assign({},r||{}),{"@instantdb/core":Sr}),s),l=new ga(c);return Lt[Rt(o)]=l,Sa(o.appId,o.devtool),l}function Sa(t,e){if(typeof window>"u"||typeof window.location>"u"||typeof document>"u"||typeof e=="boolean"&&!e)return;const n=Object.assign({position:"bottom-right",allowedHosts:["localhost"]},typeof e=="object"?e:{});n.allowedHosts.includes(window.location.hostname)&&ca(t,n)}const Oa="35f3bfd9-6d1d-450a-978f-8cf9b3fecf5e",L="1180549903520518144",Un=1e3,Ea="nicetry",ka=I.schema({entities:{wallets:I.entity({leagueId:I.string().indexed(),sleeperUserId:I.string().indexed(),displayName:I.string(),balance:I.number(),startingBankroll:I.number(),pnl:I.number(),createdAt:I.date(),password:I.string().optional()}),bets:I.entity({leagueId:I.string().indexed(),sleeperUserId:I.string().indexed(),week:I.number(),stake:I.number(),combinedOdds:I.number(),type:I.string(),status:I.string(),legs:I.any(),createdAt:I.date(),payout:I.number().optional(),settledAt:I.date().optional()})}}),C=Ta({appId:Oa,schema:ka});let he=null,se=null,Ut=[],Mr=[],H={week:null,season:null,matchups:[],rostersById:{},usersById:{},projectionsByPlayer:{},projectionsByRoster:{},playersById:{}},ht=null,yt=null,vt=null,M=[],fe=[],rt="ALL",Pr={},bt=null,Ye=!1,mt=!1;function Aa(t){if(!t.length)return{};const e=t.map(c=>({rosterId:c.rosterId,score:Math.max(c.projPts||0,0)})),n=e.reduce((c,l)=>c+l.score,0)||1;let r=e.map(c=>({rosterId:c.rosterId,p:c.score/n}));const s=.08;r.forEach(c=>{c.p*=1-s});const i=r.reduce((c,l)=>c+l.p,0)||1;r.forEach(c=>{c.p/=i});const o=.5,a={};return r.forEach(({rosterId:c,p:l})=>{const u=Math.min(l,o);a[c]=+(1/u).toFixed(2)}),a}const _=t=>document.getElementById(t);function _e(t){return"$"+t.toFixed(2)}function O(t,e,n){t&&(t.textContent=e||"",t.classList.remove("error","success"),n&&t.classList.add(n))}function ne(t,e="info"){const n=_("toast-container");if(!n||!t)return;const r=document.createElement("div");r.className="toast",e==="success"?r.classList.add("toast-success"):e==="error"?r.classList.add("toast-error"):r.classList.add("toast-info");const s=document.createElement("i");s.className="toast-icon ph "+(e==="success"?"ph-check-circle":e==="error"?"ph-warning-circle":"ph-info");const i=document.createElement("span");i.className="toast-message",i.textContent=t,r.appendChild(s),r.appendChild(i),n.appendChild(r),setTimeout(()=>{r.classList.add("toast-hide"),setTimeout(()=>{r.remove()},200)},3e3)}function Nn(t,e){const n=_("password-modal"),r=_("password-modal-title"),s=_("password-modal-desc"),i=_("password-modal-input"),o=_("password-modal-confirm"),a=_("password-modal-cancel");if(!n||!r||!s||!i||!o||!a){const c=t==="create"?"Create a password for your Betbook account (min 4 characters):":"Enter your Betbook password:",l=window.prompt(c);return Promise.resolve(l===null?null:l)}return new Promise(c=>{i.value="",t==="create"?(r.textContent="Create Betbook password",s.textContent=`Set a password to protect your bankroll for ${e}.`):(r.textContent="Enter Betbook password",s.textContent=`Enter the password for ${e}.`),n.classList.add("open"),setTimeout(()=>i.focus(),0);const l=()=>{n.classList.remove("open"),i.value="",o.removeEventListener("click",u),a.removeEventListener("click",d),n.removeEventListener("click",f),i.removeEventListener("keydown",p)},u=()=>{const h=(i.value||"").trim();c(h),l()},d=()=>{c(null),l()},f=h=>{h.target===n&&d()},p=h=>{h.key==="Enter"?(h.preventDefault(),u()):h.key==="Escape"&&(h.preventDefault(),d())};o.addEventListener("click",u),a.addEventListener("click",d),n.addEventListener("click",f),i.addEventListener("keydown",p)})}async function G(t){const e=await fetch(t);if(!e.ok)throw new Error(`Request failed: ${e.status}`);return e.json()}let ve=null;async function Ca(){if(ve)return ve;const t=localStorage.getItem("sleeper_players_nfl_v1");if(t)try{return ve=JSON.parse(t),ve}catch{}const e=await G("https://api.sleeper.app/v1/players/nfl");ve=e;try{localStorage.setItem("sleeper_players_nfl_v1",JSON.stringify(e))}catch{}return ve}const Ia="https://api.sleeper.com/stats/nfl/player",Ve={};async function ja(t,e,n){var s;if(!e||!n||n<=1)return null;const r=`${e}-${t}`;if(Ve[r]!==void 0)return Ve[r];try{const i=`${Ia}/${t}?season_type=regular&season=${e}&grouping=week`,o=await G(i);let a=0,c=0;for(const[u,d]of Object.entries(o||{})){const f=Number(u);if(!Number.isFinite(f)||f>=n)continue;const p=(s=d==null?void 0:d.stats)==null?void 0:s.pts_ppr;p!=null&&(a+=Number(p),c++)}const l=c?a/c:null;return Ve[r]=l,l}catch(i){return console.error("fetchPlayerAveragePoints error",t,i),Ve[r]=null,null}}async function Ma(t){const e=H.season,n=H.week;!e||!n||n<=1||await Promise.all(t.map(async r=>{const s=await ja(r.playerId,e,n);s!=null&&(r.avgPts=s)}))}async function Pa(t,e){const s=`https://api.sleeper.app/projections/nfl/${t}/${e}`+"?season_type=regular&position[]=QB&position[]=RB&position[]=WR&position[]=TE&position[]=K&position[]=DEF&position[]=FLEX&position[]=REC_FLEX&order_by=ppr";return await G(s)}function $a(t){const e={};for(const n of t||[]){const r=n.player_id;if(!r)continue;const s=n.stats||{},i=Number(s.pts_ppr??s.pts_half_ppr??s.pts_std??0);e[r]=i}return e}function xa(t,e){const n={};for(const r of t||[]){const s=r.roster_id;if(!s)continue;const i=r.starters||[];let o=n[s]||0;for(const a of i){const c=e[a]??0;o+=c}n[s]=o}return n}function Da(t){if(!t.length)return{};const e=.6,n=.4,r=t.map(u=>{const d=u.projPts||0,f=u.avgPts!=null?u.avgPts:d,p=e*d+n*(f||0);return{playerId:u.playerId,score:Math.max(p,0)}}),s=r.reduce((u,d)=>u+d.score,0)||1;let i=r.map(u=>({playerId:u.playerId,p:u.score/s}));const o=.08;i.forEach(u=>{u.p*=1-o});const a=i.reduce((u,d)=>u+d.p,0)||1;i.forEach(u=>{u.p/=a});const c=.35,l={};return i.forEach(({playerId:u,p:d})=>{const f=Math.min(d,c);l[u]=+(1/f).toFixed(2)}),l}async function $r(t){const e=await G(`https://api.sleeper.app/v1/user/${t}`);return{id:e.user_id,username:e.username,displayName:e.display_name||e.username}}async function xr(){try{const t=await G("https://api.sleeper.app/v1/state/nfl"),e=t.week,n=t.season,[r,s,i,o]=await Promise.all([G(`https://api.sleeper.app/v1/league/${L}/users`),G(`https://api.sleeper.app/v1/league/${L}/rosters`),G(`https://api.sleeper.app/v1/league/${L}/matchups/${e}`),Pa(n,e)]),a={};r.forEach(d=>{a[d.user_id]=d});const c={};s.forEach(d=>{c[d.roster_id]=d});const l=$a(o),u=xa(i,l);H={...H,week:e,season:n,matchups:i,usersById:a,rostersById:c,projectionsByPlayer:l,projectionsByRoster:u},Qa(),_("week-number").textContent=String(e),_("bet-props-section").hidden=!1,await Ga(),Lr(),Dr()}catch(t){console.error("loadLeagueData failed",t);const e=_("matchups-note");throw e&&(e.textContent="Failed to load league/matchups from Sleeper. Check that SLEEPER_LEAGUE_ID is correct and projections endpoint is reachable. ("+(t.message||"unknown error")+")"),_("bet-props-section").hidden=!1,t}}async function Ra(){if(!(mt||Ye)&&he){mt=!0;try{await xr()}catch(t){console.error("Periodic league refresh failed",t);const e=_("matchups-note");e&&!e.textContent&&(e.textContent="Could not refresh projections from Sleeper (will retry later).")}finally{mt=!1}}}function La(t,e){const n=H.projectionsByRoster||{},r=n[t]??0,s=n[e]??0;if(!r&&!s)return{oddsA:2,oddsB:2};const i=r-s;let a=1/(1+Math.exp(-i/18)),c=1-a;const l=.05;a*=1-l/2,c*=1-l/2;const u=a+c;a/=u,c/=u;const d=.1,f=.9;a=Math.min(Math.max(a,d),f),c=Math.min(Math.max(c,d),f);const p=+(1/a).toFixed(2),h=+(1/c).toFixed(2);return{oddsA:p,oddsB:h}}async function Ua(t,e){var o;const n=await C.queryOnce({wallets:{$:{where:{leagueId:L,sleeperUserId:t}}}});if(n.error)throw console.error(n.error),new Error("Error querying wallets");const r=(o=n.data.wallets)==null?void 0:o[0];if(r)return r;const s=$();return await C.transact(C.tx.wallets[s].update({leagueId:L,sleeperUserId:t,displayName:e,balance:Un,startingBankroll:Un,pnl:0,createdAt:Date.now()})),(await C.queryOnce({wallets:{$:{where:{leagueId:L,sleeperUserId:t}}}})).data.wallets[0]}function Na(t){ht&&ht(),ht=C.subscribeQuery({wallets:{$:{where:{leagueId:L,sleeperUserId:t}}},bets:{$:{where:{leagueId:L,sleeperUserId:t},order:{serverCreatedAt:"desc"}}}},e=>{if(e.error){console.error(e.error);return}const n=e.data||{};se=n.wallets&&n.wallets[0]||null,Ut=n.bets||[],Wa(),Va()})}function Fa(){yt&&yt(),yt=C.subscribeQuery({wallets:{$:{where:{leagueId:L}}}},t=>{if(t.error){console.error(t.error);return}Mr=t.data.wallets||[],Ha()})}function Xt(t){const e=new Map;for(const n of t){const r=n.matchup_id??n.roster_id;e.has(r)||e.set(r,[]),e.get(r).push(n)}return e}function qa(t){const e=new Map;for(const s of t||[]){const i=s.players_points||{};for(const[o,a]of Object.entries(i)){const c=e.get(o)||0;e.set(o,c+(a??0))}}let n=null,r=-1/0;for(const[s,i]of e.entries())i>r&&(r=i,n=s);return n}function Ka(t){const e=new Map;for(const s of t||[]){const i=s.roster_id;if(!i)continue;const o=s.points??0;e.set(i,(e.get(i)||0)+o)}let n=null,r=-1/0;for(const[s,i]of e.entries())i>r&&(r=i,n=s);return n}async function Dr(){let t;try{t=await G("https://api.sleeper.app/v1/state/nfl")}catch(a){console.error("Error fetching Sleeper state for settlement",a);return}const e=Number(t.week);if(!Number.isFinite(e)||e<=0)return;const n=await C.queryOnce({bets:{$:{where:{leagueId:L,status:"open"}}},wallets:{$:{where:{leagueId:L}}}});if(n.error){console.error("Error querying for settlement",n.error);return}const r=n.data.bets||[];if(!r.length)return;const s=new Map;for(const a of r){const c=Number(a.week);Number.isFinite(c)&&(c>=e||(s.has(c)||s.set(c,[]),s.get(c).push(a)))}if(!s.size)return;const i={};(n.data.wallets||[]).forEach(a=>{i[a.sleeperUserId]=a});const o=[];for(const[a,c]of s.entries()){let l;try{l=await G(`https://api.sleeper.app/v1/league/${L}/matchups/${a}`)}catch(p){console.error("Error fetching matchups for settlement week",a,p);continue}const u=Xt(l),d=qa(l),f=Ka(l);for(const p of c){const h=p.legs||[];let y=!0;for(const m of h)if(m.type==="match_winner"){const w=u.get(m.data.matchupId)||[];if(w.length<2){y=null;break}const[T,g]=w;if(((T.points??0)>=(g.points??0)?T.roster_id:g.roster_id)!==m.data.winnerRosterId){y=!1;break}}else if(m.type==="player_top_points"){if(!d){y=null;break}if(d!==m.data.playerId){y=!1;break}}else if(m.type==="team_top_points"){if(!f){y=null;break}if(f!==m.data.rosterId){y=!1;break}}else{y=null;break}if(y===null)continue;const v=Date.now(),b=i[p.sleeperUserId];if(b)if(y){const m=p.stake*p.combinedOdds;o.push(C.tx.bets[p.id].update({status:"won",payout:m,settledAt:v})),o.push(C.tx.wallets[b.id].update({balance:b.balance+m,pnl:(b.pnl||0)+(m-p.stake)})),b.balance+=m,b.pnl=(b.pnl||0)+(m-p.stake)}else o.push(C.tx.bets[p.id].update({status:"lost",payout:0,settledAt:v})),o.push(C.tx.wallets[b.id].update({pnl:(b.pnl||0)-p.stake})),b.pnl=(b.pnl||0)-p.stake}}o.length&&await C.transact(o)}function Nt(){const t=_("betslip-summary");if(!M.length){t.textContent="No legs selected";return}const e=M.reduce((s,i)=>s*(i.odds??1),1),r=Number(_("betslip-stake").value||"0")*e;t.textContent=`Parlay with ${M.length} leg(s)  combined odds ${e.toFixed(2)}  potential return ${_e(r||0)}`}function Ee(){const t=_("betslip-legs");if(t.innerHTML="",t.classList.toggle("empty",M.length===0),!M.length){t.innerHTML="<p>No selections yet. Tap odds below to add legs to your slip.</p>",Nt();return}M.forEach((e,n)=>{const r=document.createElement("div");r.className="betslip-leg";let s="",i="";e.type==="match_winner"?(s=e.data.ownerName||"Team",i="Win"):e.type==="team_top_points"?(s=e.data.ownerName||"Team",i="Top Scoring Team"):e.type==="player_top_points"?(s=e.data.playerName||"Player",i="Top Scorer"):(s="Selection",i="");const o=document.createElement("span");o.textContent=i?`${s} | ${i}`:`${s}`;const a=document.createElement("span");a.textContent=`@ ${e.odds.toFixed(2)}`;const c=document.createElement("span");c.appendChild(o),c.append(" "),c.appendChild(a);const l=document.createElement("button");l.type="button",l.className="betslip-leg-remove",l.textContent="Remove",l.addEventListener("click",()=>{M.splice(n,1),Ee()}),r.appendChild(c),r.appendChild(l),t.appendChild(r)}),Nt()}function Fn(t,e,n,r,s){if(M.some(a=>a.type==="match_winner"&&a.data.matchupId===t&&a.data.winnerRosterId===e))return;const o=M.findIndex(a=>a.type==="match_winner"&&a.data.matchupId===t&&a.data.winnerRosterId!==e);o!==-1&&M.splice(o,1),M.push({type:"match_winner",description:`${r} | Win`,data:{matchupId:t,winnerRosterId:e,ownerName:r,teamLabel:n},odds:s}),Ee()}function Ba(t,e,n){M.some(s=>s.type==="team_top_points"&&s.data.rosterId===t)||(M.push({type:"team_top_points",description:`${e} | Top Scoring Team`,data:{rosterId:t,ownerName:e},odds:n}),Ee())}function za(t,e,n){M.some(s=>s.type==="player_top_points"&&s.data.playerId===t)||(M.push({type:"player_top_points",description:`${e} | Top Scorer`,data:{playerId:t,playerName:e},odds:n}),Ee())}function Wa(){if(!he||!se)return;_("wallet-and-slip").hidden=!1,_("wallet-balance").textContent=_e(se.balance||0);const t=_("wallet-pnl"),e=se.pnl||0;t.textContent=(e>=0?"+":"")+e.toFixed(2),t.classList.toggle("pnl-positive",e>0),t.classList.toggle("pnl-negative",e<0)}function Va(){const t=_("user-bets-list");if(!he){_("bets-section").hidden=!0;return}if(_("bets-section").hidden=!1,t.innerHTML="",!Ut.length){const e=document.createElement("li");e.textContent="No bets yet. Build a slip and place your first bet!",e.className="small-muted",t.appendChild(e);return}Ut.forEach(e=>{const n=document.createElement("li");n.className="bet-item";const r=document.createElement("div");r.className="bet-header";const s=document.createElement("span");s.textContent=`Week ${e.week}  ${e.type}`;const i=document.createElement("span");i.className="bet-status "+e.status,i.textContent=e.status.toUpperCase(),r.appendChild(s),r.appendChild(i);const o=document.createElement("div");o.textContent=`${_e(e.stake)} @ ${e.combinedOdds.toFixed(2)}`;const a=document.createElement("ul");a.className="bet-legs",(e.legs||[]).forEach(l=>{const u=document.createElement("li");u.textContent=l.description,a.appendChild(u)});const c=document.createElement("div");c.className="small-muted",e.status==="won"?c.textContent=`Payout: ${_e(e.payout||0)}`:e.status==="lost"?c.textContent=`Lost stake: ${_e(e.stake)}`:c.textContent="Open  will auto-settle after the week ends.",n.appendChild(r),n.appendChild(o),n.appendChild(a),n.appendChild(c),t.appendChild(n)})}function Ha(){const t=_("leaderboard-body");t.innerHTML="",_("leaderboard-section").hidden=!1,[...Mr].sort((n,r)=>(r.balance||0)-(n.balance||0)).forEach((n,r)=>{const s=document.createElement("tr"),i=document.createElement("td");i.textContent=String(r+1);const o=document.createElement("td");o.textContent=n.displayName||"Unknown";const a=document.createElement("td");a.textContent=_e(n.balance||0);const c=document.createElement("td"),l=n.pnl||0;c.textContent=(l>=0?"+":"")+l.toFixed(2),s.appendChild(i),s.appendChild(o),s.appendChild(a),s.appendChild(c),t.appendChild(s)})}function Qa(){const t=_("matchups-list");t.innerHTML="";const{matchups:e,rostersById:n,usersById:r,projectionsByRoster:s}=H;if(!(e!=null&&e.length)){t.innerHTML="<p>No matchups found for this week.</p>";return}const i=Xt(e);for(const[o,a]of i.entries()){if(a.length<2)continue;const[c,l]=a,u=n[c.roster_id],d=n[l.roster_id];if(!u||!d)continue;const f=r[u.owner_id],p=r[d.owner_id],h=(f==null?void 0:f.display_name)||(f==null?void 0:f.username)||"Unknown",y=(p==null?void 0:p.display_name)||(p==null?void 0:p.username)||"Unknown",{oddsA:v,oddsB:b}=La(c.roster_id,l.roster_id),m=(s==null?void 0:s[c.roster_id])??0,w=(s==null?void 0:s[l.roster_id])??0,T=document.createElement("div");T.className="matchup-card";const g=document.createElement("div");g.className="matchup-title",g.textContent=`${h} vs ${y}`,T.appendChild(g);const E=document.createElement("div");E.className="matchup-row";const k=document.createElement("button");k.type="button",k.className="matchup-side";const x=document.createElement("span");x.className="matchup-user-pill",x.textContent=h;const ue=document.createElement("span");ue.className="matchup-odds-pill",ue.textContent=`Odds: ${v.toFixed(2)}`;const ke=document.createElement("span");ke.className="matchup-proj-pill",ke.textContent=`Proj: ${m.toFixed(1)} pts`,k.appendChild(x),k.appendChild(ue),k.appendChild(ke),k.addEventListener("click",()=>{Fn(o,c.roster_id,h,h,v)});const ee=document.createElement("button");ee.type="button",ee.className="matchup-side";const Ae=document.createElement("span");Ae.className="matchup-user-pill",Ae.textContent=y;const Ce=document.createElement("span");Ce.className="matchup-odds-pill",Ce.textContent=`Odds: ${b.toFixed(2)}`;const Ie=document.createElement("span");Ie.className="matchup-proj-pill",Ie.textContent=`Proj: ${w.toFixed(1)} pts`,ee.appendChild(Ae),ee.appendChild(Ce),ee.appendChild(Ie),ee.addEventListener("click",()=>{Fn(o,l.roster_id,y,y,b)}),E.appendChild(k),E.appendChild(ee),T.appendChild(E),t.appendChild(T)}}async function Ga(){var a;const t=_("bet-props-section"),e=_("player-props-list");if(e.innerHTML="",t.hidden=!0,!((a=H.matchups)!=null&&a.length))return;let n;try{n=await Ca()}catch(c){console.error("Failed to load players",c),e.innerHTML="<p class='small-muted'>Could not load player list for props.</p>",t.hidden=!1;return}const r=H.projectionsByPlayer||{},s=new Set;for(const c of H.matchups)(c.starters||[]).forEach(l=>s.add(l));const i=new Set(["QB","RB","WR","TE"]),o=[];if(s.forEach(c=>{const l=n[c];if(!l)return;const u=l.position||"";if(!i.has(u))return;const d=r[c]??0;if(!d)return;const f=`${l.first_name??""} ${l.last_name??""}`.trim()||l.full_name||"Unknown",p=l.team||"";o.push({playerId:c,name:f,position:u,team:p,projPts:d})}),fe=o,!fe.length){e.innerHTML="<p class='small-muted'>No starter projections available for player props.</p>",t.hidden=!1;return}await Ma(fe),Pr=Da(fe),rt="ALL",document.querySelectorAll(".prop-pos-pill").forEach(c=>c.classList.toggle("active",c.dataset.pos==="ALL")),Rr(),t.hidden=!1}function Rr(){const t=_("player-props-list");if(t.innerHTML="",!fe.length){t.innerHTML="<p class='small-muted'>No starter projections available for player props.</p>";return}let e=fe;if(rt!=="ALL"&&(e=fe.filter(n=>n.position===rt)),!e.length){t.innerHTML="<p class='small-muted'>No starters for this position.</p>";return}e.sort((n,r)=>r.projPts-n.projPts),e.forEach(n=>{const r=document.createElement("div");r.className="prop-card";const s=document.createElement("div");s.className="prop-main";const i=document.createElement("span");i.className="prop-name",i.textContent=n.name;const o=document.createElement("span");o.className="prop-meta";const a=n.avgPts!=null?`  Avg: ${n.avgPts.toFixed(1)} pts`:"";o.textContent=`Proj: ${n.projPts.toFixed(1)} pts${a}`,s.appendChild(i),s.appendChild(o);const c=document.createElement("div");c.className="prop-right";const l=document.createElement("span");l.className="prop-odds-pill";const u=Pr[n.playerId]??5;l.textContent=`Odds: ${u.toFixed(2)}`;const d=document.createElement("button");d.type="button",d.className="prop-add-btn",d.textContent="Add",d.addEventListener("click",()=>{za(n.playerId,n.name,u)}),c.appendChild(l),c.appendChild(d),r.appendChild(s),r.appendChild(c),t.appendChild(r)})}function Lr(){const t=_("team-props-list");if(!t)return;t.innerHTML="";const{matchups:e,rostersById:n,usersById:r,projectionsByRoster:s}=H;if(!(e!=null&&e.length)){t.innerHTML="<p class='small-muted'>No matchups loaded for this week.</p>";return}const i=Xt(e),o=[];for(const[u,d]of i.entries())if(!(!u||d.length<2))for(const f of d){const p=f.roster_id;if(!p)continue;const h=n[p];if(!h)continue;const y=(s==null?void 0:s[p])??0;if(!y)continue;const v=r[h.owner_id],b=(v==null?void 0:v.display_name)||(v==null?void 0:v.username)||"Unknown";o.push({rosterId:p,ownerName:b,projPts:y})}const a=new Set,c=[];for(const u of o)a.has(u.rosterId)||(a.add(u.rosterId),c.push(u));if(!c.length){t.innerHTML="<p class='small-muted'>No teams with active matchups for this week.</p>";return}c.sort((u,d)=>d.projPts-u.projPts);const l=Aa(c);c.forEach(u=>{const d=document.createElement("div");d.className="prop-card";const f=document.createElement("div");f.className="prop-main";const p=document.createElement("span");p.className="prop-name",p.textContent=u.ownerName;const h=document.createElement("span");h.className="prop-meta",h.textContent=`Proj: ${u.projPts.toFixed(1)} pts`,f.appendChild(p),f.appendChild(h);const y=document.createElement("div");y.className="prop-right";const v=document.createElement("span");v.className="prop-odds-pill";const b=l[u.rosterId]??5;v.textContent=`Odds: ${b.toFixed(2)}`;const m=document.createElement("button");m.type="button",m.className="prop-add-btn",m.textContent="Add",m.addEventListener("click",()=>{Ba(u.rosterId,u.ownerName,b)}),y.appendChild(v),y.appendChild(m),d.appendChild(f),d.appendChild(y),t.appendChild(d)})}async function Ja(){const t=_("betslip-error");if(O(t,""),!Ye){Ye=!0;try{if(!he||!se){const c="You must be logged in and have a wallet.";O(t,c,"error"),ne(c,"error");return}if(!M.length){const c="Your bet slip is empty.";O(t,c,"error"),ne(c,"error");return}const e=Number(_("betslip-stake").value||"0");if(!e||e<=0){const c="Stake must be > 0.";O(t,c,"error"),ne(c,"error");return}if(e>se.balance){const c="Insufficient balance.";O(t),ne(c,"error");return}const n=M.reduce((c,l)=>c*(l.odds??1),1),r=M.length===1?M[0].type:"parlay",s=H.week;if(!s){const c="Week not loaded yet.";O(t,c,"error"),ne(c,"error");return}const i=$(),o=se.id,a=se.balance-e;await C.transact([C.tx.wallets[o].update({balance:a}),C.tx.bets[i].update({leagueId:L,sleeperUserId:he.id,week:s,stake:e,combinedOdds:n,type:r,status:"open",legs:M,createdAt:Date.now()})]),M=[],Ee(),O(t,""),ne("Bet placed!","success")}finally{Ye=!1}}}async function Ya(){const t=_("admin-secret").value,e=_("admin-reset-status");if(O(e,""),t!==Ea){O(e,"Wrong secret.","error");return}const n=await C.queryOnce({wallets:{$:{where:{leagueId:L}}},bets:{$:{where:{leagueId:L}}}});if(n.error){console.error("adminReset query error",n.error),O(e,"Error querying DB.","error");return}const r=n.data.wallets||[],s=n.data.bets||[],i=[];r.forEach(o=>{i.push(C.tx.wallets[o.id].delete())}),s.forEach(o=>{i.push(C.tx.bets[o.id].delete())}),i.length&&await C.transact(i),O(e,"League reset!","success")}async function Za(){var r;const t=_("admin-reset-user"),e=_("admin-reset-user-status");O(e,"");const n=(t.value||"").trim();if(!n){O(e,"Enter a Sleeper username.","error");return}try{const s=await $r(n),i=await C.queryOnce({wallets:{$:{where:{leagueId:L,sleeperUserId:s.id}}}});if(i.error){console.error("adminClearUserPassword query error",i.error),O(e,"Error querying DB.","error");return}const o=(r=i.data.wallets)==null?void 0:r[0];if(!o){O(e,"No wallet found for that user.","error");return}await C.transact(C.tx.wallets[o.id].update({password:null})),O(e,"Password cleared. User will be asked to create a new one on next login.","success")}catch(s){console.error("adminClearUserPassword error",s),O(e,"Error clearing password (check the Sleeper username).","error")}}async function qn(){const t=_("sleeper-username"),e=_("login-btn"),n=_("login-status"),r=_("login-user-pill");O(n,""),_("wallet-and-slip").hidden=!0,_("bets-section").hidden=!0,_("admin-section").hidden=!0,r&&(r.hidden=!0);const s=(t.value||"").trim();if(!s){O(n,"Please enter your Sleeper username.","error");return}e.disabled=!0,O(n,"Looking up Sleeper user");try{const i=await $r(s);let o;try{o=await G(`https://api.sleeper.app/v1/league/${L}/users`)}catch(u){console.error("Failed loading league users for membership check",u),O(n,"Could not verify league membership. Please try again.","error"),e.disabled=!1;return}if(!o.some(u=>u.user_id===i.id)){O(n,"That Sleeper account is not a member of this league.","error"),e.disabled=!1;return}const c={};o.forEach(u=>{c[u.user_id]=u}),H.usersById=c,he=i;let l=await Ua(i.id,i.displayName);if(l.password){const u=await Nn("enter",i.username);if(u===null){O(n,"Login cancelled.","error"),e.disabled=!1;return}if(u!==l.password){O(n,"Incorrect password for this account.","error"),e.disabled=!1;return}}else{const u=await Nn("create",i.username);if(u===null||u===""){O(n,"Login cancelled before setting a password.","error"),e.disabled=!1;return}if(u.length<4){O(n,"Password must be at least 4 characters.","error"),e.disabled=!1;return}await C.transact(C.tx.wallets[l.id].update({password:u})),l.password=u,ne("Password created for your Betbook account.","success")}if(se=l,O(n,`Connected as ${i.displayName} (${i.username}).`,"success"),localStorage.setItem("betbook-user",JSON.stringify({id:i.id,username:i.username,displayName:i.displayName})),Na(i.id),Fa(),_("wallet-and-slip").hidden=!1,_("bets-section").hidden=!1,i.username==="kingsaled"?_("admin-section").hidden=!1:_("admin-section").hidden=!0,r){const u=_("login-user-pill-name");u&&(u.textContent=i.username),r.hidden=!1}try{O(n,"Connected. Loading league & matchups"),await xr(),bt&&clearInterval(bt),bt=setInterval(Ra,5*6e4),vt&&clearInterval(vt),vt=setInterval(Dr,6e4),O(n,""),ne("All set! League data loaded.","success")}catch(u){console.error("loadLeagueData error:",u),O(n,"Connected to Sleeper, but failed to load league/matchups: "+(u.message||"unknown error"),"error")}}catch(i){console.error("Sleeper username lookup / wallet error:",i),O(n,"Error connecting to Sleeper user. Double-check your username.","error"),_("admin-section").hidden=!0}finally{e.disabled=!1}}function _t(t){["matchups","top-player","top-team"].forEach(n=>{const r=_(n==="matchups"?"prop-tab-matchups":n==="top-player"?"prop-tab-top-player":"prop-tab-top-team"),s=_(n==="matchups"?"prop-mode-matchups":n==="top-player"?"prop-mode-top-player":"prop-mode-top-team");r&&r.classList.toggle("active",n===t),s&&s.classList.toggle("active",n===t)})}function Xa(){var r;_("login-btn").addEventListener("click",qn),_("sleeper-username").addEventListener("keydown",s=>{s.key==="Enter"&&(s.preventDefault(),qn())}),_("betslip-stake").addEventListener("input",()=>{Nt()}),_("place-bet-btn").addEventListener("click",Ja),_("admin-reset-btn").addEventListener("click",Ya),(r=_("admin-reset-user-btn"))==null||r.addEventListener("click",Za),document.querySelectorAll(".prop-pos-pill").forEach(s=>{s.addEventListener("click",()=>{rt=s.dataset.pos||"ALL",document.querySelectorAll(".prop-pos-pill").forEach(o=>o.classList.toggle("active",o===s)),Rr()})});const t=_("prop-tab-matchups"),e=_("prop-tab-top-player"),n=_("prop-tab-top-team");t==null||t.addEventListener("click",()=>_t("matchups")),e==null||e.addEventListener("click",()=>_t("top-player")),n==null||n.addEventListener("click",()=>{_t("top-team"),Lr()})}function ec(){const t=localStorage.getItem("betbook-user");if(t)try{const e=JSON.parse(t);e&&e.id&&(he=e,_("sleeper-username").value=e.username||"",ne(`Restored session as ${e.displayName} (${e.username}). Click "Connect" to sync.`,"info"))}catch{}}function tc(){Xa(),Ee(),ec()}tc();
